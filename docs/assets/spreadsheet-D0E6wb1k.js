(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class rt extends Error{constructor({errorMessage:t,rowIndex:e,colKey:i,value:s,schema:n,errorType:o}){super(t),this.rowIndex=e,this.colKey=i,this.value=s,this.schema=n,this.errorType=o}}const xt={defaultColumnWidth:150,defaultRowHeight:30,minColumnWidth:50,maxColumnWidth:500,minRowHeight:20,maxRowHeight:150,headerHeight:35,rowNumberWidth:50,font:"14px Inter, sans-serif",headerFont:"bold 14px Inter, sans-serif",padding:5,textAlign:"left",textColor:"#111827",placeholderTextColor:"#9ca3af",loadingTextColor:"#3b82f6",errorTextColor:"#b91c1c",cellBgColor:"#ffffff",activeCellBgColor:"#eff6ff",errorCellBgColor:"#fca5a5",selectedRowBgColor:"#f3f4f6",selectedRangeBgColor:"#e0e7ff",headerTextColor:"#ffffff",selectedHeaderTextColor:"#000000",headerBgColor:"#4b5563",customHeaderBgColor:"#9ca3af",selectedHeaderBgColor:"#dbeafe",resizeHeaderBgColor:"#d3e6ff9e",resizeHeaderBgAlphaBlend:"lighter",readonlyHeaderBgColor:"#f3f4f6",readonlyHeaderTextColor:"#9ca3af",headerClipText:!0,headerTextAlign:"center",gridLineColor:"#d1d5db",rowNumberBgColor:"#f3f4f6",selectedRowNumberBgColor:"#dbeafe",resizeRowBgColor:"#dbeafe9e",resizeRowBgAlphaBlend:"multiply",disabledCellBgColor:"#e5e7eb",disabledCellTextColor:"#9ca3af",highlightBorderColor:"#3b82f6",fillHandleColor:"#3b82f6",fillHandleSize:10,dragRangeBorderColor:"#6b7280",copyHighlightBorderColor:"#1f2937",copyHighlightBorderDash:[4,3],resizeHandleSize:5,resizeDividerColor:"#3b82f6",temporaryErrorTimeout:2e3,customDatePicker:!1,autoAddNewRow:!0,autoResizeRowHeight:!1,lazySearchDebounceTime:300,blankDropdownItemLabel:"(Blank)",allowTabInTextarea:!1,wrapText:!1,lineHeight:16,verbose:!1,onCellsUpdate:null,onCellSelected:null,onEditorOpen:null,onRowDeleted:null,onColumnDelete:null,onColumnDeleted:null,onLazySearch:null,onCellContextMenu:null,onRowNumberContextMenu:null,onColumnHeaderContextMenu:null,onEditorOpened:null,onEditorClosed:null,onColumnWidthsChange:null},ot="disabled:",J="loading:",D="error:";class Rt{constructor(t){this.systemScrollbarWidth=0,this.dropdownMultiSelect=!1,this.container=t,this.container.style.position="relative",this.container.tabIndex=-1,this.systemScrollbarWidth=this.getSystemScrollbarWidth()+1,this.canvas=document.createElement("canvas");const e=this.canvas.getContext("2d");if(!e)throw new Error("Failed to get 2D context from canvas");this.ctx=e,this.container.appendChild(this.canvas),this.hScrollbar=document.createElement("div"),this.hScrollbar.id="spreadsheet-hscrollbar",this.hScrollbar.style.position="absolute",this.hScrollbar.style.bottom="0",this.hScrollbar.style.overflow="auto",this.container.appendChild(this.hScrollbar),this.vScrollbar=document.createElement("div"),this.vScrollbar.id="spreadsheet-vscrollbar",this.vScrollbar.style.position="absolute",this.vScrollbar.style.right="0",this.vScrollbar.style.width=`${this.systemScrollbarWidth}px`,this.vScrollbar.style.overflow="auto",this.container.appendChild(this.vScrollbar),this.editorInput=document.createElement("input"),this.editorInput.className="spreadsheet-editor",this.editorInput.style.position="absolute",this.editorInput.style.display="none",this.editorInput.style.boxSizing="border-box",this.container.appendChild(this.editorInput),this.editorTextarea=document.createElement("textarea"),this.editorTextarea.className="spreadsheet-editor spreadsheet-editor-textarea",this.editorTextarea.style.position="absolute",this.editorTextarea.style.display="none",this.editorTextarea.style.boxSizing="border-box",this.editorTextarea.style.overflow="auto",this.container.appendChild(this.editorTextarea),this.dropdown=document.createElement("div"),this.dropdown.className="spreadsheet-dropdown",this.dropdown.style.position="absolute",this.dropdown.style.display="none",this.dropdown.style.zIndex="100",this.dropdown.style.border="1px solid #ccc",this.dropdown.style.backgroundColor="white",this.dropdown.style.boxShadow="0 2px 5px rgba(0,0,0,0.15)",this.dropdown.style.minHeight="100px",this.dropdown.style.height="200px",this.dropdown.style.display="flex",this.dropdown.style.flexDirection="column";const i=document.createElement("div");i.className="spreadsheet-dropdown-search",i.style.padding="5px",i.style.borderBottom="1px solid #eee",i.style.flexShrink="0",this.dropdownSearchInput=document.createElement("input"),this.dropdownSearchInput.type="text",this.dropdownSearchInput.placeholder="Search...",this.dropdownSearchInput.style.width="100%",this.dropdownSearchInput.style.boxSizing="border-box",this.dropdownSearchInput.style.padding="4px",i.appendChild(this.dropdownSearchInput);const s=document.createElement("div");s.className="spreadsheet-dropdown-list-wrapper",s.style.flex="1",s.style.overflow="auto",s.style.position="relative",this.dropdownLoader=document.createElement("div"),this.dropdownLoader.className="spreadsheet-dropdown-loader",this.dropdownLoader.style.display="flex",this.dropdownLoader.style.justifyContent="center",this.dropdownLoader.style.alignItems="center",this.dropdownLoader.style.position="absolute",this.dropdownLoader.style.top="0",this.dropdownLoader.style.left="0",this.dropdownLoader.style.right="0",this.dropdownLoader.style.bottom="0",this.dropdownLoader.style.backgroundColor="rgba(255, 255, 255, 0.85)",this.dropdownLoader.style.zIndex="10",this.dropdownLoader.style.visibility="hidden",this.dropdownLoader.innerHTML=`
            <svg width="32" height="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .spinner {
                        animation: spin 1.5s linear infinite;
                        transform-origin: center;
                    }
                </style>
                <circle class="spinner" cx="12" cy="12" r="10" fill="none" stroke="#2563eb" stroke-width="2.5" stroke-dasharray="40 60" />
            </svg>
        `,this.dropdownList=document.createElement("ul"),this.dropdownList.className="spreadsheet-dropdown-list",this.dropdownList.style.listStyle="none",this.dropdownList.style.margin="0",this.dropdownList.style.padding="0",s.appendChild(this.dropdownList),s.appendChild(this.dropdownLoader),this.dropdownFooter=document.createElement("div"),this.dropdownFooter.className="spreadsheet-dropdown-footer",this.dropdownFooter.style.padding="8px",this.dropdownFooter.style.borderTop="1px solid #eee",this.dropdownFooter.style.display="block",this.dropdownFooter.style.flexShrink="0",this.dropdownFooter.style.backgroundColor="#f9f9f9";const n=document.createElement("div");n.className="spreadsheet-dropdown-button-wrapper",n.style.display="flex",n.style.justifyContent="space-between",this.dropdownDoneButton=document.createElement("button"),this.dropdownDoneButton.textContent="Done",this.dropdownDoneButton.style.padding="6px 12px",this.dropdownDoneButton.style.backgroundColor="#2563eb",this.dropdownDoneButton.style.color="white",this.dropdownDoneButton.style.border="none",this.dropdownDoneButton.style.borderRadius="4px",this.dropdownDoneButton.style.cursor="pointer",this.dropdownDoneButton.style.fontSize="14px",this.dropdownDoneButton.addEventListener("mouseover",()=>{this.dropdownDoneButton.style.backgroundColor="#1d4ed8"}),this.dropdownDoneButton.addEventListener("mouseout",()=>{this.dropdownDoneButton.style.backgroundColor="#2563eb"}),this.dropdownClearButton=document.createElement("button"),this.dropdownClearButton.textContent="Clear",this.dropdownClearButton.style.padding="6px 12px",this.dropdownClearButton.style.backgroundColor="#dbdbdb",this.dropdownClearButton.style.color="#020202b3",this.dropdownClearButton.style.border="none",this.dropdownClearButton.style.borderRadius="4px",this.dropdownClearButton.style.cursor="pointer",this.dropdownClearButton.style.fontSize="14px",n.appendChild(this.dropdownClearButton),n.appendChild(this.dropdownDoneButton),this.dropdownFooter.appendChild(n),this.dropdownWrapper=document.createElement("div"),this.dropdownWrapper.className="canvas-sheet-dropdown-wrapper",document.body.appendChild(this.dropdownWrapper),this.dropdown.appendChild(i),this.dropdown.appendChild(s),this.dropdown.appendChild(this.dropdownFooter),this.dropdownWrapper.appendChild(this.dropdown)}toggleDropdownLoader(t){this.dropdownLoader.style.visibility=t?"visible":"hidden"}checkEventBoundInDropdown(t){return this.dropdown.contains(t.target)}getSystemScrollbarWidth(){var s;if(this.systemScrollbarWidth)return this.systemScrollbarWidth;const t=document.createElement("div");t.style.visibility="hidden",t.style.overflow="scroll",document.body.appendChild(t);const e=document.createElement("div");t.appendChild(e);const i=t.offsetWidth-t.clientWidth;return(s=t.parentNode)==null||s.removeChild(t),i}updateScrollbarPositions(t,e){this.hScrollbar.style.left=`${e}px`,this.hScrollbar.style.width=`calc(100% - ${e}px - ${this.systemScrollbarWidth}px)`,this.vScrollbar.style.top=`${t}px`,this.vScrollbar.style.height=`calc(100% - ${t}px - ${this.systemScrollbarWidth}px)`}setup(t,e,i=0,s=0){this.updateCanvasSize(t,e),this.updateScrollbarPositions(i,s)}updateCanvasSize(t,e){this.container.setAttribute("data-width",`${t}`),this.container.setAttribute("data-height",`${e}`),this.hScrollbar.innerHTML=`<div class="placeholder" style="width: ${t}px; height: 1px;"></div>`,this.vScrollbar.innerHTML=`<div class="placeholder" style="width: 1px; height: ${e}px;"></div>`;const i=this.container.clientWidth-this.systemScrollbarWidth,s=this.container.clientHeight-this.systemScrollbarWidth;this.canvas.width=i,this.canvas.height=s,this.canvas.style.width=`${i}px`,this.canvas.style.height=`${s}px`}isDropdownMultiSelect(){return this.dropdownMultiSelect}setDropdownMultiSelect(t){this.dropdownMultiSelect=t}getHScrollbar(){return this.hScrollbar}getVScrollbar(){return this.vScrollbar}getHScrollPosition(){return this.hScrollbar.scrollLeft}setHScrollPosition(t){return this.hScrollbar.scrollLeft=t,this.hScrollbar.scrollLeft}getVScrollPosition(){return this.vScrollbar.scrollTop}setVScrollPosition(t){return this.vScrollbar.scrollTop=t,this.vScrollbar.scrollTop}canVScrollUp(){return this.vScrollbar.scrollTop>0}canVScrollDown(){return this.vScrollbar.scrollTop+this.vScrollbar.clientHeight<this.vScrollbar.scrollHeight}canHScrollRight(){return this.hScrollbar.scrollLeft+this.hScrollbar.clientWidth<this.hScrollbar.scrollWidth}canHScrollLeft(){return this.hScrollbar.scrollLeft>0}getCanvas(){return this.canvas}getContext(){return this.ctx}getEditorInput(){return this.editorInput}getEditorTextarea(){return this.editorTextarea}getDropdownElements(){return{dropdown:this.dropdown,searchInput:this.dropdownSearchInput,loader:this.dropdownLoader,list:this.dropdownList,footer:this.dropdownFooter,doneButton:this.dropdownDoneButton,clearButton:this.dropdownClearButton}}focusContainer(t=!0){this.container.focus({preventScroll:t})}setCursor(t){this.canvas.style.cursor=t}getCanvasBoundingClientRect(){return this.canvas.getBoundingClientRect()}}function m(y,t,...e){!t&&y!=="error"||console[y](...e)}function mt(y,t,e){if(y==null)return"";switch(t){case"date":try{const i=String(y),s=y instanceof Date?y:new Date(i.includes("T")?i:i+"T00:00:00Z");if(!isNaN(s.getTime()))return s.toLocaleDateString(void 0,{timeZone:"UTC"})}catch(i){m("warn",!1,"Error formatting date value:",y,i)}return String(y);case"boolean":return y===!0?"True":y===!1?"False":"";case"select":if(e){if(Array.isArray(y))return y.length===0?"":y.map(s=>e.get(s)||"").join(", ");const i=e.get(y);return i||""}return"";case"number":return String(y);case"text":case"email":default:return String(y)}}function Dt(y,t){if(y==null)return"";if(t==="date"){try{const e=String(y),i=y instanceof Date?y:new Date(e.includes("T")?e:e+"T00:00:00Z");if(!isNaN(i.getTime())){const s=i.getUTCFullYear(),n=(i.getUTCMonth()+1).toString().padStart(2,"0"),o=i.getUTCDate().toString().padStart(2,"0");return`${s}-${n}-${o}`}}catch(e){m("warn",!1,"Error formatting date for input:",y,e)}return""}return String(y)}function Tt(y,t){if(y==="")return null;switch(t){case"number":const e=parseFloat(y);return isNaN(e)?null:e;case"boolean":return y.toLowerCase()==="true";case"date":return y;case"text":case"email":default:return y}}function wt(y){return y==null?"":typeof y=="string"?y.toLowerCase():Array.isArray(y)?[...y].sort().join("|"):String(y)}function N(y,t,e,i,s,n,o){if(!t)return{success:!0};const r=t.label||e;if(t.required&&(y==null||y===""||Array.isArray(y)&&y.length===0)){const a=`Column "${r}" is required.`;return m("warn",s,`Validation failed: ${a}.`),{success:!1,error:a,errorType:"required"}}if(y==null||y===""||Array.isArray(y)&&y.length===0)return{success:!0};if(t.unique&&n&&n.length>0&&y!==null&&y!==void 0){const a=wt(y);let l=!1;for(let h=0;h<n.length;h++){if(h===o)continue;const d=n[h][e];if(wt(d)===a){l=!0;break}}if(l){const h=`Value must be unique in column "${r}".`;return m("warn",s,`Validation failed: ${h}.`),{success:!1,error:h,errorType:"unique"}}}switch(t.type){case"text":if(t.maxlength&&typeof y=="string"&&y.length>t.maxlength){const a=`Column "${r}" exceeds max length of ${t.maxlength}.`;return m("warn",s,`Validation failed: ${a}.`),{success:!1,error:a,errorType:"maxlength"}}break;case"email":if(typeof y!="string"||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(y)){const a=`Invalid email format for column "${r}".`;return m("warn",s,`Validation failed: ${a}.`),{success:!1,error:a,errorType:"value"}}break;case"number":if(typeof y!="number"){const a=`Column "${r}" expects a number.`;return m("warn",s,`Validation failed: ${a}.`),{success:!1,error:a,errorType:"value"}}if(t.decimal===!1&&!Number.isInteger(y)){const a=`Column "${r}" expects an integer.`;return m("warn",s,`Validation failed: ${a}.`),{success:!1,error:a,errorType:"value"}}break;case"date":if(typeof y!="string"||!/^\d{4}-\d{2}-\d{2}$/.test(y)||isNaN(new Date(y+"T00:00:00Z").getTime())){const a=`Invalid date format (YYYY-MM-DD) for column "${r}".`;return m("warn",s,`Validation failed: ${a}.`),{success:!1,error:a,errorType:"value"}}break;case"boolean":if(typeof y!="boolean"){const a=`Column "${r}" expects a boolean.`;return m("warn",s,`Validation failed: ${a}.`),{success:!1,error:a,errorType:"value"}}break;case"select":if(Array.isArray(y)){for(const a of y)if(a!==null&&i&&!i.has(a)){const l=`Invalid option "${a}" for column "${r}".`;return m("warn",s,`Validation failed: ${l}.`),{success:!1,error:l,errorType:"value"}}return{success:!0}}if(y!==null&&i&&!i.has(y)){const a=`Invalid option "${y}" for column "${r}".`;return m("warn",s,`Validation failed: ${a}.`),{success:!1,error:a,errorType:"value"}}break}return{success:!0}}function Et(y,t){const e=[];for(let i=0;i<y.length;i+=t)e.push(y.slice(i,i+t));return e}function Ht(y,t){let e=null;return function(...i){const s=()=>{e=null,y(...i)};e!==null&&clearTimeout(e),e=setTimeout(s,t)}}class $t{constructor(t,e,i){this.canvasContext=null,this.options=t,this.stateManager=e,this.domManager=i}setCanvasContext(t){this.canvasContext=t}calculateDimensions(t,e){const i=this.domManager.getSystemScrollbarWidth();this.stateManager.updateViewportSize(t-i,e-i),this.calculateTotalSize(),m("log",this.options.verbose,"Calculated Dimensions:",{totalContentWidth:this.stateManager.getTotalContentWidth(),totalContentHeight:this.stateManager.getTotalContentHeight(),viewportWidth:this.stateManager.getViewportWidth(),viewportHeight:this.stateManager.getViewportHeight()}),this.calculateVisibleRange()}calculateTotalSize(){const t=this.stateManager.getTotalColumnWidth(),e=this.stateManager.getTotalRowHeight();this.stateManager.updateTotalContentSize(t,e)}autoResizeRowHeights(){if(!this.options.autoResizeRowHeight||!this.canvasContext)return;const{wrapText:t,padding:e,defaultRowHeight:i,defaultColumnWidth:s}=this.options,n=this.stateManager.dataLength,o=this.stateManager.getColumns(),r=this.stateManager.getSchema(),a=this.stateManager.getColumnWidths(),l=this.stateManager.getUserResizedRows();this.canvasContext.save(),this.canvasContext.font=this.options.font;for(let h=0;h<n;h++){if(l.has(h))continue;const d=this.stateManager.getRowHeight(h),g=i;let c=i;if(this.stateManager.getRowData(h)){for(let p=0;p<o.length;p++){if(p<0||p>=o.length)continue;const M=o[p],f=r[M];if(!(f!=null&&f.wordWrap)&&!t)continue;const C=this.stateManager.getCellData(h,p);if(C==null||C==="")continue;let w=String(C);if(f.formatter){const v=f.formatter(C);v!=null&&(w=String(v))}else w=mt(C,f==null?void 0:f.type,this.stateManager.cachedDropdownOptionsByColumn.get(M));const b=(a.get(p)||s)-e*2,x=this.measureTextHeight(w,b,f.wordWrap||t);c=Math.max(c,x+e*2)}c=Math.max(c,g),c!==d&&this.stateManager.setAutoRowHeight(h,c)}}this.canvasContext.restore(),this.calculateTotalSize(),this.calculateVisibleRange()}measureTextHeight(t,e,i){if(!this.canvasContext)return this.options.defaultRowHeight;const{lineHeight:s}=this.options;if(!i)return s;const n=t.split(" ");let o=1,r="";if(t.includes(`
`)){o=t.split(`
`).length;const a=t.split(`
`);let l=0;for(const h of a){if(!h){l+=1;continue}const d=h.split(" ");let g="",c=1;for(const u of d){const p=g?`${g} ${u}`:u;this.canvasContext.measureText(p).width<=e?g=p:(g=u,c++)}l+=c}o=l}else for(const a of n){const l=r?`${r} ${a}`:a;this.canvasContext.measureText(l).width<=e?r=l:(r=a,o++)}return o*s}calculateVisibleRange(){const{headerHeight:t,rowNumberWidth:e,defaultRowHeight:i,defaultColumnWidth:s}=this.options,n=this.stateManager.dataLength,o=this.stateManager.getColumns(),r=this.stateManager.getColumnWidths(),a=this.stateManager.getRowHeights(),l=this.stateManager.getScrollLeft(),h=this.stateManager.getScrollTop(),d=this.stateManager.getViewportWidth(),g=this.stateManager.getViewportHeight();let c=e,u=-1,p=o.length-1;for(let w=0;w<o.length;w++){const S=r.get(w)||s,b=c+S;if(b>l&&c<l+d)u===-1&&(u=w),p=w;else if(u!==-1)break;c=b}u===-1&&(u=0,p=-1);let M=t,f=-1,C=n-1;for(let w=0;w<n;w++){const S=a.get(w)||i,b=M+S;if(b>h&&M<h+g)f===-1&&(f=w),C=w;else if(f!==-1)break;M=b}f===-1&&(f=0,C=-1),this.stateManager.updateVisibleRange(f,C,u,p),m("log",this.options.verbose,"Calculated Visible Range:",{rows:`${f} - ${C}`,cols:`${u} - ${p}`})}getColumnLeft(t){const{rowNumberWidth:e,defaultColumnWidth:i}=this.options;let s=e+t*i;const n=this.stateManager.getColumnWidths().entries();for(const[o,r]of n)o<t&&(s+=r-i);return s}getRowTop(t){const{headerHeight:e,defaultRowHeight:i}=this.options;let s=e+t*i;const n=this.stateManager.getRowHeights().entries();for(const[o,r]of n)o<t&&(s+=r-i);return s}}class Lt{constructor(t,e,i,s){this.temporaryErrors=new Map,this.ctx=t,this.options=e,this.stateManager=i,this.dimensionCalculator=s,this.dimensionCalculator.setCanvasContext(t)}setTemporaryErrors(t){const{temporaryErrorTimeout:e}=this.options;if(!e)return;const i=t.map(({row:n,col:o,error:r})=>[`${n}:${o}`,r]),s=Date.now()+e;for(const[n,o]of i)this.temporaryErrors.set(n,{error:o,expireAt:s});setTimeout(()=>{let n=0;for(const[o]of i)n+=this.temporaryErrors.delete(o)?1:0;n&&this.draw()},e)}clearTemporaryErrors(t){let e=0;for(const{row:i,col:s}of t)e+=this.temporaryErrors.delete(`${i}:${s}`)?1:0;return e>0}draw(){this.ctx.save(),this.ctx.font=this.options.font,this._clearCanvas(),this._cleanupExpiredErrors(),this._drawCornerBox(),this._drawHeaders(),this._drawRowNumbers(),this.ctx.save(),this.ctx.beginPath();const{headerHeight:t,rowNumberWidth:e}=this.options;this.ctx.rect(e,t,this.stateManager.getViewportWidth()-e,this.stateManager.getViewportHeight()-t),this.ctx.clip(),this.ctx.translate(-this.stateManager.getScrollLeft(),-this.stateManager.getScrollTop()),this._drawCells(),this._drawGridLines(),this._drawCopiedCellHighlight(),this._drawActiveCellHighlight(),this._drawSelectedColumnHighlight(),this._drawSelectedRowsHighlight(),this._drawDragRange(),this.ctx.restore(),this.ctx.restore()}_cleanupExpiredErrors(){const t=Date.now();for(const[e,{expireAt:i}]of this.temporaryErrors.entries())t>=i&&this.temporaryErrors.delete(e)}_clearCanvas(){this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.stateManager.getViewportWidth(),this.stateManager.getViewportHeight())}_drawCornerBox(){const{rowNumberWidth:t,headerHeight:e,gridLineColor:i,rowNumberBgColor:s}=this.options,n=0,o=0;this.ctx.save(),this.ctx.fillStyle=s,this.ctx.fillRect(n,o,t,e),this.ctx.strokeStyle=i,this.ctx.strokeRect(n-.5,o-.5,t,e),this.ctx.restore()}_drawHeaders(){const{headerHeight:t,rowNumberWidth:e,headerFont:i,headerBgColor:s,headerTextColor:n,gridLineColor:o,headerClipText:r,headerTextAlign:a,padding:l,selectedHeaderBgColor:h,customHeaderBgColor:d,readonlyHeaderBgColor:g,selectedHeaderTextColor:c,readonlyHeaderTextColor:u,highlightBorderColor:p,defaultColumnWidth:M}=this.options,f=this.stateManager.getColumns(),C=this.stateManager.getSchema(),w=this.stateManager.getColumnWidths(),S=this.stateManager.getSelectedColumn(),b=this.stateManager.getScrollLeft(),x=this.stateManager.getTotalContentWidth(),v=this.stateManager.getViewportWidth();this.ctx.save();const T=e,E=0,R=v-e,V=t;this.ctx.beginPath(),this.ctx.rect(T,E,R,V),this.ctx.clip(),this.ctx.translate(-b,0),this.ctx.fillStyle=s,this.ctx.fillRect(e,0,x,t),this.ctx.font=i,this.ctx.textAlign=a,this.ctx.textBaseline="middle";let H=e;for(let F=0;F<f.length;F++){const k=w.get(F)||M;if(H+k<b+e){H+=k;continue}if(H>b+v)break;const _=f[F],$=C[_],q=($==null?void 0:$.label)||_,U=S===F;let O=null,j=n;U?(O=h,j=c):$!=null&&$.removable?O=d:$!=null&&$.readonly&&(O=g,j=u),O&&(this.ctx.fillStyle=O,this.ctx.fillRect(H,0,k,t)),U&&(this.ctx.strokeStyle=p,this.ctx.lineWidth=2,this.ctx.strokeRect(H+1,1,k-2,t)),this.ctx.fillStyle=j;let Y=H+l;if(a==="center"?Y=H+k/2:a==="right"&&(Y=H+k-l),r?(this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(H,0,k,t),this.ctx.clip(),this.ctx.fillText(q,Y,t/2),this.ctx.restore()):this.ctx.fillText(q,Y,t/2,k-l*2),!U){this.ctx.strokeStyle=o,this.ctx.lineWidth=1,this.ctx.beginPath();const G=Math.round(H+k)-.5;this.ctx.moveTo(G,0),this.ctx.lineTo(G,t),this.ctx.stroke()}H+=k}this.ctx.strokeStyle=o,this.ctx.beginPath();const z=t-.5;this.ctx.moveTo(e,z),this.ctx.lineTo(Math.max(H,x+b),z),this.ctx.stroke(),this.ctx.restore()}_drawRowNumbers(){const{headerHeight:t,rowNumberWidth:e,font:i,rowNumberBgColor:s,selectedRowNumberBgColor:n,textColor:o,gridLineColor:r,defaultRowHeight:a,highlightBorderColor:l}=this.options,h=this.stateManager.dataLength,d=this.stateManager.getTotalContentHeight(),g=this.stateManager.getScrollTop(),c=this.stateManager.getViewportHeight();if(h){const u=this.stateManager.getRowHeights(),p=this.stateManager.getSelectedRows();this.ctx.save();const M=0,f=t,C=e,w=c-t;this.ctx.beginPath(),this.ctx.rect(M,f,C,w),this.ctx.clip(),this.ctx.translate(0,-g),this.ctx.fillStyle=s,this.ctx.fillRect(0,t,e,d),this.ctx.font=i,this.ctx.textAlign="center",this.ctx.textBaseline="middle";let S=t;for(let x=0;x<h;x++){const v=u.get(x)||a;if(S+v<g+t){S+=v;continue}if(S>g+c)break;const T=p.has(x);if(T&&(this.ctx.fillStyle=n,this.ctx.fillRect(0,S,e,v),this.ctx.strokeStyle=l,this.ctx.lineWidth=2,this.ctx.strokeRect(0,S,e,v)),this.ctx.fillStyle=o,this.ctx.fillText((x+1).toString(),e/2,S+v/2),!T){this.ctx.strokeStyle=r,this.ctx.beginPath(),this.ctx.lineWidth=1;const E=Math.round(S+v)-.5;this.ctx.moveTo(0,E),this.ctx.lineTo(e,E),this.ctx.stroke()}S+=v}this.ctx.strokeStyle=r,this.ctx.lineWidth=1,this.ctx.beginPath();const b=e-.5;this.ctx.moveTo(b,t),this.ctx.lineTo(b,Math.max(S,d+g)),this.ctx.stroke(),this.ctx.restore()}}_drawCells(){var at,lt,ht;const{headerHeight:t,rowNumberWidth:e,font:i,textColor:s,textAlign:n,padding:o,cellBgColor:r,activeCellBgColor:a,selectedRowBgColor:l,selectedRangeBgColor:h,disabledCellBgColor:d,disabledCellTextColor:g,errorCellBgColor:c,errorTextColor:u,loadingTextColor:p,placeholderTextColor:M,defaultRowHeight:f,wrapText:C,lineHeight:w,defaultColumnWidth:S}=this.options,b=this.stateManager.dataLength,x=this.stateManager.getColumns(),v=this.stateManager.getSchema(),T=this.stateManager.getRowHeights(),E=this.stateManager.getColumnWidths(),{visibleRowStart:R,visibleRowEnd:V,visibleColStart:H,visibleColEnd:z}=this.stateManager.getVisibleRange(),F=this.stateManager.getSelectedRows(),k=this.stateManager.getSelectedColumn(),_=this.stateManager.getActiveCell(),$=this.stateManager.getNormalizedSelectionRange(),q=this.stateManager.getScrollLeft(),U=this.stateManager.getScrollTop(),O=this.stateManager.getViewportWidth(),j=this.stateManager.getViewportHeight();this.ctx.save();const Y=Math.max(0,e-q),G=Math.max(0,t-U),Ct=O-Y,Mt=j-G;this.ctx.beginPath(),this.ctx.rect(Y+q,G+U,Ct,Mt),this.ctx.clip(),this.ctx.font=i,this.ctx.textAlign=n,this.ctx.textBaseline="middle";let Z=this.dimensionCalculator.getRowTop(R);for(let L=R;L<=V;L++){if(L<0||L>=b)continue;const B=this.stateManager.getRowData(L),Q=T.get(L)||f,yt=F.has(L);let K=this.dimensionCalculator.getColumnLeft(H);for(let A=H;A<=z;A++){if(A<0||A>=x.length)continue;const X=E.get(A)||S,tt=x[A],W=v[tt],ct=["select","boolean","date"].includes(W==null?void 0:W.type),et=B==null?void 0:B[`${D}${tt}`],dt=this.stateManager.isCellDisabled(L,A),gt=(_==null?void 0:_.row)===L&&(_==null?void 0:_.col)===A,st=((at=this.stateManager.getActiveEditor())==null?void 0:at.row)===L&&((lt=this.stateManager.getActiveEditor())==null?void 0:lt.col)===A,St=k===A,bt=B==null?void 0:B[`${J}${tt}`],nt=(ht=this.temporaryErrors.get(`${L}:${A}`))==null?void 0:ht.error,vt=$&&L>=$.start.row&&L<=$.end.row&&A>=$.start.col&&A<=$.end.col;let I=r;yt&&(I=l),St&&(I=l),vt&&!gt&&(I=h),dt&&(I=d),gt&&!st&&(I=a),(et||nt)&&(I=c),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(K,Z,X,Q),this.ctx.clip(),(!st||ct)&&I&&(this.ctx.fillStyle=I,this.ctx.fillRect(K,Z,X,Q));let ut=!0;if(st&&!ct&&(ut=!1),ut){const pt=Z+Q/2;let it=K+o;if(bt)this.ctx.fillStyle=p,this.ctx.fillText("(Loading...)",it,pt,X-o*2);else{const ft=B==null?void 0:B[tt];let P=nt||(W!=null&&W.formatter?W.formatter(ft):mt(ft,W==null?void 0:W.type,this.stateManager.cachedDropdownOptionsByColumn.get(tt)));!P&&et&&(P=`${et}`.includes("required")?"(required)":et),P!=null&&P!==""&&(this.ctx.fillStyle=dt?g:st?M:et||nt?u:s,n==="center"?it=K+X/2:n==="right"&&(it=K+X-o),W.wordWrap||C?this.wrapText(P,it,Z,X-o*2,Q,C||!!W.wordWrap,w):this.ctx.fillText(P,it,pt))}}this.ctx.restore(),K+=X}Z+=Q}this.ctx.restore()}_drawGridLines(){const{headerHeight:t,rowNumberWidth:e,gridLineColor:i,defaultRowHeight:s,defaultColumnWidth:n}=this.options,o=this.stateManager.getTotalContentWidth(),r=this.stateManager.getTotalContentHeight(),a=this.stateManager.getColumns(),l=this.stateManager.dataLength,h=this.stateManager.getColumnWidths(),d=this.stateManager.getRowHeights(),g=this.stateManager.getViewportWidth(),c=this.stateManager.getViewportHeight(),u=this.stateManager.getScrollLeft(),p=this.stateManager.getScrollTop();this.ctx.save(),this.ctx.strokeStyle=i,this.ctx.lineWidth=1;let M=e;for(let C=0;C<=a.length;C++){const w=Math.round(M)-.5;if(w>=e&&w<=g+u&&(this.ctx.beginPath(),this.ctx.moveTo(w,t),this.ctx.lineTo(w,r+t),this.ctx.stroke()),C<a.length&&(M+=h.get(C)||n),M>g+u)break}let f=t;for(let C=0;C<=l;C++){const w=Math.round(f)-.5;if(w>=t&&w<=c+p&&(this.ctx.beginPath(),this.ctx.moveTo(e,w),this.ctx.lineTo(o+e,w),this.ctx.stroke()),C<l&&(f+=d.get(C)||s),f>c+p)break}this.ctx.restore()}_drawActiveCellHighlight(){const t=this.stateManager.getActiveCell(),e=this.stateManager.isDraggingFillHandle(),i=this.stateManager.isResizing(),s=this.stateManager.getActiveEditor(),n=this.stateManager.getNormalizedSelectionRange();if(i||e||!t&&!n)return;const{highlightBorderColor:o,fillHandleColor:r,fillHandleSize:a}=this.options;this.ctx.save(),this.ctx.strokeStyle=o,this.ctx.lineWidth=2;let l=null,h=null;if(n){const d=this.getCellBounds(n.start.row,n.start.col),g=this.getCellBounds(n.end.row,n.end.col);d&&g&&(l={x:d.x,y:d.y,width:g.x+g.width-d.x,height:g.y+g.height-d.y}),t&&t.row!==null&&t.col!==null&&(h=this.getCellBounds(t.row,t.col))}else t&&t.row!==null&&t.col!==null&&(h=this.getCellBounds(t.row,t.col),l=h);if(l&&this.ctx.strokeRect(l.x+1,l.y+1,l.width-2,l.height-2),!s&&h){const d=a/2,g=h.x+h.width-d-1,c=h.y+h.height-d-1;this.ctx.fillStyle=r,this.ctx.beginPath(),this.ctx.arc(g,c,d,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=1,this.ctx.stroke()}this.ctx.restore()}_drawDragRange(){const t=this.stateManager.isDraggingFillHandle(),e=this.stateManager.getDragStartCell(),i=this.stateManager.getDragEndRow();if(!t||!e||i===null||i===e.row)return;const{row:s,col:n}=e;if(s===null||n===null)return;const{dragRangeBorderColor:o,defaultRowHeight:r,defaultColumnWidth:a}=this.options,l=i,h=this.stateManager.getColumnWidths(),d=this.stateManager.getRowHeights(),g=this.stateManager.dataLength;if(n<0||n>=this.stateManager.getColumns().length)return;const c=h.get(n)||a,u=this.dimensionCalculator.getColumnLeft(n),p=l>=s;let M,f;if(p){M=this.dimensionCalculator.getRowTop(s)+(d.get(s)||r),f=0;for(let b=s+1;b<=l&&!(b>=g);b++)f+=d.get(b)||r}else{M=this.dimensionCalculator.getRowTop(l),f=0;for(let S=l;S<s&&!(S>=g);S++)f+=d.get(S)||r}if(f<=0)return;const C=u,w=M;this.ctx.save(),this.ctx.strokeStyle=o,this.ctx.lineWidth=2,this.ctx.setLineDash([4,2]),this.ctx.strokeRect(C+.5,w+.5,c-1,f-1),this.ctx.restore()}_drawCopiedCellHighlight(){const t=this.stateManager.getCopiedCell(),e=this.stateManager.getCopiedSourceRange();if(!t&&!e)return;const{copyHighlightBorderColor:i,copyHighlightBorderDash:s}=this.options;let n=null;if(e){const o=this.getCellBounds(e.start.row,e.start.col),r=this.getCellBounds(e.end.row,e.end.col);o&&r&&(n={x:o.x,y:o.y,width:r.x+r.width-o.x,height:r.y+r.height-o.y})}else t&&t.row!==null&&t.col!==null&&(n=this.getCellBounds(t.row,t.col));n&&(this.ctx.save(),this.ctx.strokeStyle=i,this.ctx.lineWidth=1,this.ctx.setLineDash(s),this.ctx.strokeRect(n.x+.5,n.y+.5,n.width-1,n.height-1),this.ctx.restore())}_drawSelectedColumnHighlight(){const t=this.stateManager.getSelectedColumn();if(t===null)return;const{highlightBorderColor:e,headerHeight:i,defaultColumnWidth:s}=this.options,n=this.stateManager.getTotalContentHeight(),o=this.stateManager.getColumnWidths(),r=this.dimensionCalculator.getColumnLeft(t),a=o.get(t)||s;a&&(this.ctx.save(),this.ctx.strokeStyle=e,this.ctx.lineWidth=2,this.ctx.strokeRect(r+1,i-1,a-2,n),this.ctx.restore())}_drawSelectedRowsHighlight(){const t=this.stateManager.getSelectedRows();if(t.size===0)return;const{highlightBorderColor:e,defaultRowHeight:i,rowNumberWidth:s}=this.options,n=this.stateManager.getTotalContentWidth(),o=this.stateManager.getRowHeights();this.ctx.save(),this.ctx.strokeStyle=e,this.ctx.lineWidth=2;for(const r of t){const a=o.get(r)||i,l=this.dimensionCalculator.getRowTop(r);this.ctx.strokeRect(s-1,l,n,a)}this.ctx.restore()}wrapText(t,e,i,s,n,o,r){if(!this.ctx||!t||s<=0||n<=0)return;const a=this.ctx.textBaseline;this.ctx.textBaseline="middle";let l=[];if(t.includes(`
`)){const M=t.split(`
`);for(const f of M){if(!f){l.push("");continue}if(o){const C=f.split(" ");let w="";for(const S of C){const b=w?`${w} ${S}`:S;this.ctx.measureText(b).width<=s?w=b:(w&&l.push(w),w=S)}w&&l.push(w)}else l.push(f)}}else if(o){const M=t.split(" ");let f="";for(const C of M){const w=f?`${f} ${C}`:C;this.ctx.measureText(w).width<=s?f=w:f?(l.push(f),f=C):(l.push(C),f="")}f&&l.push(f)}else l.push(t);const h=l.length,d=h*r;let g;d<=n?g=i+n/2-d/2+r/2:g=i+r/2;const c=r/2,u=r/2,p=i+n;for(let M=0;M<h;M++){const f=g+M*r;if(!(f+u<i)){if(f-c>p)break;this.ctx.fillText(l[M],e,f,s)}}this.ctx.textBaseline!==a&&(this.ctx.textBaseline=a)}getCellBounds(t,e){const{headerHeight:i,rowNumberWidth:s}=this.options,n=this.stateManager.dataLength,o=this.stateManager.getColumns(),r=this.stateManager.getTotalContentWidth()+s,a=this.stateManager.getTotalContentHeight()+i;if(t<0||t>=n||e<0||e>=o.length)return null;const l=this.stateManager.getColumnWidth(e),h=this.stateManager.getRowHeight(t),d=this.dimensionCalculator.getColumnLeft(e),g=this.dimensionCalculator.getRowTop(t),c=d,u=g;return c<r&&c+l>0&&u<a&&u+h>0?{x:c,y:u,width:l,height:h}:null}getFillHandleBounds(t,e){const i=this.getCellBounds(t,e);if(!i)return null;const{fillHandleSize:s,headerHeight:n,rowNumberWidth:o}=this.options,r=s/2,a=i.x+i.width-r-1,l=i.y+i.height-r-1;return{x:a-r-o,y:l-r-n,width:s,height:s}}renderResizeDivider(t,e,i,s){const{headerHeight:n,rowNumberWidth:o,highlightBorderColor:r,resizeHeaderBgColor:a,resizeHeaderBgAlphaBlend:l,resizeRowBgColor:h,resizeRowBgAlphaBlend:d}=this.options,g=this.stateManager.getScrollLeft(),c=this.stateManager.getScrollTop();if(this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.drawImage(t,0,0),this.ctx.save(),this.ctx.strokeStyle=r,this.ctx.lineWidth=2,e==="column"){const u=this.dimensionCalculator.getColumnLeft(i),p=u+s-g-.5;this.ctx.beginPath(),this.ctx.moveTo(p,0),this.ctx.lineTo(p,this.ctx.canvas.height),this.ctx.stroke(),a&&(l&&(this.ctx.save(),this.ctx.globalCompositeOperation=l),this.ctx.fillStyle=a,this.ctx.fillRect(u-g,0,s,n),l&&this.ctx.restore())}else{const u=this.dimensionCalculator.getRowTop(i),p=u+s-c-.5;this.ctx.beginPath(),this.ctx.moveTo(0,p),this.ctx.lineTo(this.ctx.canvas.width,p),this.ctx.stroke(),h&&(d&&(this.ctx.save(),this.ctx.globalCompositeOperation=d),this.ctx.fillStyle=h,this.ctx.fillRect(0,u-c,o,s),d&&this.ctx.restore())}this.ctx.restore()}}class At{constructor(t,e,i,s,n,o,r,a){this.resizeTimeout=null,this._ignoreNextClick=!1,this.isCtrl=!1,this.lastTouchX=null,this.lastTouchY=null,this.isTouching=!1,this.touchVelocityX=0,this.touchVelocityY=0,this.lastTouchTime=0,this.kineticScrollInterval=null,this.redrawOnKeyUp=!1,this.container=t,this.editingManager=e,this.interactionManager=i,this.stateManager=s,this.dimensionCalculator=n,this.renderer=o,this.options=r,this.domManager=a,this.canvas=this.domManager.getCanvas(),this.hScrollbar=this.domManager.getHScrollbar(),this.vScrollbar=this.domManager.getVScrollbar(),this.interactionManager.setEditingManager(this.editingManager)}bindEvents(){this.container.addEventListener("wheel",this._handleWheel.bind(this)),this.hScrollbar.addEventListener("scroll",this._handleHScroll.bind(this)),this.vScrollbar.addEventListener("scroll",this._handleVScroll.bind(this)),this.canvas.addEventListener("dblclick",this._handleDoubleClick.bind(this)),this.canvas.addEventListener("click",this._handleClick.bind(this)),this.canvas.addEventListener("mousedown",this._handleCanvasMouseDown.bind(this)),this.canvas.addEventListener("contextmenu",this._handleCanvasContextMenu.bind(this)),document.addEventListener("mousemove",this._handleDocumentMouseMove.bind(this)),document.addEventListener("mouseup",this._handleDocumentMouseUp.bind(this)),new ResizeObserver(()=>{this._handleResize()}).observe(this.container),document.addEventListener("mousedown",this._handleGlobalMouseDown.bind(this),!0),document.addEventListener("keydown",this._handleDocumentKeyDown.bind(this)),document.addEventListener("keyup",this._handleDocumentKeyUp.bind(this)),this.container.addEventListener("paste",this._handlePaste.bind(this)),this.canvas.addEventListener("touchstart",this._handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this._handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this._handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this._handleTouchEnd.bind(this)),this.editingManager.bindInternalEvents(),window.addEventListener("keydown",t=>{if(t.key.startsWith("Arrow")&&document.activeElement===this.container){const e=this.stateManager.getActiveCell(),i=e&&e.row!==null&&e.col!==null;e&&i&&t.preventDefault()}})}redraw(t=!1){t&&this.options.autoResizeRowHeight?this.interactionManager.resizeRowsForColumn():this.renderer.draw()}_handleScroll(){this.interactionManager.onScroll()}_handleWheel(t){const e=t.deltaY,i=t.shiftKey;this.interactionManager.canScrollMore(e,!i)&&(t.preventDefault(),this.interactionManager.moveScroll(i?e:0,i?0:e),this._handleScroll())}_handleHScroll(t){const i=t.target.scrollLeft;this.stateManager.updateScroll(this.stateManager.getScrollTop(),i),this._handleScroll()}_handleVScroll(t){const i=t.target.scrollTop;this.stateManager.updateScroll(i,this.stateManager.getScrollLeft()),this._handleScroll()}_handleResize(){this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=window.setTimeout(()=>{this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown(),this.dimensionCalculator.calculateDimensions(this.container.clientWidth,this.container.clientHeight),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.renderer.draw(),this.resizeTimeout=null},100)}_handleDoubleClick(t){if(this.stateManager.isResizing()){m("log",this.options.verbose,"Double click ignored due to active resize.");return}const e=this._getCoordsFromEvent(t);if(!e||e.row===null||e.col===null)return;let i=!1;if(i=i||this.interactionManager.clearSelections(),i=i||this.interactionManager.clearCopiedCell(),i=i||this.stateManager.setActiveCell(e),this.stateManager.isCellDisabled(e.row,e.col)){m("log",this.options.verbose,`Edit prevented: Cell ${e.row},${e.col} is disabled.`),i&&this.renderer.draw();return}this.editingManager.activateEditor(e.row,e.col)}_handleClick(t){if(this._ignoreNextClick){this._ignoreNextClick=!1;return}if(this.stateManager.isDraggingFillHandle()||this.stateManager.isResizing()){m("log",this.options.verbose,"Click ignored due to active fill handle drag or resize.");return}const e=this._getCoordsFromEvent(t),i=e&&e.row!==null&&e.col!==null,s=e&&e.row!==null&&e.col===null&&this._isRowNumberAreaClick(t),n=this._isHeaderAreaClick(t);let o=!1;if(this.editingManager.isEditorActive()){const a=this.stateManager.getActiveEditor();i&&(e==null?void 0:e.row)===(a==null?void 0:a.row)&&(e==null?void 0:e.col)===(a==null?void 0:a.col)||this.editingManager.deactivateEditor(!0)}else this.editingManager.isDropdownVisible()&&this.editingManager.hideDropdown();const r=this.stateManager.isCopyActive();if(s&&e&&e.row!==null){const a=this.interactionManager.handleRowNumberClick(e.row,t.shiftKey,t.ctrlKey||t.metaKey),l=r?this.interactionManager.clearCopiedCell():!1;o=a||l}else if(n){const a=this._getColumnFromEvent(t);if(a!==null){const l=this.interactionManager.handleHeaderClick(a),h=r?this.interactionManager.clearCopiedCell():!1;o=l||h}}else{const a=this.stateManager.setActiveCell(null);let l=!1,h=!1;a&&(l=this.interactionManager.clearSelections(),h=this.stateManager.clearSelectionRange());const d=r?this.interactionManager.clearCopiedCell():!1;o=a||l||h||d}o&&this.renderer.draw()}_handleCanvasContextMenu(t){var r,a,l,h,d,g;t.preventDefault();const e=this._getCoordsFromEvent(t),i=e&&e.row!==null&&e.col!==null,s=e&&e.row!==null&&e.col===null&&this._isRowNumberAreaClick(t),n=this._isHeaderAreaClick(t);let o=!1;if(i)try{(a=(r=this.options).onCellContextMenu)==null||a.call(r,{rowIndex:e==null?void 0:e.row,colKey:this.stateManager.getColumnKey(e==null?void 0:e.col),rowData:this.stateManager.getRowData(e==null?void 0:e.row)||{},x:t.clientX,y:t.clientY})}catch(c){m("warn",this.options.verbose,c)}else if(s){o=this.interactionManager.handleRowNumberClick(e==null?void 0:e.row,t.shiftKey,t.ctrlKey||t.metaKey);try{(h=(l=this.options).onRowNumberContextMenu)==null||h.call(l,{rowIndex:e==null?void 0:e.row,x:t.clientX,y:t.clientY})}catch(c){m("warn",this.options.verbose,c)}}else if(n&&(e==null?void 0:e.col)!==null){o=this.interactionManager.handleHeaderClick(e==null?void 0:e.col);try{(g=(d=this.options).onColumnHeaderContextMenu)==null||g.call(d,{colIndex:e==null?void 0:e.col,x:t.clientX,y:t.clientY})}catch(c){m("warn",this.options.verbose,c)}}o&&this.renderer.draw()}_handleCanvasMouseDown(t){if(this._ignoreNextClick=!1,this.interactionManager.checkResizeHandles(t)){t.preventDefault(),t.stopPropagation();return}const i=this.stateManager.getActiveCell();let s=!1;if(i&&i.row!==null&&i.col!==null&&(s=!0,this.interactionManager.checkFillHandle(t))){t.preventDefault(),t.stopPropagation();return}const n=this._getCoordsFromEvent(t);if(n&&n.row!==null&&n.col!==null){if(this.editingManager.isEditorActive()){const r=this.stateManager.getActiveEditor();(n.row!==(r==null?void 0:r.row)||n.col!==(r==null?void 0:r.col))&&this.editingManager.deactivateEditor(!0)}if(t.shiftKey&&s&&(n.row!==(i==null?void 0:i.row)||n.col!==(i==null?void 0:i.col))){m("log",this.options.verbose,`shift click detected at ${i==null?void 0:i.row},${i==null?void 0:i.col} -> ${n.row},${n.col}`),t.preventDefault(),this.domManager.focusContainer();return}this.interactionManager.startSelectionDrag(n)&&this.renderer.draw(),t.preventDefault(),this.domManager.focusContainer()}}_handleDocumentMouseMove(t){if(this.stateManager.isResizing())this.interactionManager.handleResizeMouseMove(t);else if(this.stateManager.isDraggingFillHandle())this.interactionManager.handleFillHandleMouseMove(t),this._ignoreNextClick=!0;else if(this.stateManager.getIsDraggingSelection()){const e=this._getCoordsFromEvent(t);e&&this.interactionManager.updateSelectionDrag(e)&&this.renderer.draw()}else this.interactionManager.updateCursorStyle(t)}_handleDocumentMouseUp(t){let e=!1;const i=this.stateManager.getActiveCell();if(this.stateManager.getIsDraggingSelection())e=!0,this.interactionManager.endSelectionDrag();else if(t.shiftKey&&i&&i.row!==null&&i.col!==null){const s=this._getCoordsFromEvent(t);s&&s.row!==null&&s.col!==null&&(this.interactionManager.startSelectionDrag(i),this.interactionManager.updateSelectionDrag(s),this.interactionManager.endSelectionDrag(),this.renderer.draw(),e=!0,m("log",this.options.verbose,`shift click received: ${i.row},${i.col} -> ${s.row},${s.col}`))}this.stateManager.isResizing()&&(this.interactionManager.endResize(),e=!0),this.stateManager.isDraggingFillHandle()&&this.interactionManager.endFillHandleDrag(),this.interactionManager.updateCursorStyle(t),e&&(this._ignoreNextClick=!0)}_handleGlobalMouseDown(t){if(!(this.stateManager.isDraggingFillHandle()||this.stateManager.isResizing()||this.stateManager.getIsDraggingSelection())&&!this.container.contains(t.target)){m("log",this.options.verbose,"Outside click on container");let e=!1;if(this.editingManager.isEditorActive(!0)||this.editingManager.isDropdownVisible()){if(this.domManager.checkEventBoundInDropdown(t))return;this.editingManager.deactivateEditor(!0)}else{const i=this.stateManager.setActiveCell(null);let s=!1,n=!1;i&&(s=this.interactionManager.clearSelections(),n=this.stateManager.clearSelectionRange());const o=this.interactionManager.clearCopiedCell();e=i||s||n||o}e&&this.renderer.draw()}}_handleDocumentKeyDown(t){if(t.repeat&&["ArrowUp","ArrowDown","Enter","Tab","Escape","Delete"].includes(t.key)){t.preventDefault();return}if((t.ctrlKey||t.metaKey)&&(this.isCtrl=!0),this.editingManager.isEditorActive()||this.editingManager.isDropdownVisible())return;const e=this.stateManager.getActiveCell();let i=!1;t.key==="Tab"&&e&&(document.activeElement!==this.container&&!this.container.contains(document.activeElement)&&(t.preventDefault(),this.domManager.focusContainer()),i=this.interactionManager.moveActiveCell(0,t.shiftKey?-1:1),i&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange()),t.preventDefault()),this.redrawOnKeyUp=i}_handleDocumentKeyUp(t){var l,h,d;const e=this.isCtrl;(t.ctrlKey||t.metaKey)&&(this.isCtrl=!1);let i=this.redrawOnKeyUp,s=!1,n=null;if(this.redrawOnKeyUp&&(this.redrawOnKeyUp=!1),this.editingManager.isEditorActive()||this.editingManager.isDropdownVisible()){i&&this.renderer.draw();return}if(e&&t.key==="c"){i=this.interactionManager.copy(),t.preventDefault(),i&&this.renderer.draw();return}if(e&&t.key==="v"){i=this.interactionManager.paste(),t.preventDefault(),i&&this.redraw(!0);return}const o=this.stateManager.getActiveCell(),r=o&&o.row!==null&&o.col!==null,a=r&&this.stateManager.isCellDisabled(o.row,o.col);if(t.key==="Delete"){const g=this.stateManager.getSelectedColumn();if(this.stateManager.getSelectedRows().size>0){const c=this.stateManager.getSelectedRows(),u=Math.min(...Array.from(c.values()));n=this.interactionManager.findAdjacentCellByRowIndex(u),s=this.interactionManager.deleteSelectedRows(),t.preventDefault()}else if(r){const{row:c,col:u}=o,p=this.stateManager.getColumnKey(u);if(!a){const M=this.stateManager.getCellData(c,u);try{i=this.stateManager.updateCell(c,p,null,!0)}catch(f){m("warn",this.options.verbose,f),f instanceof rt&&(i=!0,f.errorType==="required"&&!M?this.stateManager.updateCell(c,`${D}${p}`,f.message):this.renderer.setTemporaryErrors([{row:c,col:u,error:f.message}]))}}t.preventDefault()}else if(t.key==="Delete"&&g!==null&&((l=this.stateManager.getSchemaForColumn(g))!=null&&l.removable)){if(this.options.onColumnDelete){try{this.options.onColumnDelete(g,this.stateManager.getSchemaForColumn(g))}catch(c){m("warn",this.options.verbose,c)}return}else{this.stateManager.getColumns().length>1&&(n=this.interactionManager.findAdjacentCellByColumnIndex(g));const c=this.stateManager.getColumnKey(g);this.stateManager.removeColumn(g),i=!0,s=!0;try{(d=(h=this.options).onColumnDeleted)==null||d.call(h,c)}catch(u){m("error",this.options.verbose,`Error calling onColumnDeleted: ${u}`)}}t.preventDefault()}}else if(t.key.startsWith("Arrow")){if(o&&r){let g=0,c=0;t.key==="ArrowUp"?g=-1:t.key==="ArrowDown"?g=1:t.key==="ArrowLeft"?c=-1:t.key==="ArrowRight"&&(c=1),(g!==0||c!==0)&&(i=this.interactionManager.moveActiveCell(g,c,!1),i&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange()),t.preventDefault())}}else t.key==="Enter"&&o?!a&&o.row!==null&&o.col!==null&&(this.editingManager.activateEditor(o.row,o.col),t.preventDefault()):t.key!=="Tab"&&!e&&!t.ctrlKey&&t.key.length===1&&o&&o.row!==null&&o.col!==null&&!a&&this.editingManager.activateEditor(o.row,o.col,t.key);s?this.interactionManager.triggerCustomEvent("resize",n):i&&this.renderer.draw()}_handlePaste(t){if(this.editingManager.isEditorActive()||!t.clipboardData)return;const e=t.clipboardData.getData("text/plain");if(!e)return;if(this.interactionManager.paste()){t.preventDefault(),this.redraw(!0);return}const i=this.stateManager.getActiveCell(),s=this.stateManager.getNormalizedSelectionRange(),n=this.stateManager.getSelectedColumn();if(n!==null){const d=e.split(/\r\n|\n|\r/)[0].split("	")[0];d&&(m("log",this.options.verbose,"Handling column paste from clipboard"),t.preventDefault(),this.interactionManager.pasteToColumnExternal(n,d)&&this.redraw(!0));return}const o=s,r=!o&&i?i:null;if(!o&&!r){m("log",this.options.verbose,"Clipboard paste ignored: No target cell or range selected.");return}m("log",this.options.verbose,"Handling native paste event."),t.preventDefault();let a=!1;const l=e.split(/\r\n|\n|\r/).map(d=>d.split("	")),h=l.length===1&&l[0].length===1;o?a=this.interactionManager.pasteRangeToRangeExternal(o,l):r&&r.row!==null&&r.col!==null&&(h?a=this.interactionManager.pasteSingleValueExternal(r,l[0][0]):a=this.interactionManager.pasteRangeFromTopLeftExternal(r,l)),a&&this.redraw(!0)}_getCoordsFromEvent(t){const e=this.domManager.getCanvasBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,{headerHeight:n,rowNumberWidth:o,defaultRowHeight:r,defaultColumnWidth:a}=this.options;let l,h;i>=o&&s>=n?(l=i-o+this.stateManager.getScrollLeft(),h=s-n+this.stateManager.getScrollTop()):s<n&&i>=o?(l=i-o+this.stateManager.getScrollLeft(),h=s):i<o&&s>=n?(l=i,h=s-n+this.stateManager.getScrollTop()):(l=i,h=s);const d=this.stateManager.dataLength,g=this.stateManager.getColumns(),c=this.stateManager.getRowHeights(),u=this.stateManager.getColumnWidths();let p=null,M=null;if(s>=n){let f=0;for(let C=0;C<d;C++){const w=c.get(C)||r;if(h>=f&&h<f+w){p=C;break}if(f+=w,f>h)break}}if(i>=o){let f=0;for(let C=0;C<g.length;C++){const w=u.get(C)||a;if(l>=f&&l<f+w){M=C;break}if(f+=w,f>l)break}}return s<n&&i<o?null:{row:p,col:M}}_getColumnFromEvent(t){const e=this.domManager.getCanvasBoundingClientRect(),i=t.clientX-e.left,{rowNumberWidth:s,defaultColumnWidth:n}=this.options;if(i<s)return null;const o=i-s+this.stateManager.getScrollLeft(),r=this.stateManager.getColumns(),a=this.stateManager.getColumnWidths();let l=0;for(let h=0;h<r.length;h++){const d=a.get(h)||n;if(o>=l&&o<l+d)return h;l+=d}return null}_isRowNumberAreaClick(t){const e=this.domManager.getCanvasBoundingClientRect();return t.clientX-e.left<this.options.rowNumberWidth}_isHeaderAreaClick(t){const e=this.domManager.getCanvasBoundingClientRect();return t.clientY-e.top<this.options.headerHeight}_handleTouchStart(t){if(t.preventDefault(),t.touches.length===1){const e=t.touches[0];this.lastTouchX=e.clientX,this.lastTouchY=e.clientY,this.isTouching=!0,this.lastTouchTime=Date.now(),this.kineticScrollInterval!==null&&(window.clearInterval(this.kineticScrollInterval),this.kineticScrollInterval=null),this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown()}}_handleTouchMove(t){if(!(!this.isTouching||!this.lastTouchX||!this.lastTouchY)&&(t.preventDefault(),t.touches.length===1)){const e=t.touches[0],i=e.clientX,s=e.clientY,n=this.domManager.getCanvasBoundingClientRect(),o=i-n.left,r=s-n.top,{headerHeight:a,rowNumberWidth:l}=this.options,h=this.lastTouchX-i,d=this.lastTouchY-s,g=Date.now(),c=g-this.lastTouchTime;c>0&&(this.touchVelocityX=h/c*15,this.touchVelocityY=d/c*15),o>=l&&r>=a?this.interactionManager.moveScroll(h,d):r<a&&o>=l?this.interactionManager.moveScroll(h,0):o<l&&r>=a&&this.interactionManager.moveScroll(0,d),this._handleScroll(),this.lastTouchX=i,this.lastTouchY=s,this.lastTouchTime=g}}_handleTouchEnd(t){t.preventDefault(),this.isTouching=!1,(Math.abs(this.touchVelocityX)>.5||Math.abs(this.touchVelocityY)>.5)&&this._startKineticScroll()}_startKineticScroll(){const t=this.domManager.getCanvasBoundingClientRect(),e={x:this.lastTouchX!==null?this.lastTouchX-t.left:0,y:this.lastTouchY!==null?this.lastTouchY-t.top:0},{headerHeight:i,rowNumberWidth:s}=this.options;this.kineticScrollInterval!==null&&window.clearInterval(this.kineticScrollInterval),this.kineticScrollInterval=window.setInterval(()=>{if(this.touchVelocityX*=.95,this.touchVelocityY*=.95,Math.abs(this.touchVelocityX)<.5&&Math.abs(this.touchVelocityY)<.5){window.clearInterval(this.kineticScrollInterval),this.kineticScrollInterval=null;return}e.x>=s&&e.y>=i?this.interactionManager.moveScroll(this.touchVelocityX,this.touchVelocityY):e.y<i&&e.x>=s?this.interactionManager.moveScroll(this.touchVelocityX,0):e.x<s&&e.y>=i&&this.interactionManager.moveScroll(0,this.touchVelocityY),this._handleScroll()},16)}}class kt{constructor(t,e,i,s,n,o){this.dropdownItems=[],this.highlightedDropdownIndex=-1,this.selectedDropdownItems=new Set,this.DEFAULT_SAFE_MARGIN=50,this.container=t,this.options=e,this.stateManager=i,this.domManager=s,this.renderer=n,this.interactionManager=o,this.editorInput=this.domManager.getEditorInput(),this.editorTextarea=this.domManager.getEditorTextarea();const r=this.domManager.getDropdownElements();this.dropdown=r.dropdown,this.dropdownSearchInput=r.searchInput,this.dropdownList=r.list,this.dropdownFooter=r.footer,this.dropdownDoneButton=r.doneButton,this.dropdownClearButton=r.clearButton,this.debouncedLazySearch=Ht(this._handleLazySearch.bind(this),this.options.lazySearchDebounceTime)}bindInternalEvents(){this.editorInput.addEventListener("keydown",this._handleEditorKeyDown.bind(this)),this.editorTextarea.addEventListener("keydown",this._handleEditorKeyDown.bind(this)),this.dropdown.addEventListener("mousedown",t=>t.stopPropagation()),this.dropdownSearchInput.addEventListener("input",this._handleDropdownSearch.bind(this)),this.dropdownSearchInput.addEventListener("keydown",this._handleDropdownKeyDown.bind(this)),this.dropdownList.addEventListener("click",this._handleDropdownItemClick.bind(this)),this.dropdownDoneButton.addEventListener("click",this._handleDropdownDoneButtonClick.bind(this)),this.dropdownClearButton.addEventListener("click",this._handleDropdownClearButtonClick.bind(this))}isEditorActive(t=!1){const e=this.stateManager.getActiveEditor();return!(!e||t&&e.isCustomEditor)}isDropdownVisible(){return this.dropdown.style.display!=="none"}_handleDropdownClearButtonClick(){this.selectedDropdownItems.clear(),this.dropdownList.querySelectorAll("li input[type='checkbox']").forEach(t=>{t.checked=!1})}_handleDropdownDoneButtonClick(){this.deactivateEditor(!0,!0),this.domManager.focusContainer()}activateEditor(t,e,i){var x,v;const{customDatePicker:s,verbose:n,font:o,onEditorOpen:r}=this.options,a=this.stateManager.getColumnKey(e),l=this.stateManager.getRowData(t);if(!l){m("warn",n,`Cannot activate editor: Cell ${t},${e} row data not found.`);return}this.isEditorActive()&&this.deactivateEditor(!0),this.hideDropdown();const h=this.renderer.getCellBounds(t,e);if(!h){m("warn",n,`Cannot activate editor: Cell ${t},${e} bounds not found (likely not visible).`);return}const{scrollLeft:d,scrollTop:g}=this.interactionManager.bringBoundsIntoView(h);if(l!=null&&l[`${J}${a}`]){m("log",n,`Edit prevented: Cell ${t},${e} is loading.`);return}if(this.stateManager.isCellDisabled(t,e)){m("log",n,`Edit prevented: Cell ${t},${e} is disabled.`);return}const c=this.stateManager.getSchemaForColumn(e);if(!c){m("warn",n,`Cannot activate editor: Cell ${t},${e} schema not found.`);return}if(c.readonly){m("log",n,`Edit prevented: Cell ${t},${e} is readonly.`);return}this.renderer.clearTemporaryErrors([{row:t,col:e}]);const u=l==null?void 0:l[a],p=!!(c.type==="date"&&s&&r);this.stateManager.setActiveEditor({row:t,col:e,type:c.type,originalValue:u,isCustomEditor:p});const{x:M,y:f,width:C,height:w}=h,S=M-d,b=f-g;if(p)try{r==null||r({rowIndex:t,colKey:a,rowData:l,bounds:{x:S,y:b,width:C,height:w}})}catch(T){m("error",n,`Error calling onEditorOpen: ${T}`)}else if((c==null?void 0:c.type)==="select"||(c==null?void 0:c.type)==="boolean"){this._showDropdown(t,a,c,S,b,C,w);return}else{const T=(c==null?void 0:c.type)==="text"&&(c==null?void 0:c.multiline)===!0,E=T?this.editorTextarea:this.editorInput;if(E.style.display="block",E.style.left=`${S}px`,E.style.top=`${b}px`,E.style.width=`${C}px`,T){const V=Math.min(window.innerHeight-b-20,Math.max(w*2,100));this.editorTextarea.style.height=`${V}px`,this.editorTextarea.placeholder=(c==null?void 0:c.placeholder)||""}else this.editorInput.style.height=`${w}px`,(c==null?void 0:c.type)==="number"?(this.editorInput.type="number",this.editorInput.step=c.decimal===!1?"1":"any",this.editorInput.placeholder=(c==null?void 0:c.placeholder)||""):(c==null?void 0:c.type)==="email"?this.editorInput.type="email":(c==null?void 0:c.type)==="date"?this.editorInput.type="date":(this.editorInput.type="text",this.editorInput.placeholder=(c==null?void 0:c.placeholder)||"");const R=Dt(u,c==null?void 0:c.type);T?(this.editorTextarea.value=R,this.editorTextarea.focus(),i&&(c==null?void 0:c.type)==="text"?(this.editorTextarea.value=i,this.editorTextarea.selectionStart=this.editorTextarea.selectionEnd=i.length):this.editorTextarea.select()):(this.editorInput.value=R,this.editorInput.focus(),i&&(["text","email"].includes(c==null?void 0:c.type)||(c==null?void 0:c.type)==="number"&&i.match(/^\d*\.?\d*$/))?this.editorInput.value=i:(c==null?void 0:c.type)==="date"?this.editorInput.showPicker():this.editorInput.select())}this.renderer.draw();try{(v=(x=this.options).onEditorOpened)==null||v.call(x,{row:t,col:e,schema:c})}catch(T){m("error",n,`Error calling onEditorOpened: ${T}`)}}deactivateEditor(t=!0,e=!1,i=!1){var d,g;const s=this.stateManager.getActiveEditor();if(!s||s.isCustomEditor&&!i)return;this.stateManager.newAsyncJobId();const{row:n,col:o,type:r,originalValue:a}=s;let l=!1,h=!1;if(r==="select"||r==="boolean"){const c=this.domManager.isDropdownMultiSelect();if(this.isDropdownVisible()){if(c&&t){const u=Array.from(this.selectedDropdownItems);let p=!1;if(Array.isArray(a)?p=JSON.stringify(u.sort())!==JSON.stringify([...a].sort()):p=!0,p){this.stateManager.updateCellInternal(n,o,u),l=!0;const M=this.stateManager.getColumnKey(o);this.interactionManager._batchUpdateCellsAndNotify([n],[M],[{[M]:a}])}}this.hideDropdown(),h=!0}!c&&!l&&(l=this.stateManager.getCellData(n,o)!==a)}else{const c=this.editorTextarea.style.display!=="none",u=this.editorInput.style.display!=="none";if(c||u){if(t){let p=c?this.editorTextarea.value:this.editorInput.value;const M=this.stateManager.getSchemaForColumn(o),f=this.stateManager.getColumnKey(o);M!=null&&M.autoTrim&&(p=p==null?void 0:p.trim());const C=Tt(p,M==null?void 0:M.type),w=N(C,M,f,this.stateManager.cachedDropdownOptionsByColumn.get(f),this.options.verbose,this.stateManager.getData(!0),n);"error"in w?(m("log",this.options.verbose,w.error),w.errorType==="required"&&!a?this.stateManager.updateCell(n,`${D}${f}`,w.error):this.renderer.setTemporaryErrors([{row:n,col:o,error:w.error}]),h=!0):(this.stateManager.removeCellValue(n,`${D}${f}`),C!==a&&(this.stateManager.updateCellInternal(n,o,C),l=!0,this.interactionManager._batchUpdateCellsAndNotify([n],[f],[{[f]:a}])))}c?(this.editorTextarea.style.display="none",this.editorTextarea.value=""):(this.editorInput.style.display="none",this.editorInput.value=""),h=!0}}this.stateManager.setActiveEditor(null),e&&(this.stateManager.setActiveCell({row:n,col:o}),h=!0),(l||h)&&(this.options.autoResizeRowHeight?this.interactionManager.resizeRowsForColumn():this.renderer.draw());try{(g=(d=this.options).onEditorClosed)==null||g.call(d,{row:n,col:o})}catch(c){m("error",this.options.verbose,`Error calling onEditorClosed: ${c}`)}}hasEditorSelection(){return this.highlightedDropdownIndex>=0}_handleEditorKeyDown(t){if(!this.isEditorActive())return;const e=t.target===this.editorTextarea;let i=!1;if(e){if(t.key==="Tab")if(t.preventDefault(),this.options.allowTabInTextarea){const s=this.editorTextarea.selectionStart,n=this.editorTextarea.selectionEnd;this.editorTextarea.value=this.editorTextarea.value.substring(0,s)+"	"+this.editorTextarea.value.substring(n),this.editorTextarea.selectionStart=this.editorTextarea.selectionEnd=s+1;return}else this.deactivateEditor(!0),i=this.interactionManager.moveActiveCell(0,t.shiftKey?-1:1),i&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange());if(t.key==="Escape"){this.deactivateEditor(!1,!0),this.domManager.focusContainer(),t.preventDefault();return}if(!(t.ctrlKey||t.metaKey))return;if(t.key==="Enter"&&(t.ctrlKey||t.metaKey)){this.deactivateEditor(!0),this.interactionManager.moveActiveCell(1,0)&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange(),this.renderer.draw()),t.preventDefault();return}}switch(t.key){case"Enter":e||(this.deactivateEditor(!0),i=this.interactionManager.moveActiveCell(1,0),i&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange()),t.preventDefault());break;case"Escape":this.deactivateEditor(!1,!0),this.domManager.focusContainer(),t.preventDefault();return;case"Tab":e||(this.deactivateEditor(!0),i=this.interactionManager.moveActiveCell(0,t.shiftKey?-1:1),i&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange()),t.preventDefault());break}i&&this.renderer.draw()}_populateDropdown(t=!1){t&&(this.dropdownList.innerHTML="",this.dropdownItems.sort((i,s)=>{const n=this.selectedDropdownItems.has(i.id),o=this.selectedDropdownItems.has(s.id);return n===o?0:n?-1:1}));const e=this.domManager.isDropdownMultiSelect();this.dropdownItems.forEach((i,s)=>{const n=document.createElement("li");if(n.className=`spreadsheet-dropdown-item${i.id===null?" spreadsheet-dropdown-item-blank":""}`,e){const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.padding="2px 4px";const r=document.createElement("input");r.type="checkbox",r.style.marginRight="4px",r.checked=this.selectedDropdownItems.has(i.id);const a=document.createElement("span");a.textContent=i.name,a.title=i.name,o.appendChild(r),o.appendChild(a),n.appendChild(o)}else n.textContent=i.name,n.title=i.name;n.dataset.index=String(s),n.dataset.value=String(i.id===null||i.id===void 0?"":i.id),n.style.maxWidth="200px",this.dropdownList.appendChild(n)})}_adjustDropdown(t=!1){requestAnimationFrame(()=>{const e=this.dropdown.getBoundingClientRect();let i=e.height;const s=+(this.dropdown.getAttribute("data-right-x")||0),n=+(this.dropdown.getAttribute("data-absolute-y")||0),o=+(this.dropdown.getAttribute("data-bounds-height")||0);if(e.x+e.width>window.innerWidth-this.DEFAULT_SAFE_MARGIN&&(this.dropdown.style.left=`${s-e.width}px`),!t){const l=this.dropdownList.querySelectorAll("li");let h=0;if(l.length>0){const d=l[0].offsetHeight||30;h=l.length*d,h+=this.dropdownSearchInput.offsetHeight,this.dropdownFooter.style.display!=="none"&&(h+=this.dropdownFooter.offsetHeight),h+=20,h=Math.max(100,Math.min(h,300))}else h=100;this.dropdown.style.height=`${h}px`,i=h}const r=Math.max(window.innerHeight,document.body.scrollHeight)-this.DEFAULT_SAFE_MARGIN;e.y+i>r&&(this.dropdown.style.top=`${n-o-i}px`);const a=this.domManager.isDropdownMultiSelect();this.dropdownDoneButton.style.display=a?"inline-block":"none"})}async _showDropdown(t,e,i,s,n,o,r){var x,v,T,E;const{blankDropdownItemLabel:a,onLazySearch:l,verbose:h}=this.options;this.dropdownItems=[],this.domManager.toggleDropdownLoader(!1);const d=i.multiple===!0;this.domManager.setDropdownMultiSelect(d),this.selectedDropdownItems.clear();const g=this.stateManager.getColumns().indexOf(e),c=this.stateManager.getCellData(t,g);d&&Array.isArray(c)?c.forEach(R=>{R!=null&&this.selectedDropdownItems.add(R)}):c!=null&&this.selectedDropdownItems.add(c);const u=i.nullable&&!i.multiple?[{id:null,name:a}]:[];let p=!1;if(i.type==="boolean")this.dropdownItems=[{id:!0,name:"True"},{id:!1,name:"False"},...u];else if(i.type==="select"&&(i.values||i.filterValues)){let R=i.values||[];{const V=(x=i.filterValues)==null?void 0:x.call(i,this.stateManager.getRowData(t)||{},t);if(V&&V instanceof Promise){const H=(v=this.stateManager.getActiveEditor())==null?void 0:v.asyncJobId;this.stateManager.updateCell(t,`${J}${e}`,!0),this.renderer.draw();const z=await V;if(this.stateManager.removeCellValue(t,`${J}${e}`),H!==this.stateManager.currentAsyncJobId){m("log",h,`Async operation aborted: ${e}`),this.renderer.draw();return}z!=null&&z.length&&(R=z||[],this.stateManager.addCachedDropdownOptionForColumn(e,R))}else V&&(R=V,this.stateManager.addCachedDropdownOptionForColumn(e,R))}this.dropdownItems=[...u,...R]}else if(i.type==="select"&&i.lazySearch&&l){this.dropdownItems=[...u],p=!0,this.domManager.toggleDropdownLoader(!0);try{await this._handleLazySearch("")}catch(R){m("error",h,`Error initializing lazy search: ${R}`),this.domManager.toggleDropdownLoader(!1)}}else{m("warn",h,`Dropdown requested for non-dropdown type: ${i.type}`);return}this.dropdownItems.length&&this._populateDropdown(!0),this.dropdownFooter.style.display=d?"block":"none";const M=this.container.offsetLeft,f=this.container.offsetTop,C=s+M,w=n+f+r,S=C+o,b=this.dropdown.getAttribute("data-column")===e;this.dropdown.style.display="flex",this.dropdown.style.left=`${C}px`,this.dropdown.style.top=`${w}px`,this.dropdown.setAttribute("data-right-x",`${S}`),this.dropdown.setAttribute("data-absolute-y",`${w}`),this.dropdown.setAttribute("data-bounds-height",`${r}`),b||(this.dropdown.style.minWidth=`${o}px`,this.dropdown.style.maxHeight="400px",this.dropdown.style.height="300px",this.dropdown.style.width=`${Math.max(o,200)}px`,this.dropdown.style.resize="both",this.dropdown.style.overflow="hidden",this.dropdown.setAttribute("data-column",`${e}`),this.dropdownSearchInput.placeholder=i.placeholder||"Search..."),this._adjustDropdown(b),this.dropdownSearchInput.value="",p||this._filterDropdown(""),this.dropdownSearchInput.focus(),this.highlightedDropdownIndex=-1,this._updateDropdownHighlight(Array.from(this.dropdownList.querySelectorAll("li:not(.hidden)"))),this.renderer.draw();try{(E=(T=this.options).onEditorOpened)==null||E.call(T,{row:t,col:g,schema:i})}catch(R){m("error",this.options.verbose,`Error calling onEditorOpened: ${R}`)}}hideDropdown(){this.dropdown.style.display!=="none"&&(this.dropdown.style.display="none",this.highlightedDropdownIndex=-1),this.domManager.toggleDropdownLoader(!1)}_handleDropdownSearch(){const t=this.dropdownSearchInput.value.toLowerCase(),e=this.stateManager.getActiveEditor();if(!e)return;const i=this.stateManager.getSchemaForColumn(e.col);if(i!=null&&i.lazySearch&&this.options.onLazySearch){this.domManager.toggleDropdownLoader(!0),this.debouncedLazySearch(t);return}this._filterDropdown(t);const s=Array.from(this.dropdownList.querySelectorAll("li:not(.hidden)"));this.highlightedDropdownIndex=s.length>0?0:-1,this._updateDropdownHighlight(s)}_filterDropdown(t){this.dropdownList.querySelectorAll("li").forEach(i=>{var n;const s=t?(((n=i.textContent)==null?void 0:n.toLowerCase())||"").includes(t):!0;i.classList.toggle("hidden",!s),i.style.display=s?"block":"none"})}async _handleLazySearch(t){var h;const e=this.options.onLazySearch;if(!e)return;const i=this.stateManager.getActiveEditor();if(!i){this.domManager.toggleDropdownLoader(!1);return}const{row:s,col:n}=i,o=this.stateManager.getRowData(s);if(!o){this.domManager.toggleDropdownLoader(!1);return}const r=this.stateManager.getColumnKey(n),a=this.stateManager.getSchemaForColumn(n),l=a!=null&&a.nullable?[{id:null,name:this.options.blankDropdownItemLabel}]:[];try{this.domManager.toggleDropdownLoader(!0);const d=(h=this.stateManager.getActiveEditor())==null?void 0:h.asyncJobId,g=await e({searchTerm:t,rowIndex:s,colKey:r,rowData:o});if(d!==this.stateManager.currentAsyncJobId){m("log",this.options.verbose,`Async operation aborted: ${r}`),this.domManager.toggleDropdownLoader(!1);return}const c=this.stateManager.getActiveEditor();if(!c||c.row!==s||c.col!==n){this.domManager.toggleDropdownLoader(!1);return}this.dropdownItems=[...l,...g||[]],this._populateDropdown(!0);const u=Array.from(this.dropdownList.querySelectorAll("li:not(.hidden)"));this.highlightedDropdownIndex=u.length>0?0:-1,this._updateDropdownHighlight(u)}catch(d){m("error",this.options.verbose,`Error calling onLazySearch: ${d}`)}finally{this.domManager.toggleDropdownLoader(!1)}}_handleDropdownKeyDown(t){if(!this.isDropdownVisible())return;const e=Array.from(this.dropdownList.querySelectorAll("li:not(.hidden)"));if(!e.length&&t.key!=="Escape")return;let i=this.highlightedDropdownIndex;const s=this.domManager.isDropdownMultiSelect();switch(t.key){case"ArrowDown":t.preventDefault(),i=(i+1)%e.length;break;case"ArrowUp":t.preventDefault(),i=(i-1+e.length)%e.length;break;case" ":if(s&&i>=0&&i<e.length){t.preventDefault();const o=e[i],r=parseInt(o.dataset.index||"-1",10);if(r>=0&&r<this.dropdownItems.length){const l=this.dropdownItems[r].id;this.selectedDropdownItems.has(l)?this.selectedDropdownItems.delete(l):this.selectedDropdownItems.add(l);const h=o.querySelector('input[type="checkbox"]');h&&(h.checked=this.selectedDropdownItems.has(l));const d=this.stateManager.getActiveEditor();if(d){const{row:g,col:c}=d,u=this.stateManager.getColumnKey(c),p=Array.from(this.selectedDropdownItems),M=this.stateManager.updateCellInternal(g,c,p);this.interactionManager._batchUpdateCellsAndNotify([g],[u],[{[u]:M}])}return}}break;case"Enter":t.preventDefault();let n=-1;i>=0&&i<e.length?n=i:e.length===1&&(n=0),n>=0&&e[n].click();return;case"Escape":t.preventDefault(),this.deactivateEditor(!1,!0),this.domManager.focusContainer();return;case"Tab":if(t.preventDefault(),!`${this.dropdownSearchInput.value}`.trim()&&i<0){this.deactivateEditor(!1);return}break;default:return}this.highlightedDropdownIndex=i,this._updateDropdownHighlight(e)}_updateDropdownHighlight(t){t.forEach((e,i)=>{const s=i===this.highlightedDropdownIndex;e.classList.toggle("highlighted",s),e.style.backgroundColor=s?"#dbeafe":"white",s&&e.scrollIntoView({block:"nearest"})})}_handleDropdownItemClick(t){const e=t.target,i=this.domManager.isDropdownMultiSelect();let s=null,n=e;for(;n&&n.tagName!=="LI";)n=n.parentElement;if(s=n,!s||!s.classList.contains("spreadsheet-dropdown-item"))return;const o=this.stateManager.getActiveEditor();if(!o)return;const r=parseInt(s.dataset.index||"-1",10);if(r<0||r>=this.dropdownItems.length)return;const a=this.dropdownItems[r],{row:l,col:h}=o,d=this.stateManager.getColumnKey(h);this.stateManager.addCachedDropdownOptionForColumn(d,[a]);let g;if(i){const u=a.id;this.selectedDropdownItems.has(u)?this.selectedDropdownItems.delete(u):this.selectedDropdownItems.add(u);const p=s.querySelector('input[type="checkbox"]');p&&(p.checked=this.selectedDropdownItems.has(u));return}else g=a.id,typeof g=="string"&&o.type==="boolean"&&(g.toLowerCase()==="true"?g=!0:g.toLowerCase()==="false"&&(g=!1));const c=this.stateManager.updateCellInternal(l,h,g);this.interactionManager._batchUpdateCellsAndNotify([l],[d],[{[d]:c}]),setTimeout(()=>{this.deactivateEditor(!1),this.domManager.focusContainer()},200)}}class Wt{constructor(t,e,i,s,n){this.lastPasteHandledAt=null,this.ignoreNextScrollTimeout=null,this._customEventHandler=null,this.options=t,this.stateManager=e,this.renderer=i,this.dimensionCalculator=s,this.domManager=n}bindCustomEvents(t=null){this._customEventHandler=t}triggerCustomEvent(t,e){var i;(i=this._customEventHandler)==null||i.call(this,new CustomEvent(t,{detail:e}))}setEditingManager(t){this.editingManager=t}findAdjacentCellByColumnIndex(t){const{visibleRowEnd:e,visibleColStart:i,visibleColEnd:s}=this.stateManager.getVisibleRange();let n=null;return t>i?n=t-1:t<s&&(n=t+1),n!==null&&e!==null?this.renderer.getCellBounds(e,n):null}findAdjacentCellByRowIndex(t){const{visibleRowStart:e,visibleRowEnd:i,visibleColEnd:s}=this.stateManager.getVisibleRange();let n=null;return t>e?n=t-1:t<i&&(n=t+1),n!==null&&s!==null?this.renderer.getCellBounds(n,s):null}canScrollMore(t,e){return e?t>0?this.domManager.canVScrollDown():this.domManager.canVScrollUp():t>0?this.domManager.canHScrollRight():this.domManager.canHScrollLeft()}moveScroll(t,e,i=!1){const s=this.domManager.setVScrollPosition(i?e:this.domManager.getVScrollPosition()+e),n=this.domManager.setHScrollPosition(i?t:this.domManager.getHScrollPosition()+t);this.stateManager.updateScroll(s,n)}bringBoundsIntoView(t){const e=this.domManager.getHScrollPosition(),i=this.domManager.getVScrollPosition(),s=this.domManager.getCanvasBoundingClientRect(),{headerHeight:n,rowNumberWidth:o}=this.options,r=t.x-e,a=t.y-i,l=t.width,h=t.height;let d=e,g=i;return r<o?d+=r-o:r+l>s.width&&(d+=r+l-s.width),a<n?g+=a-n:a+h>s.height&&(g+=a+h-s.height),d=Math.max(0,d),g=Math.max(0,g),(d!==e||g!==i)&&this.moveScroll(d,g,!0),this.ignoreNextScrollTimeout=null,this.onScroll(!1),this.ignoreNextScrollTimeout=setTimeout(()=>{this.ignoreNextScrollTimeout=null},10),{scrollLeft:d,scrollTop:g}}onScroll(t=!0){if(this.ignoreNextScrollTimeout){clearTimeout(this.ignoreNextScrollTimeout),this.ignoreNextScrollTimeout=null;return}t&&(this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown()),this.dimensionCalculator.calculateVisibleRange(),this.renderer.draw()}handleRowNumberClick(t,e,i){m("log",this.options.verbose,`Row ${t} clicked. Shift: ${e}, Ctrl: ${i}`);const s=new Set(this.stateManager.getSelectedRows());let n=this.stateManager.getLastClickedRow();const o=JSON.stringify(Array.from(s).sort()),r=n;if(e&&n!==null){const d=Math.min(n,t),g=Math.max(n,t),c=new Set;for(let u=d;u<=g;u++)c.add(u);JSON.stringify(Array.from(c).sort())!==o&&this.stateManager.setSelectedRows(c,n),m("log",this.options.verbose,"Selected rows (Shift):",Array.from(c).sort((u,p)=>u-p))}else i?(s.has(t)?s.delete(t):s.add(t),n=t,this.stateManager.setSelectedRows(s,n),m("log",this.options.verbose,"Selected rows (Ctrl):",Array.from(s).sort((d,g)=>d-g))):(s.clear(),s.add(t),n=t,this.stateManager.setSelectedRows(s,n),m("log",this.options.verbose,"Selected rows (Single):",Array.from(s).sort((d,g)=>d-g)));const a=JSON.stringify(Array.from(this.stateManager.getSelectedRows()).sort())!==o,l=this.stateManager.getLastClickedRow()!==r,h=a||l;return h&&(this.stateManager.setActiveCell(null),this.stateManager.clearSelectionRange(),this.stateManager.setSelectedColumn(null)),h}handleHeaderClick(t){m("log",this.options.verbose,`Column ${t} clicked.`);const e=this.stateManager.getSelectedColumn();this.stateManager.setSelectedColumn(t);const i=e!==t;return i&&(this.stateManager.setActiveCell(null),this.stateManager.clearSelectionRange(),this.stateManager.setSelectedRows(new Set,null)),i}clearSelections(){let t=!1;return this.stateManager.getSelectedRows().size>0&&(t=this.stateManager.setSelectedRows(new Set,null)||t),this.stateManager.getSelectedColumn()!==null&&(t=this.stateManager.setSelectedColumn(null)||t),t}checkResizeHandles(t){const e=this.domManager.getCanvasBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,{headerHeight:n,rowNumberWidth:o,resizeHandleSize:r,defaultRowHeight:a,defaultColumnWidth:l}=this.options;let h,d;if(s<n&&i>=o){h=i-o+this.stateManager.getScrollLeft();const g=this.stateManager.getColumns(),c=this.stateManager.getColumnWidths();let u=0;for(let p=0;p<g.length;p++){const M=c.get(p)||l,f=u+M;if(Math.abs(h-f)<=r)return this._startColumnResize(p,t.clientX),"column";if(u+=M,u>h+r)break}}if(i<o&&s>=n){d=s-n+this.stateManager.getScrollTop();const g=this.stateManager.dataLength,c=this.stateManager.getRowHeights();let u=0;for(let p=0;p<g;p++){const M=c.get(p)||a,f=u+M;if(Math.abs(d-f)<=r)return this._startRowResize(p,t.clientY),"row";if(u+=M,u>d+r)break}}return null}_startColumnResize(t,e){m("log",this.options.verbose,`Starting column resize for index ${t}`),this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown();const i=this.domManager.getCanvas(),s=document.createElement("canvas");s.width=i.width,s.height=i.height;const n=s.getContext("2d");n&&n.drawImage(i,0,0);const o=this.stateManager.getColumnWidth(t);this.stateManager.setResizeColumnState({isResizing:!0,columnIndex:t,startX:e,canvasSnapshot:s,originalWidth:o}),this.domManager.setCursor("col-resize")}_startRowResize(t,e){m("log",this.options.verbose,`Starting row resize for index ${t}`),this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown();const i=this.domManager.getCanvas(),s=document.createElement("canvas");s.width=i.width,s.height=i.height;const n=s.getContext("2d");n&&n.drawImage(i,0,0);const o=this.stateManager.getRowHeight(t);this.stateManager.setResizeRowState({isResizing:!0,rowIndex:t,startY:e,canvasSnapshot:s,originalHeight:o}),this.domManager.setCursor("row-resize")}handleResizeMouseMove(t){const{minColumnWidth:e,maxColumnWidth:i,minRowHeight:s,maxRowHeight:n}=this.options,o=this.stateManager.getResizeColumnState(),r=this.stateManager.getResizeRowState();if(o.isResizing&&o.columnIndex!==null&&o.startX!==null&&o.canvasSnapshot){const a=t.clientX-o.startX,l=o.columnIndex;let d=(o.originalWidth||this.stateManager.getColumnWidth(l))+a;d=Math.max(e,Math.min(d,i)),this.stateManager.setColumnWidth(l,d),this.renderer.renderResizeDivider(o.canvasSnapshot,"column",l,d)}else if(r.isResizing&&r.rowIndex!==null&&r.startY!==null&&r.canvasSnapshot){const a=t.clientY-r.startY,l=r.rowIndex;let d=(r.originalHeight||this.stateManager.getRowHeight(l))+a;d=Math.max(s,Math.min(d,n)),this.stateManager.setRowHeight(l,d),this.renderer.renderResizeDivider(r.canvasSnapshot,"row",l,d)}}resizeRowsForColumn(){this.dimensionCalculator.autoResizeRowHeights(),this.dimensionCalculator.calculateTotalSize(),this.dimensionCalculator.calculateVisibleRange(),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.renderer.draw()}columnWidthMapByKeys(){return Object.fromEntries(Array.from(this.stateManager.getColumnWidths().entries()).map(([t,e])=>[this.stateManager.getColumnKey(t),e]))}endResize(){var i,s;const t=this.stateManager.getResizeColumnState(),e=this.stateManager.getResizeRowState();if(t.isResizing){m("log",this.options.verbose,`Finished column resize for index ${t.columnIndex}. New width: ${this.stateManager.getColumnWidth(t.columnIndex)}`),this.dimensionCalculator.calculateTotalSize(),this.options.autoResizeRowHeight&&t.columnIndex!==null?this.resizeRowsForColumn():(this.dimensionCalculator.calculateVisibleRange(),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.renderer.draw()),this.stateManager.setResizeColumnState({isResizing:!1,columnIndex:null,startX:null,canvasSnapshot:void 0,originalWidth:void 0});try{(s=(i=this.options).onColumnWidthsChange)==null||s.call(i,this.columnWidthMapByKeys())}catch(n){m("error",this.options.verbose,"Error calling onColumnWidthsChange",n)}}e.isResizing&&(m("log",this.options.verbose,`Finished row resize for index ${e.rowIndex}. New height: ${this.stateManager.getRowHeight(e.rowIndex)}`),this.dimensionCalculator.calculateTotalSize(),this.dimensionCalculator.calculateVisibleRange(),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.renderer.draw(),this.stateManager.setResizeRowState({isResizing:!1,rowIndex:null,startY:null,canvasSnapshot:void 0,originalHeight:void 0}))}updateCursorStyle(t){if(this.stateManager.isResizing()||this.stateManager.isDraggingFillHandle())return;const e=this.domManager.getCanvasBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,{headerHeight:n,rowNumberWidth:o,resizeHandleSize:r,defaultRowHeight:a,defaultColumnWidth:l}=this.options;let h,d;s<n&&i>=o?(h=i-o+this.stateManager.getScrollLeft(),d=s):i<o&&s>=n?(h=i,d=s-n+this.stateManager.getScrollTop()):i>=o&&s>=n?(h=i-o+this.stateManager.getScrollLeft(),d=s-n+this.stateManager.getScrollTop()):(h=i,d=s);const g=this.stateManager.getColumns(),c=this.stateManager.dataLength,u=this.stateManager.getColumnWidths(),p=this.stateManager.getRowHeights();let M="default";if(s<n&&i>=o){let C=0;for(let w=0;w<g.length;w++){const S=u.get(w)||l,b=C+S;if(Math.abs(h-b)<=r){M="col-resize";break}if(C+=S,C>h+r)break}}if(M==="default"&&i<o&&s>=n){let C=0;for(let w=0;w<c;w++){const S=p.get(w)||a,b=C+S;if(Math.abs(d-b)<=r){M="row-resize";break}if(C+=S,C>d+r)break}}const f=this.stateManager.getActiveCell();if(M==="default"&&f&&f.row!==null&&f.col!==null&&!this.stateManager.getActiveEditor()&&i>=o&&s>=n){const C=this.renderer.getFillHandleBounds(f.row,f.col);C&&h>=C.x&&h<=C.x+C.width&&d>=C.y&&d<=C.y+C.height&&(M="crosshair")}this.domManager.setCursor(M)}checkFillHandle(t){const e=this.stateManager.getActiveCell();if(!e||this.stateManager.getActiveEditor()||this.stateManager.isResizing()||e.row===null||e.col===null)return!1;const i=this.renderer.getFillHandleBounds(e.row,e.col);if(!i)return!1;const s=this.domManager.getCanvasBoundingClientRect(),{headerHeight:n,rowNumberWidth:o}=this.options,r=t.clientX-s.left,a=t.clientY-s.top;let l,h;if(r>=o&&a>=n)l=r-o+this.stateManager.getScrollLeft(),h=a-n+this.stateManager.getScrollTop();else return!1;return l>=i.x&&l<=i.x+i.width&&h>=i.y&&h<=i.y+i.height?(this._startFillHandleDrag(e),!0):!1}_startFillHandleDrag(t){t.row===null||t.col===null||(this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown(),this.stateManager.setDragState({isDragging:!0,startCell:{...t},endRow:t.row}),this.domManager.setCursor("crosshair"),m("log",this.options.verbose,"Started dragging fill handle from",t))}handleFillHandleMouseMove(t){if(!this.stateManager.isDraggingFillHandle())return;const e=this.stateManager.getDragStartCell();if(!e||e.row===null)return;const i=this.domManager.getCanvasBoundingClientRect(),{headerHeight:s,rowNumberWidth:n,defaultRowHeight:o}=this.options,r=t.clientY-i.top;if(r<s){this.stateManager.setDragState({isDragging:!0,startCell:e,endRow:0}),this.renderer.draw();return}const a=r-s+this.stateManager.getScrollTop(),l=this.stateManager.getRowHeights(),h=this.stateManager.dataLength;let d=null,g=0;for(let u=0;u<h;u++){const p=l.get(u)||o;if(a>=g&&a<g+p){d=u;break}if(g+=p,g>a)break}let c=this.stateManager.getDragEndRow();d!==null?c=d:c=h-1,c!==this.stateManager.getDragEndRow()&&(this.stateManager.setDragState({isDragging:!0,startCell:e,endRow:c}),this.renderer.draw())}endFillHandleDrag(){if(!this.stateManager.isDraggingFillHandle())return;const t=this.stateManager.getDragEndRow();m("log",this.options.verbose,"Finished dragging fill handle to row",t),this._performFill(),this.stateManager.setDragState({isDragging:!1,startCell:null,endRow:null})}_performFill(){const t=this.stateManager.getDragState();if(!t.isDragging||!t.startCell||t.endRow===null||t.startCell.row===null)return;const{verbose:e,autoResizeRowHeight:i}=this.options,s=t.startCell,n=t.endRow,o=s.row,r=s.col;if(r===null||o===null)return;const a=this.stateManager.getCellData(o,r),l=this.stateManager.getSchemaForColumn(r),h=this.stateManager.getColumnKey(r),d=l==null?void 0:l.type;let g=!1;const c=this.stateManager.dataLength,u=n>=o,p=u?o+1:n,M=u?n:o-1,f=[],C=[];for(let w=p;w<=M;w++){if(w<0||w>=c)continue;const S=this.stateManager.getSchemaForColumn(r);if(this.stateManager.isCellDisabled(w,r)){m("log",e,`Skipping fill for disabled cell ${w},${r}`);continue}if((S==null?void 0:S.type)!==d){m("log",e,`Skipping fill for row ${w}: Type mismatch (Source: ${d}, Target: ${S==null?void 0:S.type})`);continue}if(this.stateManager.getCellData(w,r)!==a){const v=this.stateManager.updateCellInternal(w,r,a);f.push(w),C.push({[h]:v}),g=!0}}g&&(i?this.resizeRowsForColumn():this.renderer.draw()),f.length>0&&this._batchUpdateCellsAndNotify(f,[h],C)}_batchUpdateCellsAndNotify(t,e,i){if(!t||t.length===0)return;const s=[];t.forEach((n,o)=>{this.stateManager.updateDisabledStatesForRow(n),s.push({rowIndex:n,columnKeys:e,data:this.stateManager.getRowData(n),oldData:i==null?void 0:i[o]})}),s.length>0&&this.stateManager.callOnCellsUpdate(s)}copy(){var s,n,o;const t=this.stateManager.getActiveCell(),e=this.stateManager.getNormalizedSelectionRange();let i=!1;if(e){const{start:r,end:a}=e,l=[];let h=!0,d;for(let g=r.row;g<=a.row;g++){const c=[];for(let u=r.col;u<=a.col;u++){const p=this.stateManager.getCellData(g,u);c.push(p);const M=(s=this.stateManager.getSchemaForColumn(u))==null?void 0:s.type;g===r.row&&u===r.col?d=M:M!==d&&(h=!1)}l.push(c)}h||m("warn",this.options.verbose,"Copied range contains mixed data types."),i=this.stateManager.setCopiedRange(l,e),m("log",this.options.verbose,`Copied range data [${l.length}x${(n=l[0])==null?void 0:n.length}] from source range [${r.row},${r.col}] -> [${a.row},${a.col}]`)}else if(t&&t.row!==null&&t.col!==null){const{row:r,col:a}=t,l=this.stateManager.getCellData(r,a),h=(o=this.stateManager.getSchemaForColumn(a))==null?void 0:o.type;i=this.stateManager.setCopiedValue(l,h,{...t}),i&&m("log",this.options.verbose,`Copied value: ${l} (Type: ${h}) from cell ${r},${a}`)}return i}paste(){if(this.lastPasteHandledAt&&Date.now()-this.lastPasteHandledAt.getTime()<1e3)return!1;this.lastPasteHandledAt=new Date,m("log",this.options.verbose,"Paste requested by keyboard shortcut");const t=this.stateManager.getActiveCell(),e=this.stateManager.getNormalizedSelectionRange(),i=this.stateManager.getCopiedValue(),s=this.stateManager.getCopiedValueType(),n=this.stateManager.getCopiedRangeData(),o=e,r=!o&&t?t:null;return!o&&!r?(m("log",this.options.verbose,"Paste ignored: No target cell or range selected."),!1):n?(m("log",this.options.verbose,"Pasting range data"),o?this._pasteRangeToRange(o,n):r&&r.row!==null&&r.col!==null?this._pasteRangeFromTopLeft(r,n):!1):i!==void 0?(m("log",this.options.verbose,"Pasting single value"),o?this._pasteSingleValueToRange(o,i,s):r&&r.row!==null&&r.col!==null?this._pasteSingleValue(r,i,s):!1):(m("log",this.options.verbose,"Nothing to paste."),!1)}_pasteSingleValue(t,e,i){if(t.row===null||t.col===null)return!1;const s=t.row,n=t.col,o=this.stateManager.getColumnKey(n),r=this.stateManager.getSchemaForColumn(n);if(this.stateManager.isCellDisabled(s,n))return m("log",this.options.verbose,`Paste cancelled: Target cell ${s},${n} is disabled.`),!1;if((r==null?void 0:r.type)!==i&&e!==null){m("log",this.options.verbose,`Type mismatch (Copied: ${i}, Target: ${r==null?void 0:r.type}) - attempting conversion.`);const h=this._convertValueForTargetType(e,o,r);if(h===null)return m("log",this.options.verbose,"Paste cancelled: Cannot convert value between types."),!1;e=h}const a=this.stateManager.getCellData(s,n),l=N(e,r,o,this.stateManager.cachedDropdownOptionsByColumn.get(o),this.options.verbose,this.stateManager.getData(!0),s);if("error"in l)return m("log",this.options.verbose,l.error),l.errorType==="required"&&!a?this.stateManager.updateCell(s,`${D}${o}`,l.error):this.renderer.setTemporaryErrors([{row:s,col:n,error:l.error}]),!0;if(this.stateManager.removeCellValue(s,`${D}${o}`),a!==e){const h=this.stateManager.updateCellInternal(s,n,e);return this._batchUpdateCellsAndNotify([s],[o],[{[o]:h}]),m("log",this.options.verbose,`Pasted value ${e} to cell ${s},${n}`),!0}return!1}_pasteSingleValueToRange(t,e,i){let s=!1;const n=[],o=[],r=new Map;for(let a=t.start.row;a<=t.end.row;a++)for(let l=t.start.col;l<=t.end.col;l++){const h=this.stateManager.getColumnKey(l),d=this.stateManager.getSchemaForColumn(l);if(this.stateManager.isCellDisabled(a,l))continue;let g=e;if((d==null?void 0:d.type)!==i&&e!==null&&(g=this._convertValueForTargetType(e,h,d),g===null))continue;const c=this.stateManager.getCellData(a,l),u=N(g,d,h,this.stateManager.cachedDropdownOptionsByColumn.get(h),this.options.verbose,this.stateManager.getData(!0),a);if("error"in u){m("warn",this.options.verbose,u.error),u.errorType==="required"&&!c?this.stateManager.updateCell(a,`${D}${h}`,u.error):this.renderer.setTemporaryErrors([{row:a,col:l,error:u.error}]),s=!0;continue}else this.stateManager.removeCellValue(a,`${D}${h}`);if(c!==g){const p=this.stateManager.updateCellInternal(a,l,g);n.push(a),o.push(h),r.set(a,{...r.get(a),[h]:p}),s=!0}}return n.length>0&&(this._batchUpdateCellsAndNotify(n,o,n.map(a=>r.get(a))),m("log",this.options.verbose,`Pasted single value to range [${t.start.row},${t.start.col}] -> [${t.end.row},${t.end.col}]`)),s}_convertValueForTargetType(t,e,i){const s=i==null?void 0:i.type;if(t==null||s===void 0)return null;if(Array.isArray(t))return i!=null&&i.multiple?t.map(o=>this._convertValueForTargetType(o,e,{...i,multiple:!1})).filter(o=>o!==null):t.length>0?this._convertValueForTargetType(t[0],e,i):null;if(s==="text"||s==="email")return i!=null&&i.autoTrim?String(t).trim():String(t);const n=String(t).trim();if(n==="")return null;switch(s){case"number":const o=parseFloat(n);return isNaN(o)?null:o;case"boolean":if(typeof t=="boolean")return t;const r=n.toLowerCase();return["true","yes","1","y"].includes(r)?!0:["false","no","0","n"].includes(r)?!1:null;case"date":if(t instanceof Date)return t.toISOString().split("T")[0];try{const h=new Date(t);if(!isNaN(h.getTime()))return h.toISOString().split("T")[0]}catch{}return null;case"select":const a=this.stateManager.cachedDropdownOptionsByColumn.get(e);if(!a)return null;if(a.has(t))return t;if(typeof t!="string"&&a.has(n))return n;const l=Array.from(a.entries()).find(([h,d])=>d.toLowerCase()===n.toLowerCase());return i!=null&&i.multiple&&l?[l[0]]:l?l[0]:null;default:return null}}_pasteRangeFromTopLeft(t,e){var c;if(t.row===null||t.col===null||!e||e.length===0)return!1;const i=t.row,s=t.col,n=e.length,o=((c=e[0])==null?void 0:c.length)||0;let r=!1;const a=this.stateManager.dataLength,l=this.stateManager.getColumns().length,h=[],d=new Set,g=new Map;for(let u=0;u<n;u++){const p=i+u;if(p>=a)break;const M=e[u];let f=!1;for(let C=0;C<o;C++){const w=s+C;if(w>=l)break;const S=M[C],b=this.stateManager.getColumnKey(w),x=this.stateManager.getSchemaForColumn(w);if(this.stateManager.isCellDisabled(p,w))continue;let v=S;if(v!==null&&(v=this._convertValueForTargetType(S,b,x),v===null))continue;const T=this.stateManager.getCellData(p,w),E=N(v,x,b,this.stateManager.cachedDropdownOptionsByColumn.get(b),this.options.verbose,this.stateManager.getData(!0),p);if("error"in E){m("warn",this.options.verbose,E.error),E.errorType==="required"&&!T?this.stateManager.updateCell(p,`${D}${b}`,E.error):this.renderer.setTemporaryErrors([{row:p,col:w,error:E.error}]),r=!0;continue}else this.stateManager.removeCellValue(p,`${D}${b}`);if(T!==v){const R=this.stateManager.updateCellInternal(p,w,v);f=!0,d.add(b),g.set(p,{...g.get(p),[b]:R})}}f&&(h.push(p),r=!0)}return h.length>0&&(this._batchUpdateCellsAndNotify(h,Array.from(d),h.map(u=>g.get(u))),m("log",this.options.verbose,`Pasted range [${n}x${o}] starting at ${i},${s}`)),r}_pasteRangeToRange(t,e){var l;if(!e||e.length===0)return!1;const i=e.length,s=((l=e[0])==null?void 0:l.length)||0;if(s===0)return!1;let n=!1;const o=[],r=new Set,a=new Map;for(let h=t.start.row;h<=t.end.row;h++){let d=!1;for(let g=t.start.col;g<=t.end.col;g++){const c=(h-t.start.row)%i,u=(g-t.start.col)%s,p=e[c][u],M=this.stateManager.getColumnKey(g),f=this.stateManager.getSchemaForColumn(g);if(this.stateManager.isCellDisabled(h,g))continue;let C=p;if(C!==null&&(C=this._convertValueForTargetType(p,M,f),C===null))continue;const w=this.stateManager.getCellData(h,g),S=N(C,f,M,this.stateManager.cachedDropdownOptionsByColumn.get(M),this.options.verbose,this.stateManager.getData(!0),h);if("error"in S){m("warn",this.options.verbose,S.error),S.errorType==="required"&&!w?this.stateManager.updateCell(h,`${D}${M}`,S.error):this.renderer.setTemporaryErrors([{row:h,col:g,error:S.error}]),n=!0;continue}else this.stateManager.removeCellValue(h,`${D}${M}`);if(w!==C){const b=this.stateManager.updateCellInternal(h,g,C);d=!0,r.add(M),a.set(h,{...a.get(h),[M]:b})}}d&&(o.push(h),n=!0)}return o.length>0&&(this._batchUpdateCellsAndNotify(o,Array.from(r),o.map(h=>a.get(h))),m("log",this.options.verbose,`Pasted range pattern into target range [${t.start.row},${t.start.col}] -> [${t.end.row},${t.end.col}]`)),n}clearCopiedCell(){return this.stateManager.clearCopyState()}deleteSelectedRows(){var n,o;const t=this.stateManager.getSelectedRows();if(t.size===0)return!1;const e=Array.from(t);m("log",this.options.verbose,"Deleting rows:",e);const i=e.map(r=>this.stateManager.getRowData(r)).filter(r=>r);let s=this.stateManager.deleteRows(e);try{(o=(n=this.options).onRowDeleted)==null||o.call(n,i)}catch(r){m("error",this.options.verbose,`Error calling onRowDeleted: ${r}`)}return s>0?(this.clearSelections(),this.stateManager.setActiveCell(null),this.clearCopiedCell(),this.triggerCustomEvent("resize"),!0):!1}startSelectionDrag(t){if(t.row===null||t.col===null)return!1;let e=!1;this.stateManager.setDraggingSelection(!0);const i=this.stateManager.setActiveCell(t),s=this.stateManager.setSelectionRange(t,t);e=i||s;let n=!1;return e&&(n=this.clearSelections()),e||n?(m("log",this.options.verbose,`Started selection drag at ${t.row},${t.col}`),!0):!1}updateSelectionDrag(t){if(!this.stateManager.getIsDraggingSelection()||!this.stateManager.getSelectionStartCell()||t.row===null||t.col===null)return!1;const e=this.stateManager.getSelectionEndCell();return(e==null?void 0:e.row)!==t.row||(e==null?void 0:e.col)!==t.col?(m("log",this.options.verbose,`Updating selection drag to ${t.row},${t.col}`),this.stateManager.setSelectionRange(this.stateManager.getSelectionStartCell(),t)):!1}endSelectionDrag(){this.stateManager.getIsDraggingSelection()&&(m("log",this.options.verbose,`Ended selection drag. Final range: ${JSON.stringify(this.stateManager.getNormalizedSelectionRange())}`),this.stateManager.setDraggingSelection(!1))}moveActiveCell(t,e,i=!0){const{verbose:s,autoAddNewRow:n}=this.options;if(!this.editingManager)return m("warn",s,"EditingManager not set, cannot move active cell."),!1;const o=n&&i,r=this.stateManager.getActiveCell();if(!r||r.row===null||r.col===null)return!1;let a=r.row,l=r.col,h=this.stateManager.dataLength;const d=this.stateManager.getColumns().length;let g=a+t,c=l+e;if(c>=d?(c=0,g++):c<0&&(c=d-1,g--),g<0||g>=h&&!o)return this.editingManager.deactivateEditor(!0),this.stateManager.setActiveCell(null),m("log",s,"Reached grid boundary, deactivating editor."),!0;g===h&&o&&(g=this.stateManager.addRow(),this.triggerCustomEvent("resize"),h++);let u=g*d+c;const p=h*d;for(;this.stateManager.isCellDisabled(g,c)&&u<p;)if(u++,g+=t,c+=e,c>=d?(c=0,g++):c<0&&(c=d-1,g--),g<0||g>=h)return this.editingManager.deactivateEditor(!0),this.stateManager.setActiveCell(null),m("warn",s,"Could not find next editable cell in direction."),!0;if(u>=p)return m("warn",s,"Max search limit reached while finding next editable cell."),this.editingManager.deactivateEditor(!0),this.stateManager.setActiveCell(null),!0;if(this.stateManager.setActiveCell({row:g,col:c}),i)this.editingManager.activateEditor(g,c);else{const M=this.renderer.getCellBounds(g,c);M&&this.bringBoundsIntoView(M)}return!0}pasteSingleValueExternal(t,e){if(t.row===null||t.col===null)return!1;const i=this.stateManager.getSchemaForColumn(t.col);return(i==null?void 0:i.type)!=="text"?(m("log",this.options.verbose,`Clipboard paste cancelled: Target cell ${t.row},${t.col} is not type 'text'.`),!1):this._pasteSingleValue(t,e,"text")}pasteRangeFromTopLeftExternal(t,e){var g;if(t.row===null||t.col===null||!e||e.length===0)return!1;const i=t.row,s=t.col,n=e.length,o=((g=e[0])==null?void 0:g.length)||0;let r=!1;const a=this.stateManager.dataLength,l=this.stateManager.getColumns().length,h=[],d=new Set;for(let c=0;c<n;c++){const u=i+c;if(u>=a)break;const p=e[c];let M=!1;for(let f=0;f<o;f++){const C=s+f;if(C>=l)break;const w=p[f],S=this.stateManager.getColumnKey(C),b=this.stateManager.getSchemaForColumn(C);if(this.stateManager.isCellDisabled(u,C))continue;if((b==null?void 0:b.type)!=="text"){m("log",this.options.verbose,`Clipboard paste range: Target cell ${u},${C} is not type 'text'. Skipping.`);continue}const x=this.stateManager.getCellData(u,C),v=N(w,b,S,this.stateManager.cachedDropdownOptionsByColumn.get(S),this.options.verbose,this.stateManager.getData(!0),u);if("error"in v){m("warn",this.options.verbose,v.error),v.errorType==="required"&&!x?this.stateManager.updateCell(u,`${D}${S}`,v.error):this.renderer.setTemporaryErrors([{row:u,col:C,error:v.error}]),r=!0;continue}else this.stateManager.removeCellValue(u,`${D}${S}`);x!==w&&(this.stateManager.updateCellInternal(u,C,w),M=!0,d.add(S))}M&&(h.push(u),r=!0)}return h.length>0&&(this._batchUpdateCellsAndNotify(h,Array.from(d)),m("log",this.options.verbose,`Pasted external range [${n}x${o}] starting at ${i},${s}`)),r}pasteRangeToRangeExternal(t,e){var a;if(!e||e.length===0)return!1;const i=e.length,s=((a=e[0])==null?void 0:a.length)||0;if(s===0)return!1;let n=!1;const o=[],r=new Set;for(let l=t.start.row;l<=t.end.row;l++){let h=!1;for(let d=t.start.col;d<=t.end.col;d++){const g=(l-t.start.row)%i,c=(d-t.start.col)%s,u=e[g][c],p=this.stateManager.getColumnKey(d),M=this.stateManager.getSchemaForColumn(d);if(this.stateManager.isCellDisabled(l,d))continue;const f=this._convertValueForTargetType(u,p,M);if(f===null)continue;const C=this.stateManager.getCellData(l,d),w=N(f,M,p,this.stateManager.cachedDropdownOptionsByColumn.get(p),this.options.verbose,this.stateManager.getData(!0),l);if("error"in w){m("warn",this.options.verbose,w.error),w.errorType==="required"&&!C?this.stateManager.updateCell(l,`${D}${p}`,w.error):this.renderer.setTemporaryErrors([{row:l,col:d,error:w.error}]),n=!0;continue}else this.stateManager.removeCellValue(l,`${D}${p}`);C!==f&&(this.stateManager.updateCellInternal(l,d,f),h=!0,r.add(p))}h&&(o.push(l),n=!0)}return o.length>0&&(this._batchUpdateCellsAndNotify(o,Array.from(r)),m("log",this.options.verbose,`Pasted external range pattern into target range [${t.start.row},${t.start.col}] -> [${t.end.row},${t.end.col}]`)),n}pasteToColumnExternal(t,e){m("log",this.options.verbose,`External paste to entire column ${t}`);const i=this.stateManager.getSchemaForColumn(t),s=this.stateManager.dataLength;let n=!1;if(e==null)return m("log",this.options.verbose,"No value to paste to column"),!1;const o=this.stateManager.getColumnKey(t),r=this._convertValueForTargetType(e,o,i),a=[];for(let l=0;l<s;l++){if(this.stateManager.isCellDisabled(l,t))continue;this.stateManager.getCellData(l,t)!==r&&(this.stateManager.updateCellInternal(l,t,r),n=!0,a.push(l))}return n&&(this._batchUpdateCellsAndNotify(a,[o]),this.renderer.draw()),n}}class Vt{constructor(t,e){this.columnWidths=new Map,this.rowHeights=new Map,this.userResizedRows=new Map,this.scrollTop=0,this.scrollLeft=0,this.viewportWidth=0,this.viewportHeight=0,this.totalContentWidth=0,this.totalContentHeight=0,this.visibleRowStartIndex=0,this.visibleRowEndIndex=0,this.visibleColStartIndex=0,this.visibleColEndIndex=0,this.activeCell=null,this.selectionStartCell=null,this.selectionEndCell=null,this.isDraggingSelection=!1,this.activeEditor=null,this.selectedRows=new Set,this.lastClickedRow=null,this.selectedColumn=null,this.copiedValue=void 0,this.copiedValueType=void 0,this.copiedCell=null,this.copiedRangeData=null,this.copiedSourceRange=null,this.dragState={isDragging:!1,startCell:null,endRow:null},this.resizeColumnState={isResizing:!1,columnIndex:null,startX:null},this.resizeRowState={isResizing:!1,rowIndex:null,startY:null},this.asyncOperationCounter=-1,this.cachedDropdownOptionsByColumn=new Map,this.options=e,this.data=[],this.schema=t,this.columns=Object.keys(t),this._addCachedDropdownOptions()}setSchema(t){this.schema=t,this.columns=Object.keys(t),this.columnWidths=new Map,this._addCachedDropdownOptions()}addCachedDropdownOptionForColumn(t,e){const i=this.schema[t],s=e||i.values;if(i.type!=="select"||!s)return;const n=new Map(s.map(r=>[r.id,r.name]));let o=this.cachedDropdownOptionsByColumn.get(t);o!=null&&o.size?o=new Map([...o,...n]):o=n,this.cachedDropdownOptionsByColumn.set(t,o)}_addCachedDropdownOptions(){const t=Object.keys(this.schema).filter(e=>this.schema[e].type==="select");if(t.length)for(const e of t)this.addCachedDropdownOptionForColumn(e)}setInitialData(t){this.data=JSON.parse(JSON.stringify(t||[])),this._updateAllDisabledStates()}get dataLength(){return this.data.length}getData(t=!1){return t?this.data:JSON.parse(JSON.stringify(this.data,(e,i)=>{if(!(typeof e=="string"&&e.startsWith(ot)))return i}))}setData(t){this.data=JSON.parse(JSON.stringify(t||[])),this.rowHeights=new Map,this.userResizedRows=new Map,this._updateAllDisabledStates(),this.resetInteractionState()}updateColumnSchema(t,e){this.schema[t]={...this.schema[t],...e},e.values&&this.addCachedDropdownOptionForColumn(t,e.values),this._updateAllDisabledStates(),this.resetInteractionState()}clearAllSelections(){this.activeCell=null,this.selectionStartCell=null,this.selectionEndCell=null,this.isDraggingSelection=!1,this.selectedRows=new Set,this.selectedColumn=null,this.lastClickedRow=null,this.copiedValue=void 0,this.copiedValueType=void 0,this.copiedCell=null}updateCellInternal(t,e,i){if(t<0||t>=this.data.length||e<0||e>=this.columns.length){m("warn",this.options.verbose,`updateCellInternal: Invalid coordinates (${t}, ${e})`);return}const s=this.columns[e];this.data[t]||(this.data[t]={});const n=this.data[t][s];return this.data[t][s]=i,n}updateCell(t,e,i,s=!1){if(t<0||t>=this.data.length)return m("warn",this.options.verbose,`updateCell: Invalid row index (${t}).`),!1;if(e.includes(":"))return this.data[t][e]=i,!0;if(this.columns.indexOf(e)<0)return m("warn",this.options.verbose,`updateCell: Invalid column key (${e}).`),!1;const o=this.schema[e],r=N(i,o,e,this.cachedDropdownOptionsByColumn.get(e),this.options.verbose,this.data,t);if("error"in r){if(m("warn",this.options.verbose,`updateCell: Validation failed for ${e}. Value not set.`),s)throw new rt({errorMessage:r.error,rowIndex:t,colKey:e,value:i,schema:o,errorType:r.errorType})}else if(this.data[t]||(this.data[t]={}),e.includes(":")||this.removeCellValue(t,`${D}${e}`),this.data[t][e]!==i)return this.data[t][e]=i,this.updateDisabledStatesForRow(t),!0;return!1}removeCellValue(t,e){var s;if(t<0||t>=this.data.length)return m("warn",this.options.verbose,`removeCellValue: Invalid coordinates (${t}, ${e}).`),!1;const i=(s=this.data[t])==null?void 0:s[e];return delete this.data[t][e],!!i}getCellData(t,e){var s;if(t<0||t>=this.data.length||e<0||e>=this.columns.length)return;const i=this.columns[e];return(s=this.data[t])==null?void 0:s[i]}getRowData(t){return this.data[t]}deleteRows(t){let e=0;return t.sort((s,n)=>n-s).forEach(s=>{s>=0&&s<this.data.length&&(this.data.splice(s,1),this.rowHeights.delete(s),e++)}),e>0&&this._updateAllDisabledStates(),e}getSchema(){return this.schema}getColumns(){return this.columns}getColumnKey(t){return this.columns[t]}getSchemaForColumn(t){const e=this.columns[t];return e?this.schema[e]:void 0}getColumnWidths(){return this.columnWidths}getColumnWidth(t){return this.columnWidths.get(t)||this.options.defaultColumnWidth}setColumnWidth(t,e){e===this.options.defaultColumnWidth?this.columnWidths.delete(t):this.columnWidths.set(t,e)}getTotalColumnWidth(){const t=this.options.defaultColumnWidth;let e=this.columns.length*t;return this.columnWidths.forEach(i=>{e+=i-t}),e}getRowHeights(){return this.rowHeights}getTotalRowHeight(){const t=this.options.defaultRowHeight;let e=this.data.length*t;return this.rowHeights.forEach(i=>{e+=i-t}),e}getRowHeight(t){return this.rowHeights.get(t)||this.options.defaultRowHeight}setRowHeight(t,e){e=Math.max(Math.min(e,this.options.maxRowHeight),this.options.minRowHeight),this.rowHeights.get(t)!==e&&(this.rowHeights.set(t,e),this.userResizedRows.set(t,!0))}setAutoRowHeight(t,e){e=Math.max(Math.min(e,this.options.maxRowHeight),this.options.minRowHeight),this.rowHeights.get(t)!==e&&this.rowHeights.set(t,e)}getTotalContentWidth(){return this.totalContentWidth}getTotalContentHeight(){return this.totalContentHeight}updateViewportSize(t,e){this.viewportWidth=t,this.viewportHeight=e}getViewportWidth(){return this.viewportWidth}getViewportHeight(){return this.viewportHeight}updateTotalContentSize(t,e){this.totalContentWidth=t,this.totalContentHeight=e}updateScroll(t,e){this.scrollTop=t,this.scrollLeft=e}getScrollTop(){return this.scrollTop}getScrollLeft(){return this.scrollLeft}updateVisibleRange(t,e,i,s){this.visibleRowStartIndex=t,this.visibleRowEndIndex=e,this.visibleColStartIndex=i,this.visibleColEndIndex=s}getVisibleRowStartIndex(){return this.visibleRowStartIndex}getVisibleRowEndIndex(){return this.visibleRowEndIndex}getVisibleColStartIndex(){return this.visibleColStartIndex}getVisibleColEndIndex(){return this.visibleColEndIndex}getVisibleRange(){return{visibleRowStart:this.visibleRowStartIndex,visibleRowEnd:this.visibleRowEndIndex,visibleColStart:this.visibleColStartIndex,visibleColEnd:this.visibleColEndIndex}}getActiveCell(){return this.activeCell}setActiveCell(t){var i,s;const e=!this.activeCell&&t||this.activeCell&&!t||((i=this.activeCell)==null?void 0:i.row)!==(t==null?void 0:t.row)||((s=this.activeCell)==null?void 0:s.col)!==(t==null?void 0:t.col);return e&&(this.activeCell=t),this.options.onCellSelected&&(t!=null&&t.col)&&(t!=null&&t.row)&&setTimeout(()=>{try{this.options.onCellSelected({rowIndex:t==null?void 0:t.row,colKey:this.getColumnKey(t==null?void 0:t.col),rowData:this.data[t==null?void 0:t.row]})}catch{}},0),!!e}getActiveEditor(){return this.activeEditor}newAsyncJobId(){return this.asyncOperationCounter=(this.asyncOperationCounter+1)%1e6,this.asyncOperationCounter}get currentAsyncJobId(){return this.asyncOperationCounter}setActiveEditor(t){t?this.activeEditor={...t,asyncJobId:this.newAsyncJobId()}:this.activeEditor=null}getSelectedRows(){return this.selectedRows}setSelectedRows(t,e){const i=JSON.stringify(Array.from(this.selectedRows).sort((a,l)=>a-l)),s=JSON.stringify(Array.from(t).sort((a,l)=>a-l)),n=i!==s,o=this.lastClickedRow!==e,r=n||o;return r&&(this.selectedRows=new Set(t),this.lastClickedRow=e),r}getLastClickedRow(){return this.lastClickedRow}getSelectedColumn(){return this.selectedColumn}setSelectedColumn(t){const e=this.selectedColumn!==t;return e&&(this.selectedColumn=t),e}getCopiedValue(){return this.copiedValue}getCopiedValueType(){return this.copiedValueType}getCopiedCell(){return this.copiedCell}setCopiedValue(t,e,i){const s=JSON.stringify(this.copiedCell)!==JSON.stringify(i),n=this.copiedRangeData!==null,o=this.copiedSourceRange!==null;return this.copiedValue=t,this.copiedValueType=e,this.copiedCell=i,this.copiedRangeData=null,this.copiedSourceRange=null,s||n||o}setCopiedRange(t,e){const i=JSON.stringify(this.copiedRangeData)!==JSON.stringify(t),s=JSON.stringify(this.copiedSourceRange)!==JSON.stringify(e),n=this.copiedCell!==null;return this.copiedRangeData=t,this.copiedSourceRange=e,this.copiedValue=void 0,this.copiedValueType=void 0,this.copiedCell=null,i||s||n}getCopiedRangeData(){return this.copiedRangeData}getCopiedSourceRange(){return this.copiedSourceRange}isCopyActive(){return this.copiedCell!==null||this.copiedRangeData!==null}clearCopyState(){return this.setCopiedValue(void 0,void 0,null)}getDragState(){return this.dragState}setDragState(t){this.dragState=t}isDraggingFillHandle(){return this.dragState.isDragging}getDragStartCell(){return this.dragState.startCell}getDragEndRow(){return this.dragState.endRow}getResizeColumnState(){return this.resizeColumnState}setResizeColumnState(t){this.resizeColumnState=t}getResizeRowState(){return this.resizeRowState}setResizeRowState(t){this.resizeRowState=t}isResizing(){return this.resizeColumnState.isResizing||this.resizeRowState.isResizing}resetInteractionState(){this.activeCell=null,this.selectionStartCell=null,this.selectionEndCell=null,this.isDraggingSelection=!1,this.activeEditor=null,this.selectedRows=new Set,this.selectedColumn=null,this.lastClickedRow=null,this.copiedValue=void 0,this.copiedValueType=void 0,this.copiedCell=null,this.copiedRangeData=null,this.copiedSourceRange=null,this.dragState={isDragging:!1,startCell:null,endRow:null},this.resizeColumnState={isResizing:!1,columnIndex:null,startX:null},this.resizeRowState={isResizing:!1,rowIndex:null,startY:null}}isCellDisabled(t,e){if(t<0||t>=this.data.length||e<0||e>=this.columns.length)return!0;const i=this.columns[e],s=this.data[t];return!!(s!=null&&s[`${ot}${i}`])}updateDisabledStatesForRow(t){if(t<0||t>=this.data.length)return!1;const e=this.data[t];if(!e)return!1;let i=!1;return this.columns.forEach(s=>{const n=`${ot}${s}`,o=!!e[n],r=this.schema[s];if(!(r!=null&&r.disabled))return;const a=r.disabled(e,t);o!==a&&(e[n]=a,i=!0)}),i}callOnCellsUpdate(t){var e,i;(i=(e=this.options).onCellsUpdate)==null||i.call(e,t)}_updateAllDisabledStates(){m("log",this.options.verbose,"Updating all disabled states...");for(let t=0;t<this.data.length;t++)this.updateDisabledStatesForRow(t);m("log",this.options.verbose,"Finished updating all disabled states.")}getSelectionStartCell(){return this.selectionStartCell}getSelectionEndCell(){return this.selectionEndCell}setSelectionRange(t,e){const i=JSON.stringify(this.selectionStartCell)!==JSON.stringify(t),s=JSON.stringify(this.selectionEndCell)!==JSON.stringify(e),n=i||s;return n&&(this.selectionStartCell=t,this.selectionEndCell=e),n}clearSelectionRange(){return this.setSelectionRange(null,null)}getNormalizedSelectionRange(){if(!this.selectionStartCell||!this.selectionEndCell||this.selectionStartCell.row===null||this.selectionStartCell.col===null||this.selectionEndCell.row===null||this.selectionEndCell.col===null)return null;const t=Math.min(this.selectionStartCell.row,this.selectionEndCell.row),e=Math.min(this.selectionStartCell.col,this.selectionEndCell.col),i=Math.max(this.selectionStartCell.row,this.selectionEndCell.row),s=Math.max(this.selectionStartCell.col,this.selectionEndCell.col);return{start:{row:t,col:e},end:{row:i,col:s}}}isMultiCellSelectionActive(){return!!this.selectionStartCell&&!!this.selectionEndCell}setDraggingSelection(t){this.isDraggingSelection=t}getIsDraggingSelection(){return this.isDraggingSelection}addRow(){const t={};this.columns.forEach(i=>{if(i.includes(ot))return;const s=this.schema[i];if((s==null?void 0:s.defaultValue)!==void 0){t[i]=s.defaultValue;return}let n=null;if(s)switch(s.type){case"text":case"email":n="";break;case"number":n=0;break;case"boolean":n=!1;break;default:n=null}t[i]=n}),this.data.push(t);const e=this.data.length-1;return this.updateDisabledStatesForRow(e),e}addColumn(t,e){if(this.schema[t])throw new Error(`Column ${t} already exists`);const i=this.columns.length;return this.columns.push(t),this.schema[t]=e,this.addCachedDropdownOptionForColumn(t),i}removeColumn(t){const e=this.columns[t];this.clearAllSelections(),delete this.schema[e],this.columns.splice(t,1),this.columnWidths.delete(t),this.data.forEach(i=>{delete i[e]}),this.cachedDropdownOptionsByColumn.delete(e)}isRowUserResized(t){return this.userResizedRows.get(t)===!0}getUserResizedRows(){return this.userResizedRows}}class zt{constructor(t,e,i=[],s={}){const n=document.getElementById(t);if(!n)throw new Error(`Container element with ID "${t}" not found.`);this.container=n,this.options={...xt,...s},this.stateManager=new Vt(e,this.options),this.domManager=new Rt(this.container),this.dimensionCalculator=new $t(this.options,this.stateManager,this.domManager),this.renderer=new Lt(this.domManager.getContext(),this.options,this.stateManager,this.dimensionCalculator),this.interactionManager=new Wt(this.options,this.stateManager,this.renderer,this.dimensionCalculator,this.domManager),this.interactionManager.bindCustomEvents(o=>{o.type==="resize"&&(this.onDataUpdate(),o.detail&&this.interactionManager.bringBoundsIntoView(o.detail))}),this.editingManager=new kt(this.container,this.options,this.stateManager,this.domManager,this.renderer,this.interactionManager),this.eventManager=new At(this.container,this.editingManager,this.interactionManager,this.stateManager,this.dimensionCalculator,this.renderer,this.options,this.domManager),this.stateManager.setInitialData(i),this.dimensionCalculator.calculateTotalSize(),this.options.autoResizeRowHeight&&i.length&&(this.dimensionCalculator.autoResizeRowHeights(),this.dimensionCalculator.calculateTotalSize()),this.domManager.setup(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight(),this.options.headerHeight,this.options.rowNumberWidth),this.dimensionCalculator.calculateDimensions(this.container.clientWidth,this.container.clientHeight),this.eventManager.bindEvents(),this.draw(),m("log",this.options.verbose,"Spreadsheet initialized")}draw(){this.stateManager.updateScroll(this.domManager.getVScrollPosition(),this.domManager.getHScrollPosition()),this.dimensionCalculator.calculateVisibleRange(),this.renderer.draw()}reCalculate(){this.options.autoResizeRowHeight?(this.dimensionCalculator.autoResizeRowHeights(),this.dimensionCalculator.calculateTotalSize(),this.dimensionCalculator.calculateVisibleRange()):this.dimensionCalculator.calculateTotalSize(),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.domManager.updateScrollbarPositions(this.options.headerHeight,this.options.rowNumberWidth),this.dimensionCalculator.calculateDimensions(this.container.clientWidth,this.container.clientHeight)}onDataUpdate(t=0,e=0){this.reCalculate(),this.interactionManager.moveScroll(e,t,!0),this.draw()}async getData(t){let e=[];{const r=this.stateManager.getData((t==null?void 0:t.raw)??!1);if(t!=null&&t.raw)return Promise.resolve(r);e=Et(r,1e3)}let i=[];const s=this.stateManager.getSchema(),n=new Set(this.stateManager.getColumns()),o=r=>new Promise(a=>{var l,h;if(r>=e.length)return a(!1);for(const d of e[r]){let g=!1,c={};for(const u of Object.keys(d)){if(t!=null&&t.keepErrors&&u.startsWith(D)){c[u]=d[u];continue}if(!(t!=null&&t.keepErrors)&&(u.startsWith(D)||(l=s[u])!=null&&l.required&&(d[u]??"")==="")){g=!0;break}if(!(t!=null&&t.nonLoadingOnly&&u.startsWith(J))){if(t!=null&&t.nonLoadingOnly&&d[`${J}${u}`]){c[u]=((h=s[u])==null?void 0:h.defaultValue)??null;continue}t!=null&&t.visibleColumnsOnly&&!n.has(u)||t!=null&&t.discardOthers&&u.includes(":")||(c[u]=d[u])}}g||i.push(c)}if(r===e.length-1)return a(!0);setTimeout(()=>{a(o(r+1))},0)});return await o(0),i}get rowCount(){return this.stateManager.dataLength}setData(t){this.stateManager.setData(t),this.onDataUpdate()}updateColumnSchema(t,e){this.stateManager.updateColumnSchema(t,e),this.onDataUpdate()}addRow(){const t=this.stateManager.addRow();return this.onDataUpdate(this.container.scrollHeight,0),t}addColumn(t,e){const i=this.stateManager.addColumn(t,e);return this.onDataUpdate(0,this.container.scrollWidth),i}set schema(t){this.stateManager.setSchema(t),this.onDataUpdate()}get schema(){return this.stateManager.getSchema()}removeColumnByIndex(t){const e=this.stateManager.getColumns();if(t<0||t>=e.length)throw new Error(`Column index ${t} is out of bounds`);this.stateManager.removeColumn(t),this.onDataUpdate(0,this.container.scrollWidth)}removeColumnByKey(t){const e=this.stateManager.getColumns().indexOf(t);if(e<0)throw new Error(`Column key ${t} not found`);this.removeColumnByIndex(e)}updateCell({rowIndex:t,colKey:e,value:i,flashError:s,remove:n}){let o=!1;try{if(n)this.stateManager.removeCellValue(t,e);else if(!this.stateManager.updateCell(t,e,i,!0))return;o=!0}catch(a){a instanceof rt?(this.stateManager.updateCell(t,`${D}${e}`,a.message),o=!0):m("warn",this.options.verbose,a)}const r=this.stateManager.getColumns().indexOf(e);s&&r>=0&&this.renderer.setTemporaryErrors([{row:t,col:r,error:s}]),o&&(this.options.autoResizeRowHeight&&this.reCalculate(),this.draw())}updateCells(t){let e=!1;const i=new Set,s=[],n=this.stateManager.getColumns();for(const{rowIndex:o,colKey:r,value:a,flashError:l,remove:h}of t){const d=n.indexOf(r);try{if(h)this.stateManager.removeCellValue(o,r);else if(!this.stateManager.updateCell(o,r,a,!0))continue;i.add(o),e=!0,l&&d>=0&&s.push({row:o,col:d,error:l})}catch(g){g instanceof rt?(this.stateManager.updateCell(o,`${D}${r}`,g.message),e=!0):m("warn",this.options.verbose,g)}}return s.length&&this.renderer.setTemporaryErrors(s),e&&(this.options.autoResizeRowHeight&&this.reCalculate(),this.draw()),Array.from(i)}getSelectedCell(){const t=this.stateManager.getActiveCell();return!t||!t.row||!t.col?null:{row:t.row,colKey:this.stateManager.getColumnKey(t.col)}}getRow(t){const e=this.stateManager.getRowData(t);return e?JSON.parse(JSON.stringify(e)):null}getColumns(){return this.stateManager.getColumns().slice()}getColumnWidths(){return this.interactionManager.columnWidthMapByKeys()}setColumnWidths(t){Object.entries(t).forEach(([e,i])=>{const s=this.stateManager.getColumns().indexOf(e);s>=0&&this.stateManager.setColumnWidth(s,i)}),this.redraw()}focus(){this.domManager.focusContainer(!1)}setValueFromCustomEditor({rowIndex:t,colKey:e,value:i}){this.focus(),this.editingManager.isEditorActive()&&this.editingManager.deactivateEditor(!1,!0,!0);const s=this.stateManager.getColumns().indexOf(e);s>=0&&this.stateManager.setActiveCell({row:t,col:s}),this.updateCell({rowIndex:t,colKey:e,value:i})}deactivateCustomEditor(t){if(this.focus(),this.editingManager.deactivateEditor(!1,!0,!0),!t)return;const e=this.stateManager.getColumns().indexOf(t.colKey);e<0||(this.stateManager.setActiveCell({row:t.rowIndex,col:e}),this.draw())}redraw(){this.options.autoResizeRowHeight&&this.reCalculate(),this.draw()}}export{zt as S};
