(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=e(n);fetch(n.href,s)}})();class tt extends Error{constructor({errorMessage:t,rowIndex:e,colKey:i,value:n,schema:s,errorType:r}){super(t),this.rowIndex=e,this.colKey=i,this.value=n,this.schema=s,this.errorType=r}}const pt={defaultColumnWidth:150,defaultRowHeight:30,minColumnWidth:50,maxColumnWidth:500,minRowHeight:20,maxRowHeight:150,headerHeight:35,rowNumberWidth:50,font:"14px Inter, sans-serif",headerFont:"bold 14px Inter, sans-serif",padding:5,textAlign:"left",textBaseline:"middle",textColor:"#111827",placeholderTextColor:"#9ca3af",loadingTextColor:"#3b82f6",errorTextColor:"#b91c1c",cellBgColor:"#ffffff",activeCellBgColor:"#eff6ff",errorCellBgColor:"#fca5a5",selectedRowBgColor:"#f3f4f6",selectedRangeBgColor:"#e0e7ff",headerTextColor:"#ffffff",selectedHeaderTextColor:"#000000",headerBgColor:"#4b5563",customHeaderBgColor:"#9ca3af",selectedHeaderBgColor:"#dbeafe",readonlyHeaderBgColor:"#f3f4f6",readonlyHeaderTextColor:"#9ca3af",headerClipText:!0,headerTextAlign:"center",gridLineColor:"#d1d5db",rowNumberBgColor:"#f3f4f6",selectedRowNumberBgColor:"#dbeafe",disabledCellBgColor:"#e5e7eb",disabledCellTextColor:"#9ca3af",highlightBorderColor:"#3b82f6",fillHandleColor:"#3b82f6",fillHandleSize:10,dragRangeBorderColor:"#6b7280",copyHighlightBorderColor:"#1f2937",copyHighlightBorderDash:[4,3],resizeHandleSize:5,temporaryErrorTimeout:2e3,customDatePicker:!1,autoAddNewRow:!0,verbose:!1,onCellsUpdate:null,onCellSelected:null,onEditorOpen:null,onRowDeleted:null,onColumnDelete:null,onLazySearch:null},Q="disabled:";class wt{constructor(t){this.systemScrollbarWidth=0,this.container=t,this.container.style.position="relative",this.container.tabIndex=-1,this.systemScrollbarWidth=this.getSystemScrollbarWidth()+1,this.canvas=document.createElement("canvas");const e=this.canvas.getContext("2d");if(!e)throw new Error("Failed to get 2D context from canvas");this.ctx=e,this.container.appendChild(this.canvas),this.hScrollbar=document.createElement("div"),this.hScrollbar.id="spreadsheet-hscrollbar",this.hScrollbar.style.position="absolute",this.hScrollbar.style.bottom="0",this.hScrollbar.style.left="0",this.hScrollbar.style.width=`calc(100% - ${this.systemScrollbarWidth}px)`,this.hScrollbar.style.overflow="auto",this.container.appendChild(this.hScrollbar),this.vScrollbar=document.createElement("div"),this.vScrollbar.id="spreadsheet-vscrollbar",this.vScrollbar.style.position="absolute",this.vScrollbar.style.right="0",this.vScrollbar.style.top="0",this.vScrollbar.style.width=`${this.systemScrollbarWidth}px`,this.vScrollbar.style.height=`calc(100% - ${this.systemScrollbarWidth}px)`,this.vScrollbar.style.overflow="auto",this.container.appendChild(this.vScrollbar),this.editorInput=document.createElement("input"),this.editorInput.className="spreadsheet-editor",this.editorInput.style.position="absolute",this.editorInput.style.display="none",this.editorInput.style.boxSizing="border-box",this.container.appendChild(this.editorInput),this.dropdown=document.createElement("div"),this.dropdown.className="spreadsheet-dropdown",this.dropdown.style.position="absolute",this.dropdown.style.display="none",this.dropdown.style.zIndex="100",this.dropdown.style.border="1px solid #ccc",this.dropdown.style.backgroundColor="white",this.dropdown.style.boxShadow="0 2px 5px rgba(0,0,0,0.15)",this.dropdown.style.minHeight="100px",this.dropdown.style.height="200px";const i=document.createElement("div");i.className="spreadsheet-dropdown-search",i.style.padding="5px",i.style.borderBottom="1px solid #eee",this.dropdownSearchInput=document.createElement("input"),this.dropdownSearchInput.type="text",this.dropdownSearchInput.placeholder="Search...",this.dropdownSearchInput.style.width="100%",this.dropdownSearchInput.style.boxSizing="border-box",this.dropdownSearchInput.style.padding="4px",i.appendChild(this.dropdownSearchInput),this.dropdownList=document.createElement("ul"),this.dropdownList.className="spreadsheet-dropdown-list",this.dropdownList.style.listStyle="none",this.dropdownList.style.margin="0",this.dropdownList.style.padding="0",this.dropdownList.style.overflowY="auto",this.dropdownWrapper=document.createElement("div"),this.dropdownWrapper.className="canvas-sheet-dropdown-wrapper",document.body.appendChild(this.dropdownWrapper),this.dropdown.appendChild(i),this.dropdown.appendChild(this.dropdownList),this.dropdownWrapper.appendChild(this.dropdown)}checkEventBoundInDropdown(t){return this.dropdown.contains(t.target)}getSystemScrollbarWidth(){var n;if(this.systemScrollbarWidth)return this.systemScrollbarWidth;const t=document.createElement("div");t.style.visibility="hidden",t.style.overflow="scroll",document.body.appendChild(t);const e=document.createElement("div");t.appendChild(e);const i=t.offsetWidth-t.clientWidth;return(n=t.parentNode)==null||n.removeChild(t),i}setup(t,e){this.updateCanvasSize(t,e)}updateCanvasSize(t,e){this.container.setAttribute("data-width",`${t}`),this.container.setAttribute("data-height",`${e}`),this.hScrollbar.innerHTML=`<div class="placeholder" style="width: ${t}px; height: 1px;"></div>`,this.vScrollbar.innerHTML=`<div class="placeholder" style="width: 1px; height: ${e}px;"></div>`;const i=this.container.clientWidth-this.systemScrollbarWidth,n=this.container.clientHeight-this.systemScrollbarWidth;this.canvas.width=i,this.canvas.height=n,this.canvas.style.width=`${i}px`,this.canvas.style.height=`${n}px`}getHScrollbar(){return this.hScrollbar}getVScrollbar(){return this.vScrollbar}getHScrollPosition(){return this.hScrollbar.scrollLeft}setHScrollPosition(t){return this.hScrollbar.scrollLeft=t,this.hScrollbar.scrollLeft}getVScrollPosition(){return this.vScrollbar.scrollTop}setVScrollPosition(t){return this.vScrollbar.scrollTop=t,this.vScrollbar.scrollTop}canVScrollUp(){return this.vScrollbar.scrollTop>0}canVScrollDown(){return this.vScrollbar.scrollTop+this.vScrollbar.clientHeight<this.vScrollbar.scrollHeight}canHScrollRight(){return this.hScrollbar.scrollLeft+this.hScrollbar.clientWidth<this.hScrollbar.scrollWidth}canHScrollLeft(){return this.hScrollbar.scrollLeft>0}getCanvas(){return this.canvas}getContext(){return this.ctx}getEditorInput(){return this.editorInput}getDropdownElements(){return{dropdown:this.dropdown,searchInput:this.dropdownSearchInput,list:this.dropdownList}}focusContainer(){this.container.focus()}setCursor(t){this.canvas.style.cursor=t}getCanvasBoundingClientRect(){return this.canvas.getBoundingClientRect()}}function p(M,t,...e){!t&&M!=="error"||console[M](...e)}function Ct(M,t,e){if(M==null)return"";switch(t){case"date":try{const i=String(M),n=M instanceof Date?M:new Date(i.includes("T")?i:i+"T00:00:00Z");if(!isNaN(n.getTime()))return n.toLocaleDateString(void 0,{timeZone:"UTC"})}catch(i){p("warn",!1,"Error formatting date value:",M,i)}return String(M);case"boolean":return M===!0?"True":M===!1?"False":"";case"select":if(e){const i=e.get(M);return i||""}return"";case"number":return String(M);case"text":case"email":default:return String(M)}}function mt(M,t){if(M==null)return"";if(t==="date"){try{const e=String(M),i=M instanceof Date?M:new Date(e.includes("T")?e:e+"T00:00:00Z");if(!isNaN(i.getTime())){const n=i.getUTCFullYear(),s=(i.getUTCMonth()+1).toString().padStart(2,"0"),r=i.getUTCDate().toString().padStart(2,"0");return`${n}-${s}-${r}`}}catch(e){p("warn",!1,"Error formatting date for input:",M,e)}return""}return String(M)}function Mt(M,t){if(M==="")return null;switch(t){case"number":const e=parseFloat(M);return isNaN(e)?null:e;case"boolean":return M.toLowerCase()==="true";case"date":return M;case"text":case"email":default:return M}}function z(M,t,e,i,n){if(!t)return{success:!0};const s=t.label||e;if(t.required&&(M==null||M==="")){const r=`Column "${s}" is required.`;return p("warn",n,`Validation failed: ${r}.`),{success:!1,error:r,errorType:"required"}}if(M==null||M==="")return{success:!0};switch(t.type){case"text":if(t.maxlength&&typeof M=="string"&&M.length>t.maxlength){const r=`Column "${s}" exceeds max length of ${t.maxlength}.`;return p("warn",n,`Validation failed: ${r}.`),{success:!1,error:r,errorType:"maxlength"}}break;case"email":if(typeof M!="string"||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(M)){const r=`Invalid email format for column "${s}".`;return p("warn",n,`Validation failed: ${r}.`),{success:!1,error:r,errorType:"value"}}break;case"number":if(typeof M!="number"){const r=`Column "${s}" expects a number.`;return p("warn",n,`Validation failed: ${r}.`),{success:!1,error:r,errorType:"value"}}if(t.decimal===!1&&!Number.isInteger(M)){const r=`Column "${s}" expects an integer.`;return p("warn",n,`Validation failed: ${r}.`),{success:!1,error:r,errorType:"value"}}break;case"date":if(typeof M!="string"||!/^\d{4}-\d{2}-\d{2}$/.test(M)||isNaN(new Date(M+"T00:00:00Z").getTime())){const r=`Invalid date format (YYYY-MM-DD) for column "${s}".`;return p("warn",n,`Validation failed: ${r}.`),{success:!1,error:r,errorType:"value"}}break;case"boolean":if(typeof M!="boolean"){const r=`Column "${s}" expects a boolean.`;return p("warn",n,`Validation failed: ${r}.`),{success:!1,error:r,errorType:"value"}}break;case"select":if(M!==null&&i&&!i.has(M)){const r=`Invalid selection for column "${s}".`;return p("warn",n,`Validation failed: ${r}.`),{success:!1,error:r,errorType:"value"}}break}return{success:!0}}function St(M,t){const e=[];for(let i=0;i<M.length;i+=t)e.push(M.slice(i,i+t));return e}class bt{constructor(t,e,i){this.options=t,this.stateManager=e,this.domManager=i}initializeSizes(t){const e=this.stateManager.getColumns().map(()=>this.options.defaultColumnWidth);this.stateManager.setColumnWidths(e),p("log",this.options.verbose,"Initialized column widths:",e),this.calculateTotalSize()}calculateDimensions(t,e){const i=this.domManager.getSystemScrollbarWidth();this.stateManager.updateViewportSize(t-i,e-i),this.calculateTotalSize(),p("log",this.options.verbose,"Calculated Dimensions:",{totalContentWidth:this.stateManager.getTotalContentWidth(),totalContentHeight:this.stateManager.getTotalContentHeight(),viewportWidth:this.stateManager.getViewportWidth(),viewportHeight:this.stateManager.getViewportHeight()}),this.calculateVisibleRange()}calculateTotalSize(){let t=this.options.rowNumberWidth;this.stateManager.getColumnWidths().forEach(i=>t+=i);const e=this.options.headerHeight+this.stateManager.getTotalRowHeight();this.stateManager.updateTotalContentSize(t,e)}calculateVisibleRange(){const{headerHeight:t,rowNumberWidth:e,defaultRowHeight:i}=this.options,n=this.stateManager.dataLength,s=this.stateManager.getColumns(),r=this.stateManager.getColumnWidths(),o=this.stateManager.getRowHeights(),a=this.stateManager.getScrollLeft(),l=this.stateManager.getScrollTop(),h=this.stateManager.getViewportWidth(),d=this.stateManager.getViewportHeight();let g=e,c=-1,u=s.length-1;for(let C=0;C<s.length;C++){const S=r[C],b=g+S;if(b>a&&g<a+h)c===-1&&(c=C),u=C;else if(c!==-1)break;g=b}c===-1&&(c=0,u=-1);let w=t,m=-1,f=n-1;for(let C=0;C<n;C++){const S=o.get(C)||i,b=w+S;if(b>l&&w<l+d)m===-1&&(m=C),f=C;else if(m!==-1)break;w=b}m===-1&&(m=0,f=-1),this.stateManager.updateVisibleRange(m,f,c,u),p("log",this.options.verbose,"Calculated Visible Range:",{rows:`${m} - ${f}`,cols:`${c} - ${u}`})}getColumnLeft(t){let e=this.options.rowNumberWidth;const i=this.stateManager.getColumnWidths();for(let n=0;n<t;n++)e+=i[n];return e}getRowTop(t){let e=this.options.headerHeight+t*this.options.defaultRowHeight;const i=this.stateManager.getRowHeights().entries();for(const[n,s]of i)n<t&&(e+=s-this.options.defaultRowHeight);return e}}class yt{constructor(t,e,i,n){this.temporaryErrors=new Map,this.ctx=t,this.options=e,this.stateManager=i,this.dimensionCalculator=n}setTemporaryErrors(t){const{temporaryErrorTimeout:e}=this.options;if(!e)return;const i=t.map(({row:s,col:r,error:o})=>[`${s}:${r}`,o]),n=Date.now()+e;for(const[s,r]of i)this.temporaryErrors.set(s,{error:r,expireAt:n});setTimeout(()=>{let s=0;for(const[r]of i)s+=this.temporaryErrors.delete(r)?1:0;s&&this.draw()},e)}clearTemporaryErrors(t){let e=0;for(const{row:i,col:n}of t)e+=this.temporaryErrors.delete(`${i}:${n}`)?1:0;return e>0}draw(){this.ctx.save(),this.ctx.font=this.options.font,this._clearCanvas(),this._cleanupExpiredErrors(),this.ctx.translate(-this.stateManager.getScrollLeft(),-this.stateManager.getScrollTop()),this._drawHeaders(),this._drawRowNumbers(),this._drawCells(),this._drawGridLines(),this._drawCopiedCellHighlight(),this._drawActiveCellHighlight(),this._drawSelectedColumnHighlight(),this._drawSelectedRowsHighlight(),this._drawDragRange(),this._drawCornerBox(),this.ctx.restore()}_cleanupExpiredErrors(){const t=Date.now();for(const[e,{expireAt:i}]of this.temporaryErrors.entries())t>=i&&this.temporaryErrors.delete(e)}_clearCanvas(){this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.stateManager.getViewportWidth(),this.stateManager.getViewportHeight()+this.options.headerHeight)}_drawCornerBox(){const{rowNumberWidth:t,headerHeight:e,gridLineColor:i,rowNumberBgColor:n}=this.options,s=0,r=0;this.ctx.save(),this.ctx.fillStyle=n,this.ctx.fillRect(s,r,t,e),this.ctx.strokeStyle=i,this.ctx.strokeRect(s-.5,r-.5,t,e),this.ctx.restore()}_drawHeaders(){const{headerHeight:t,rowNumberWidth:e,headerFont:i,headerBgColor:n,headerTextColor:s,gridLineColor:r,headerClipText:o,headerTextAlign:a,padding:l,selectedHeaderBgColor:h,customHeaderBgColor:d,readonlyHeaderBgColor:g,selectedHeaderTextColor:c,readonlyHeaderTextColor:u}=this.options,w=this.stateManager.getColumns(),m=this.stateManager.getSchema(),f=this.stateManager.getColumnWidths(),C=this.stateManager.getVisibleColStartIndex(),S=this.stateManager.getVisibleColEndIndex(),b=this.stateManager.getTotalContentWidth(),y=this.stateManager.getSelectedColumn();this.ctx.save();const R=e,v=0,N=b,$=t;this.ctx.beginPath(),this.ctx.rect(R,v,N-e,$),this.ctx.clip(),this.ctx.fillStyle=n,this.ctx.fillRect(e,0,b-e,t),this.ctx.font=i,this.ctx.textAlign=a,this.ctx.textBaseline="middle";let E=this.dimensionCalculator.getColumnLeft(C);for(let L=C;L<=S;L++){if(L<0||L>=w.length)continue;const K=w[L],x=m[K],k=(x==null?void 0:x.label)||K,H=f[L],J=y===L;let A=null,I=s;J?(A=h,I=c):x!=null&&x.removable?A=d:x!=null&&x.readonly&&(A=g,I=u),A&&(this.ctx.fillStyle=A,this.ctx.fillRect(E,0,H,t)),this.ctx.fillStyle=I;let B=E+l;a==="center"?B=E+H/2:a==="right"&&(B=E+H-l),o?(this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(E,0,H,t),this.ctx.clip(),this.ctx.fillText(k,B,t/2),this.ctx.restore()):this.ctx.fillText(k,B,t/2,H-l*2),this.ctx.strokeStyle=r,this.ctx.beginPath();const q=Math.round(E+H)-.5;this.ctx.moveTo(q,0),this.ctx.lineTo(q,t),this.ctx.stroke(),E+=H}this.ctx.restore(),this.ctx.strokeStyle=r,this.ctx.beginPath();const U=t-.5;this.ctx.moveTo(e,U),this.ctx.lineTo(this.stateManager.getTotalContentWidth(),U),this.ctx.stroke()}_drawRowNumbers(){const{headerHeight:t,rowNumberWidth:e,font:i,rowNumberBgColor:n,selectedRowNumberBgColor:s,textColor:r,gridLineColor:o,defaultRowHeight:a}=this.options,l=this.stateManager.dataLength,h=this.stateManager.getTotalContentHeight();if(l){const g=this.stateManager.getRowHeights(),c=this.stateManager.getSelectedRows(),u=this.stateManager.getVisibleRowStartIndex(),w=this.stateManager.getVisibleRowEndIndex();this.ctx.save();const m=0,f=t,C=e,S=h;this.ctx.beginPath(),this.ctx.rect(m,f,C,S-t),this.ctx.clip(),this.ctx.fillStyle=n,this.ctx.fillRect(0,t,e,h-t),this.ctx.font=i,this.ctx.textAlign="center",this.ctx.textBaseline="middle";let b=this.dimensionCalculator.getRowTop(u);for(let y=u;y<=w;y++){if(y<0||y>=l)continue;const R=g.get(y)||a;c.has(y)&&(this.ctx.fillStyle=s,this.ctx.fillRect(0,b,e,R)),this.ctx.fillStyle=r,this.ctx.fillText((y+1).toString(),e/2,b+R/2),this.ctx.strokeStyle=o,this.ctx.beginPath();const v=Math.round(b+R)-.5;this.ctx.moveTo(0,v),this.ctx.lineTo(e,v),this.ctx.stroke(),b+=R}this.ctx.restore()}this.ctx.strokeStyle=o,this.ctx.beginPath();const d=e-.5;this.ctx.moveTo(d,t),this.ctx.lineTo(d,Math.max(h,this.stateManager.getViewportHeight()+t)),this.ctx.stroke()}_drawCells(){var st,nt,rt;const{headerHeight:t,rowNumberWidth:e,font:i,textColor:n,textAlign:s,textBaseline:r,padding:o,cellBgColor:a,activeCellBgColor:l,selectedRowBgColor:h,selectedRangeBgColor:d,disabledCellBgColor:g,disabledCellTextColor:c,errorCellBgColor:u,errorTextColor:w,loadingTextColor:m,placeholderTextColor:f,defaultRowHeight:C}=this.options,S=this.stateManager.dataLength,b=this.stateManager.getColumns(),y=this.stateManager.getSchema(),R=this.stateManager.getRowHeights(),v=this.stateManager.getColumnWidths(),N=this.stateManager.getVisibleRowStartIndex(),$=this.stateManager.getVisibleRowEndIndex(),E=this.stateManager.getVisibleColStartIndex(),U=this.stateManager.getVisibleColEndIndex(),L=this.stateManager.getSelectedRows(),K=this.stateManager.getSelectedColumn(),x=this.stateManager.getActiveCell(),k=this.stateManager.getNormalizedSelectionRange(),H=this.stateManager.getScrollLeft(),J=this.stateManager.getScrollTop();this.ctx.save();const A=Math.max(0,e-H),I=Math.max(0,t-J),B=this.stateManager.getTotalContentWidth()-A,q=this.stateManager.getTotalContentHeight()-I;this.ctx.beginPath(),this.ctx.rect(A+H,I+J,B,q),this.ctx.clip(),this.ctx.font=i,this.ctx.textAlign=s,this.ctx.textBaseline=r;let et=this.dimensionCalculator.getRowTop(N);for(let D=N;D<=$;D++){if(D<0||D>=S)continue;const _=this.stateManager.getRowData(D),it=R.get(D)||C,dt=L.has(D);let O=this.dimensionCalculator.getColumnLeft(E);for(let T=E;T<=U;T++){if(T<0||T>=b.length)continue;const Y=v[T],X=b[T],V=y[X],P=_==null?void 0:_[`error:${X}`],ot=this.stateManager.isCellDisabled(D,T),at=(x==null?void 0:x.row)===D&&(x==null?void 0:x.col)===T,G=((st=this.stateManager.getActiveEditor())==null?void 0:st.row)===D&&((nt=this.stateManager.getActiveEditor())==null?void 0:nt.col)===T,gt=K===T,ut=_==null?void 0:_[`loading:${X}`],j=(rt=this.temporaryErrors.get(`${D}:${T}`))==null?void 0:rt.error,ft=k&&D>=k.start.row&&D<=k.end.row&&T>=k.start.col&&T<=k.end.col;let W=a;dt&&(W=h),gt&&(W=h),ft&&!at&&(W=d),ot&&(W=g),at&&!G&&(W=l),(P||j)&&(W=u),!G&&W&&(this.ctx.fillStyle=W,this.ctx.fillRect(O,et,Y,it));let lt=!0;if(G&&!["select","boolean","date"].includes(V==null?void 0:V.type)&&(lt=!1),lt){const ht=et+it/2;let Z=O+o;if(ut)this.ctx.fillStyle=m,this.ctx.fillText("(Loading...)",Z,ht,Y-o*2);else{const ct=_==null?void 0:_[X];let F=j||(V!=null&&V.formatter?V.formatter(ct):Ct(ct,V==null?void 0:V.type,this.stateManager.cachedDropdownOptionsByColumn.get(X)));!F&&P&&(F=`${P}`.includes("required")?"(required)":P),F!=null&&F!==""&&(this.ctx.fillStyle=ot?c:G?f:P||j?w:n,s==="center"?Z=O+Y/2:s==="right"&&(Z=O+Y-o),this.ctx.fillText(F,Z,ht))}}O+=Y}et+=it}this.ctx.restore()}_drawGridLines(){const{headerHeight:t,rowNumberWidth:e,gridLineColor:i,defaultRowHeight:n}=this.options,s=this.stateManager.getTotalContentWidth(),r=this.stateManager.getTotalContentHeight(),o=this.stateManager.getColumns(),a=this.stateManager.dataLength,l=this.stateManager.getColumnWidths(),h=this.stateManager.getRowHeights(),d=this.stateManager.getViewportWidth(),g=this.stateManager.getViewportHeight(),c=this.stateManager.getScrollLeft(),u=this.stateManager.getScrollTop();this.ctx.save(),this.ctx.strokeStyle=i,this.ctx.lineWidth=1;let w=e;for(let f=0;f<=o.length;f++){const C=Math.round(w)-.5;if(C>=e&&C<=d+c&&(this.ctx.beginPath(),this.ctx.moveTo(C,t),this.ctx.lineTo(C,r),this.ctx.stroke()),f<o.length&&(w+=l[f]),w>d+c)break}let m=t;for(let f=0;f<=a;f++){const C=Math.round(m)-.5;if(C>=t&&C<=g+u&&(this.ctx.beginPath(),this.ctx.moveTo(e,C),this.ctx.lineTo(s,C),this.ctx.stroke()),f<a&&(m+=h.get(f)||n),m>g+u)break}this.ctx.restore()}_drawActiveCellHighlight(){const t=this.stateManager.getActiveCell(),e=this.stateManager.isDraggingFillHandle(),i=this.stateManager.isResizing(),n=this.stateManager.getActiveEditor(),s=this.stateManager.getNormalizedSelectionRange();if(i||e||!t&&!s)return;const{highlightBorderColor:r,fillHandleColor:o,fillHandleSize:a}=this.options;this.ctx.save(),this.ctx.strokeStyle=r,this.ctx.lineWidth=2;let l=null,h=null;if(s){const d=this.getCellBounds(s.start.row,s.start.col),g=this.getCellBounds(s.end.row,s.end.col);d&&g&&(l={x:d.x,y:d.y,width:g.x+g.width-d.x,height:g.y+g.height-d.y}),t&&t.row!==null&&t.col!==null&&(h=this.getCellBounds(t.row,t.col))}else t&&t.row!==null&&t.col!==null&&(h=this.getCellBounds(t.row,t.col),l=h);if(l&&this.ctx.strokeRect(l.x+1,l.y+1,l.width-2,l.height-2),!n&&h){const d=a/2,g=h.x+h.width-d-1,c=h.y+h.height-d-1;this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(g,c,d,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=1,this.ctx.stroke()}this.ctx.restore()}_drawDragRange(){const t=this.stateManager.isDraggingFillHandle(),e=this.stateManager.getDragStartCell(),i=this.stateManager.getDragEndRow();if(!t||!e||i===null||i===e.row)return;const{row:n,col:s}=e;if(n===null||s===null)return;const{dragRangeBorderColor:r,defaultRowHeight:o}=this.options,a=i,l=this.stateManager.getColumnWidths(),h=this.stateManager.getRowHeights(),d=this.stateManager.dataLength;if(s<0||s>=l.length)return;const g=l[s],c=this.dimensionCalculator.getColumnLeft(s),u=a>=n;let w,m;if(u){w=this.dimensionCalculator.getRowTop(n)+(h.get(n)||o),m=0;for(let b=n+1;b<=a&&!(b>=d);b++)m+=h.get(b)||o}else{w=this.dimensionCalculator.getRowTop(a),m=0;for(let S=a;S<n&&!(S>=d);S++)m+=h.get(S)||o}if(m<=0)return;const f=c,C=w;this.ctx.save(),this.ctx.strokeStyle=r,this.ctx.lineWidth=2,this.ctx.setLineDash([4,2]),this.ctx.strokeRect(f+.5,C+.5,g-1,m-1),this.ctx.restore()}_drawCopiedCellHighlight(){const t=this.stateManager.getCopiedCell(),e=this.stateManager.getCopiedSourceRange();if(!t&&!e)return;const{copyHighlightBorderColor:i,copyHighlightBorderDash:n}=this.options;let s=null;if(e){const r=this.getCellBounds(e.start.row,e.start.col),o=this.getCellBounds(e.end.row,e.end.col);r&&o&&(s={x:r.x,y:r.y,width:o.x+o.width-r.x,height:o.y+o.height-r.y})}else t&&t.row!==null&&t.col!==null&&(s=this.getCellBounds(t.row,t.col));s&&(this.ctx.save(),this.ctx.strokeStyle=i,this.ctx.lineWidth=1,this.ctx.setLineDash(n),this.ctx.strokeRect(s.x+.5,s.y+.5,s.width-1,s.height-1),this.ctx.restore())}_drawSelectedColumnHighlight(){const t=this.stateManager.getSelectedColumn();if(t===null)return;const{highlightBorderColor:e}=this.options,i=this.stateManager.getTotalContentHeight(),n=this.stateManager.getColumnWidths(),s=this.dimensionCalculator.getColumnLeft(t),r=n[t];r&&(this.ctx.save(),this.ctx.strokeStyle=e,this.ctx.lineWidth=2,this.ctx.strokeRect(s+1,1,r-2,i-2),this.ctx.restore())}_drawSelectedRowsHighlight(){const t=this.stateManager.getSelectedRows();if(t.size===0)return;const{highlightBorderColor:e,defaultRowHeight:i}=this.options,n=this.stateManager.getTotalContentWidth(),s=this.stateManager.getRowHeights();this.ctx.save(),this.ctx.strokeStyle=e,this.ctx.lineWidth=2;for(const r of t){const o=s.get(r)||i,a=this.dimensionCalculator.getRowTop(r);this.ctx.strokeRect(0,a,n,o)}this.ctx.restore()}getCellBounds(t,e){const i=this.stateManager.dataLength,n=this.stateManager.getColumns(),s=this.stateManager.getColumnWidths(),r=this.stateManager.getTotalContentWidth(),o=this.stateManager.getTotalContentHeight();if(t<0||t>=i||e<0||e>=n.length)return null;const a=s[e],l=this.stateManager.getRowHeight(t),h=this.dimensionCalculator.getColumnLeft(e),d=this.dimensionCalculator.getRowTop(t),g=h,c=d;return g<r&&g+a>0&&c<o&&c+l>0?{x:g,y:c,width:a,height:l}:null}getFillHandleBounds(t,e){const i=this.getCellBounds(t,e);if(!i)return null;const{fillHandleSize:n}=this.options,s=n/2,r=i.x+i.width-s-1,o=i.y+i.height-s-1;return{x:r-s,y:o-s,width:n,height:n}}}class vt{constructor(t,e,i,n,s,r,o,a){this.resizeTimeout=null,this._ignoreNextClick=!1,this.isCtrl=!1,this.lastTouchX=null,this.lastTouchY=null,this.isTouching=!1,this.touchVelocityX=0,this.touchVelocityY=0,this.lastTouchTime=0,this.kineticScrollInterval=null,this.container=t,this.editingManager=e,this.interactionManager=i,this.stateManager=n,this.dimensionCalculator=s,this.renderer=r,this.options=o,this.domManager=a,this.canvas=this.domManager.getCanvas(),this.hScrollbar=this.domManager.getHScrollbar(),this.vScrollbar=this.domManager.getVScrollbar(),this.interactionManager.setEditingManager(this.editingManager)}bindEvents(){this.container.addEventListener("wheel",this._handleWheel.bind(this)),this.hScrollbar.addEventListener("scroll",this._handleHScroll.bind(this)),this.vScrollbar.addEventListener("scroll",this._handleVScroll.bind(this)),this.canvas.addEventListener("dblclick",this._handleDoubleClick.bind(this)),this.canvas.addEventListener("click",this._handleClick.bind(this)),this.canvas.addEventListener("mousedown",this._handleCanvasMouseDown.bind(this)),document.addEventListener("mousemove",this._handleDocumentMouseMove.bind(this)),document.addEventListener("mouseup",this._handleDocumentMouseUp.bind(this)),new ResizeObserver(()=>{this._handleResize()}).observe(this.container),document.addEventListener("mousedown",this._handleGlobalMouseDown.bind(this),!0),document.addEventListener("keydown",this._handleDocumentKeyDown.bind(this)),document.addEventListener("keyup",this._handleDocumentKeyUp.bind(this)),this.container.addEventListener("paste",this._handlePaste.bind(this)),this.canvas.addEventListener("touchstart",this._handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this._handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this._handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this._handleTouchEnd.bind(this)),this.editingManager.bindInternalEvents(),window.addEventListener("keydown",t=>{if(t.key.startsWith("Arrow")&&document.activeElement===this.container){const e=this.stateManager.getActiveCell(),i=e&&e.row!==null&&e.col!==null;e&&i&&t.preventDefault()}})}_handleScroll(){this.interactionManager.onScroll()}_handleWheel(t){const e=t.deltaY,i=t.shiftKey;this.interactionManager.canScrollMore(e,!i)&&(t.preventDefault(),this.interactionManager.moveScroll(i?e:0,i?0:e),this._handleScroll())}_handleHScroll(t){const i=t.target.scrollLeft;this.stateManager.updateScroll(this.stateManager.getScrollTop(),i),this._handleScroll()}_handleVScroll(t){const i=t.target.scrollTop;this.stateManager.updateScroll(i,this.stateManager.getScrollLeft()),this._handleScroll()}_handleResize(){this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=window.setTimeout(()=>{this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown(),this.dimensionCalculator.calculateDimensions(this.container.clientWidth,this.container.clientHeight),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.renderer.draw(),this.resizeTimeout=null},100)}_handleDoubleClick(t){if(this.stateManager.isResizing()){p("log",this.options.verbose,"Double click ignored due to active resize.");return}const e=this._getCoordsFromEvent(t);if(!e||e.row===null||e.col===null)return;let i=!1;if(i=i||this.interactionManager.clearSelections(),i=i||this.interactionManager.clearCopiedCell(),i=i||this.stateManager.setActiveCell(e),this.stateManager.isCellDisabled(e.row,e.col)){p("log",this.options.verbose,`Edit prevented: Cell ${e.row},${e.col} is disabled.`),i&&this.renderer.draw();return}this.editingManager.activateEditor(e.row,e.col)}_handleClick(t){if(this._ignoreNextClick){this._ignoreNextClick=!1;return}if(this.stateManager.isDraggingFillHandle()||this.stateManager.isResizing()){p("log",this.options.verbose,"Click ignored due to active fill handle drag or resize.");return}const e=this._getCoordsFromEvent(t),i=e&&e.row!==null&&e.col!==null,n=e&&e.row!==null&&e.col===null&&this._isRowNumberAreaClick(t),s=this._isHeaderAreaClick(t);let r=!1;if(this.editingManager.isEditorActive()){const a=this.stateManager.getActiveEditor();i&&(e==null?void 0:e.row)===(a==null?void 0:a.row)&&(e==null?void 0:e.col)===(a==null?void 0:a.col)||this.editingManager.deactivateEditor(!0)}else this.editingManager.isDropdownVisible()&&this.editingManager.hideDropdown();const o=this.stateManager.isCopyActive();if(n&&e&&e.row!==null){const a=this.interactionManager.handleRowNumberClick(e.row,t.shiftKey,t.ctrlKey||t.metaKey),l=o?this.interactionManager.clearCopiedCell():!1;r=a||l}else if(s){const a=this._getColumnFromEvent(t);if(a!==null){const l=this.interactionManager.handleHeaderClick(a),h=o?this.interactionManager.clearCopiedCell():!1;r=l||h}}else{const a=this.stateManager.setActiveCell(null);let l=!1,h=!1;a&&(l=this.interactionManager.clearSelections(),h=this.stateManager.clearSelectionRange());const d=o?this.interactionManager.clearCopiedCell():!1;r=a||l||h||d}r&&this.renderer.draw()}_handleCanvasMouseDown(t){if(this._ignoreNextClick=!1,this.interactionManager.checkResizeHandles(t)){t.preventDefault(),t.stopPropagation();return}const i=this.stateManager.getActiveCell();let n=!1;if(i&&i.row!==null&&i.col!==null&&(n=!0,this.interactionManager.checkFillHandle(t))){t.preventDefault(),t.stopPropagation();return}const s=this._getCoordsFromEvent(t);if(s&&s.row!==null&&s.col!==null){if(this.editingManager.isEditorActive()){const o=this.stateManager.getActiveEditor();(s.row!==(o==null?void 0:o.row)||s.col!==(o==null?void 0:o.col))&&this.editingManager.deactivateEditor(!0)}if(t.shiftKey&&n&&(s.row!==(i==null?void 0:i.row)||s.col!==(i==null?void 0:i.col))){p("log",this.options.verbose,`shift click detected at ${i==null?void 0:i.row},${i==null?void 0:i.col} -> ${s.row},${s.col}`),t.preventDefault(),this.domManager.focusContainer();return}this.interactionManager.startSelectionDrag(s)&&this.renderer.draw(),t.preventDefault(),this.domManager.focusContainer()}}_handleDocumentMouseMove(t){if(this.stateManager.isResizing())this.interactionManager.handleResizeMouseMove(t);else if(this.stateManager.isDraggingFillHandle())this.interactionManager.handleFillHandleMouseMove(t),this._ignoreNextClick=!0;else if(this.stateManager.getIsDraggingSelection()){const e=this._getCoordsFromEvent(t);e&&this.interactionManager.updateSelectionDrag(e)&&this.renderer.draw()}else this.interactionManager.updateCursorStyle(t)}_handleDocumentMouseUp(t){let e=!1;const i=this.stateManager.getActiveCell();if(this.stateManager.getIsDraggingSelection())e=!0,this.interactionManager.endSelectionDrag();else if(t.shiftKey&&i&&i.row!==null&&i.col!==null){const n=this._getCoordsFromEvent(t);n&&n.row!==null&&n.col!==null&&(this.interactionManager.startSelectionDrag(i),this.interactionManager.updateSelectionDrag(n),this.interactionManager.endSelectionDrag(),this.renderer.draw(),e=!0,p("log",this.options.verbose,`shift click received: ${i.row},${i.col} -> ${n.row},${n.col}`))}this.stateManager.isResizing()&&(this.interactionManager.endResize(),e=!0),this.stateManager.isDraggingFillHandle()&&this.interactionManager.endFillHandleDrag(),this.interactionManager.updateCursorStyle(t),e&&(this._ignoreNextClick=!0)}_handleGlobalMouseDown(t){if(!(this.stateManager.isDraggingFillHandle()||this.stateManager.isResizing()||this.stateManager.getIsDraggingSelection())&&!this.container.contains(t.target)){p("log",this.options.verbose,"Outside click on container");let e=!1;if(this.editingManager.isEditorActive(!0)||this.editingManager.isDropdownVisible()){if(this.domManager.checkEventBoundInDropdown(t))return;this.editingManager.deactivateEditor(!0)}else{const i=this.stateManager.setActiveCell(null);let n=!1,s=!1;i&&(n=this.interactionManager.clearSelections(),s=this.stateManager.clearSelectionRange());const r=this.interactionManager.clearCopiedCell();e=i||n||s||r}e&&this.renderer.draw()}}_handleDocumentKeyDown(t){(t.ctrlKey||t.metaKey)&&(this.isCtrl=!0)}_handleDocumentKeyUp(t){var a;const e=this.isCtrl;(t.ctrlKey||t.metaKey)&&(this.isCtrl=!1);let i=!1,n=!1;if(this.editingManager.isEditorActive()||this.editingManager.isDropdownVisible())return;if(e&&t.key==="c"){i=this.interactionManager.copy(),t.preventDefault(),i&&this.renderer.draw();return}if(e&&t.key==="v"){i=this.interactionManager.paste(),t.preventDefault(),i&&this.renderer.draw();return}const s=this.stateManager.getActiveCell(),r=s&&s.row!==null&&s.col!==null,o=r&&this.stateManager.isCellDisabled(s.row,s.col);if(t.key==="Delete"||t.key==="Backspace"){const l=this.stateManager.getSelectedColumn();if(this.stateManager.getSelectedRows().size>0)i=this.interactionManager.deleteSelectedRows(),t.preventDefault();else if(r){const{row:h,col:d}=s,g=this.stateManager.getColumnKey(d);if(!o){const c=this.stateManager.getCellData(h,d);try{i=this.stateManager.updateCell(h,g,null,!0)}catch(u){p("warn",this.options.verbose,u),u instanceof tt&&(i=!0,u.errorType==="required"&&!c?this.stateManager.updateCell(h,`error:${g}`,u.message):this.renderer.setTemporaryErrors([{row:h,col:d,error:u.message}]))}}t.preventDefault()}else if(t.key==="Delete"&&l!==null&&((a=this.stateManager.getSchemaForColumn(l))!=null&&a.removable)){if(this.options.onColumnDelete){try{this.options.onColumnDelete(l,this.stateManager.getSchemaForColumn(l))}catch(h){p("warn",this.options.verbose,h)}return}else this.stateManager.removeColumn(l),i=!0,n=!0;t.preventDefault()}}else if(t.key.startsWith("Arrow")){if(s&&r){let l=0,h=0;t.key==="ArrowUp"?l=-1:t.key==="ArrowDown"?l=1:t.key==="ArrowLeft"?h=-1:t.key==="ArrowRight"&&(h=1),(l!==0||h!==0)&&(i=this.interactionManager.moveActiveCell(l,h,!1),i&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange()),t.preventDefault())}}else if(t.key==="Enter"&&s)!o&&s.row!==null&&s.col!==null&&(this.editingManager.activateEditor(s.row,s.col),t.preventDefault());else if(t.key==="Tab"&&s){if(document.activeElement!==this.container&&!this.container.contains(document.activeElement)){document.activeElement===document.body&&this.domManager.focusContainer();return}i=this.interactionManager.moveActiveCell(0,t.shiftKey?-1:1),i&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange()),t.preventDefault()}else!e&&!t.ctrlKey&&t.key.length===1&&s&&s.row!==null&&s.col!==null&&!o&&this.editingManager.activateEditor(s.row,s.col,t.key);n?this.interactionManager.triggerCustomEvent("resize"):i&&this.renderer.draw()}_handlePaste(t){if(this.editingManager.isEditorActive()||!t.clipboardData)return;const e=t.clipboardData.getData("text/plain");if(!e)return;if(this.interactionManager.paste()){t.preventDefault(),this.renderer.draw();return}const i=this.stateManager.getActiveCell(),n=this.stateManager.getNormalizedSelectionRange(),s=this.stateManager.getSelectedColumn();if(s!==null){const d=e.split(/\r\n|\n|\r/)[0].split("	")[0];d&&(p("log",this.options.verbose,"Handling column paste from clipboard"),t.preventDefault(),this.interactionManager.pasteToColumnExternal(s,d)&&this.renderer.draw());return}const r=n,o=!r&&i?i:null;if(!r&&!o){p("log",this.options.verbose,"Clipboard paste ignored: No target cell or range selected.");return}p("log",this.options.verbose,"Handling native paste event."),t.preventDefault();let a=!1;const l=e.split(/\r\n|\n|\r/).map(d=>d.split("	")),h=l.length===1&&l[0].length===1;r?a=this.interactionManager.pasteRangeToRangeExternal(r,l):o&&o.row!==null&&o.col!==null&&(h?a=this.interactionManager.pasteSingleValueExternal(o,l[0][0]):a=this.interactionManager.pasteRangeFromTopLeftExternal(o,l)),a&&this.renderer.draw()}_getCoordsFromEvent(t){const e=this.domManager.getCanvasBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top,s=i+this.stateManager.getScrollLeft(),r=n+this.stateManager.getScrollTop(),{headerHeight:o,rowNumberWidth:a,defaultRowHeight:l}=this.options,h=this.stateManager.dataLength,d=this.stateManager.getColumns(),g=this.stateManager.getRowHeights(),c=this.stateManager.getColumnWidths();let u=null,w=null;if(r>=o){let m=o;for(let f=0;f<h;f++){const C=g.get(f)||l;if(r>=m&&r<m+C){u=f;break}if(m+=C,m>r)break}}if(u!==null)if(s>=a){let m=a;for(let f=0;f<d.length;f++){const C=c[f]||this.options.defaultColumnWidth;if(s>=m&&s<m+C){w=f;break}if(m+=C,m>s)break}}else w=null;else u=null,w=null;return u===null&&w===null&&s>a&&r<o||u===null&&w===null&&s<a&&r<o?null:u!==null?{row:u,col:w}:null}_getColumnFromEvent(t){const e=this.domManager.getCanvasBoundingClientRect(),i=t.clientX-e.left+this.stateManager.getScrollLeft(),{rowNumberWidth:n}=this.options,s=this.stateManager.getColumns(),r=this.stateManager.getColumnWidths();if(i<n)return null;let o=n;for(let a=0;a<s.length;a++){const l=r[a]||this.options.defaultColumnWidth;if(i>=o&&i<o+l)return a;o+=l}return null}_isRowNumberAreaClick(t){const e=this.domManager.getCanvasBoundingClientRect();return t.clientX-e.left<this.options.rowNumberWidth}_isHeaderAreaClick(t){const e=this.domManager.getCanvasBoundingClientRect();return t.clientY-e.top<this.options.headerHeight}_handleTouchStart(t){if(t.preventDefault(),t.touches.length===1){const e=t.touches[0];this.lastTouchX=e.clientX,this.lastTouchY=e.clientY,this.isTouching=!0,this.lastTouchTime=Date.now(),this.kineticScrollInterval!==null&&(window.clearInterval(this.kineticScrollInterval),this.kineticScrollInterval=null),this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown()}}_handleTouchMove(t){if(!(!this.isTouching||!this.lastTouchX||!this.lastTouchY)&&(t.preventDefault(),t.touches.length===1)){const e=t.touches[0],i=e.clientX,n=e.clientY,s=this.lastTouchX-i,r=this.lastTouchY-n,o=Date.now(),a=o-this.lastTouchTime;a>0&&(this.touchVelocityX=s/a*15,this.touchVelocityY=r/a*15),this.interactionManager.moveScroll(s,r),this._handleScroll(),this.lastTouchX=i,this.lastTouchY=n,this.lastTouchTime=o}}_handleTouchEnd(t){t.preventDefault(),this.isTouching=!1,(Math.abs(this.touchVelocityX)>.5||Math.abs(this.touchVelocityY)>.5)&&this._startKineticScroll()}_startKineticScroll(){this.kineticScrollInterval!==null&&window.clearInterval(this.kineticScrollInterval),this.kineticScrollInterval=window.setInterval(()=>{if(this.touchVelocityX*=.95,this.touchVelocityY*=.95,Math.abs(this.touchVelocityX)<.5&&Math.abs(this.touchVelocityY)<.5){window.clearInterval(this.kineticScrollInterval),this.kineticScrollInterval=null;return}this.interactionManager.moveScroll(this.touchVelocityX,this.touchVelocityY),this._handleScroll()},16)}}class Rt{constructor(t,e,i,n,s,r){this.dropdownItems=[],this.highlightedDropdownIndex=-1,this.DEFAULT_SAFE_MARGIN=50,this.container=t,this.options=e,this.stateManager=i,this.domManager=n,this.renderer=s,this.interactionManager=r,this.editorInput=this.domManager.getEditorInput();const o=this.domManager.getDropdownElements();this.dropdown=o.dropdown,this.dropdownSearchInput=o.searchInput,this.dropdownList=o.list}bindInternalEvents(){this.editorInput.addEventListener("blur",this._handleEditorBlur.bind(this)),this.editorInput.addEventListener("keydown",this._handleEditorKeyDown.bind(this)),this.dropdown.addEventListener("mousedown",t=>t.stopPropagation()),this.dropdownSearchInput.addEventListener("input",this._handleDropdownSearch.bind(this)),this.dropdownSearchInput.addEventListener("keydown",this._handleDropdownKeyDown.bind(this)),this.dropdownList.addEventListener("click",this._handleDropdownItemClick.bind(this))}isEditorActive(t=!1){const e=this.stateManager.getActiveEditor();return!(!e||t&&e.isCustomEditor)}isDropdownVisible(){return this.dropdown.style.display!=="none"}activateEditor(t,e,i){const{customDatePicker:n,verbose:s,font:r,onEditorOpen:o}=this.options,a=this.stateManager.getColumnKey(e),l=this.stateManager.getRowData(t);if(!l){p("warn",s,`Cannot activate editor: Cell ${t},${e} row data not found.`);return}this.isEditorActive()&&this.deactivateEditor(!0),this.hideDropdown();const h=this.renderer.getCellBounds(t,e);if(!h){p("warn",s,`Cannot activate editor: Cell ${t},${e} bounds not found (likely not visible).`);return}const{scrollLeft:d,scrollTop:g}=this.interactionManager.bringBoundsIntoView(h);if(l!=null&&l[`loading:${a}`]){p("log",s,`Edit prevented: Cell ${t},${e} is loading.`);return}if(this.stateManager.isCellDisabled(t,e)){p("log",s,`Edit prevented: Cell ${t},${e} is disabled.`);return}const c=this.stateManager.getSchemaForColumn(e);if(c!=null&&c.readonly){p("log",s,`Edit prevented: Cell ${t},${e} is readonly.`);return}this.renderer.clearTemporaryErrors([{row:t,col:e}]);const u=l==null?void 0:l[a],w=!!((c==null?void 0:c.type)==="date"&&n&&o);this.stateManager.setActiveEditor({row:t,col:e,type:c==null?void 0:c.type,originalValue:u,isCustomEditor:w});const{x:m,y:f,width:C,height:S}=h,b=m-d,y=f-g;if(w)try{o==null||o({rowIndex:t,colKey:a,rowData:l,bounds:{x:b,y,width:C,height:S}})}catch(R){p("error",s,`Error calling onEditorOpen: ${R}`)}else if((c==null?void 0:c.type)==="select"||(c==null?void 0:c.type)==="boolean"){this._showDropdown(t,a,c,b,y,C,S);return}else this.editorInput.style.display="block",this.editorInput.style.left=`${b}px`,this.editorInput.style.top=`${y}px`,this.editorInput.style.width=`${C}px`,this.editorInput.style.height=`${S}px`,this.editorInput.style.font=r,(c==null?void 0:c.type)==="number"?(this.editorInput.type="number",this.editorInput.step=c.decimal===!1?"1":"any",this.editorInput.placeholder=(c==null?void 0:c.placeholder)||""):(c==null?void 0:c.type)==="email"?this.editorInput.type="email":(c==null?void 0:c.type)==="date"?this.editorInput.type="date":(this.editorInput.type="text",this.editorInput.placeholder=(c==null?void 0:c.placeholder)||""),this.editorInput.value=mt(u,c==null?void 0:c.type),this.editorInput.focus(),i&&(["text","email"].includes(c==null?void 0:c.type)||(c==null?void 0:c.type)==="number"&&i.match(/^\d*\.?\d*$/))?this.editorInput.value=i:this.editorInput.select();this.renderer.draw()}deactivateEditor(t=!0,e=!1){const i=this.stateManager.getActiveEditor();if(!i)return;const{row:n,col:s,type:r,originalValue:o}=i;let a=!1,l=!1;if(r==="select"||r==="boolean")this.isDropdownVisible()&&(this.hideDropdown(),l=!0),a=this.stateManager.getCellData(n,s)!==o;else if(this.editorInput.style.display!=="none"){if(t){const h=this.editorInput.value,d=this.stateManager.getSchemaForColumn(s),g=this.stateManager.getColumnKey(s),c=Mt(h,d==null?void 0:d.type),u=z(c,d,g,this.stateManager.cachedDropdownOptionsByColumn.get(g),this.options.verbose);"error"in u?(p("log",this.options.verbose,u.error),u.errorType==="required"?this.stateManager.updateCell(n,`error:${g}`,u.error):this.renderer.setTemporaryErrors([{row:n,col:s,error:u.error}]),l=!0):(this.stateManager.removeCellValue(n,`error:${g}`),c!==o&&(this.stateManager.updateCellInternal(n,s,c),a=!0,this.interactionManager._batchUpdateCellsAndNotify([n],[g],[{[g]:o}])))}this.editorInput.style.display="none",this.editorInput.value="",l=!0}this.stateManager.setActiveEditor(null),e&&(this.stateManager.setActiveCell({row:n,col:s}),l=!0),(a||l)&&this.renderer.draw()}hasEditorSelection(){return this.highlightedDropdownIndex>=0}_handleEditorBlur(t){setTimeout(()=>{const e=t.relatedTarget;document.activeElement!==this.editorInput&&!this.dropdown.contains(e)&&this.deactivateEditor(!0)},0)}_handleEditorKeyDown(t){let e=!1;switch(t.key){case"Enter":this.deactivateEditor(!0),e=this.interactionManager.moveActiveCell(1,0),e&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange()),t.preventDefault();break;case"Escape":this.deactivateEditor(!1,!0),this.domManager.focusContainer(),t.preventDefault();return;case"Tab":this.deactivateEditor(!0),e=this.interactionManager.moveActiveCell(0,t.shiftKey?-1:1),e&&(this.interactionManager.clearSelections(),this.stateManager.clearSelectionRange()),t.preventDefault();break}e&&this.renderer.draw()}async _showDropdown(t,e,i,n,s,r,o){var u;this.dropdownItems=[],this.dropdownList.innerHTML="";const a=i!=null&&i.nullable?[{id:null,name:"(Blank)"}]:[];if((i==null?void 0:i.type)==="boolean")this.dropdownItems=[{id:!0,name:"True"},{id:!1,name:"False"},...a];else if((i==null?void 0:i.type)==="select"&&(i.values||i.filterValues)){let w=i.values||[];{const m=(u=i.filterValues)==null?void 0:u.call(i,this.stateManager.getRowData(t)||{},t);if(m&&m instanceof Promise){this.stateManager.updateCell(t,`loading:${e}`,!0),this.renderer.draw();const f=await m;this.stateManager.removeCellValue(t,`loading:${e}`),f!=null&&f.length&&(w=f||[],this.stateManager.addCachedDropdownOptionForColumn(e,w))}else m&&(w=m,this.stateManager.addCachedDropdownOptionForColumn(e,w))}this.dropdownItems=[...a,...w]}else{p("warn",this.options.verbose,`Dropdown requested for non-dropdown type: ${i==null?void 0:i.type}`);return}this.dropdownItems.forEach((w,m)=>{const f=document.createElement("li");f.className=`spreadsheet-dropdown-item${w.id===null?" spreadsheet-dropdown-item-blank":""}`,f.textContent=w.name,f.title=w.name,f.dataset.index=String(m),f.dataset.value=String(w.id===null||w.id===void 0?"":w.id),f.style.maxWidth="200px",this.dropdownList.appendChild(f)});const l=this.container.offsetLeft,h=this.container.offsetTop,d=n+l,g=s+h+o,c=d+r;this.dropdown.style.display="block",this.dropdown.style.left=`${d}px`,this.dropdown.style.top=`${g}px`,this.dropdown.style.minWidth=`${r}px`,this.dropdown.style.minHeight="100px",this.dropdown.style.resize="both",this.dropdown.style.overflow="auto",this.dropdownSearchInput.placeholder=(i==null?void 0:i.placeholder)||"Search...",requestAnimationFrame(()=>{const w=this.dropdown.scrollHeight;if(this.dropdown.clientHeight>=w){const C=[...this.dropdown.children].reduce((S,b)=>S+b.getBoundingClientRect().height,0);this.dropdown.style.height=`${Math.min(C+5,window.innerHeight-this.DEFAULT_SAFE_MARGIN)}px`}const f=this.dropdown.getBoundingClientRect();f.x+f.width>window.innerWidth-this.DEFAULT_SAFE_MARGIN&&(this.dropdown.style.left=`${c-f.width}px`,this.dropdown.style.resize="vertical"),f.y+f.height>window.innerHeight-this.DEFAULT_SAFE_MARGIN&&(this.dropdown.style.top=`${g-o-f.height}px`)}),this.dropdownSearchInput.value="",this._filterDropdown(""),this.dropdownSearchInput.focus(),this.highlightedDropdownIndex=-1,this._updateDropdownHighlight(Array.from(this.dropdownList.querySelectorAll("li:not(.hidden)"))),this.renderer.draw()}hideDropdown(){this.dropdown.style.display!=="none"&&(this.dropdown.style.display="none",this.highlightedDropdownIndex=-1)}_handleDropdownSearch(){const t=this.dropdownSearchInput.value.toLowerCase();this._filterDropdown(t);const e=Array.from(this.dropdownList.querySelectorAll("li:not(.hidden)"));this.highlightedDropdownIndex=e.length>0?0:-1,this._updateDropdownHighlight(e)}_filterDropdown(t){this.dropdownList.querySelectorAll("li").forEach(i=>{var s;const n=t?(((s=i.textContent)==null?void 0:s.toLowerCase())||"").includes(t):!0;i.classList.toggle("hidden",!n),i.style.display=n?"block":"none"})}_handleDropdownKeyDown(t){const e=Array.from(this.dropdownList.querySelectorAll("li:not(.hidden)"));if(!e.length&&t.key!=="Escape")return;let i=this.highlightedDropdownIndex;switch(t.key){case"ArrowDown":t.preventDefault(),i=(i+1)%e.length;break;case"ArrowUp":t.preventDefault(),i=(i-1+e.length)%e.length;break;case"Enter":t.preventDefault();let n=-1;i>=0&&i<e.length?n=i:e.length===1&&(n=0),n>=0&&e[n].click();return;case"Escape":t.preventDefault(),this.deactivateEditor(!1,!0),this.domManager.focusContainer();return;case"Tab":if(t.preventDefault(),!`${this.dropdownSearchInput.value}`.trim()&&i<0){this.deactivateEditor(!1);return}break;default:return}this.highlightedDropdownIndex=i,this._updateDropdownHighlight(e)}_updateDropdownHighlight(t){t.forEach((e,i)=>{const n=i===this.highlightedDropdownIndex;e.classList.toggle("highlighted",n),e.style.backgroundColor=n?"#dbeafe":"white",n&&e.scrollIntoView({block:"nearest"})})}_handleDropdownItemClick(t){const e=t.target;if(e.tagName==="LI"&&e.classList.contains("spreadsheet-dropdown-item")){const i=this.stateManager.getActiveEditor();if(!i)return;const n=parseInt(e.dataset.index||"-1",10);if(n<0||n>=this.dropdownItems.length)return;const s=this.dropdownItems[n],{row:r,col:o}=i;let a=s.id;typeof a=="string"&&i.type==="boolean"&&(a.toLowerCase()==="true"?a=!0:a.toLowerCase()==="false"&&(a=!1));const l=this.stateManager.updateCellInternal(r,o,a),h=this.stateManager.getColumnKey(o);this.interactionManager._batchUpdateCellsAndNotify([r],[h],[{[h]:l}]),setTimeout(()=>{this.deactivateEditor(!1),this.domManager.focusContainer()},200)}}}class xt{constructor(t,e,i,n,s){this.lastPasteHandledAt=null,this.ignoreNextScrollTimeout=null,this._customEventHandler=null,this.options=t,this.stateManager=e,this.renderer=i,this.dimensionCalculator=n,this.domManager=s}bindCustomEvents(t=null){this._customEventHandler=t}triggerCustomEvent(t){var e;(e=this._customEventHandler)==null||e.call(this,new CustomEvent(t))}setEditingManager(t){this.editingManager=t}canScrollMore(t,e){return e?t>0?this.domManager.canVScrollDown():this.domManager.canVScrollUp():t>0?this.domManager.canHScrollRight():this.domManager.canHScrollLeft()}moveScroll(t,e,i=!1){const n=this.domManager.setVScrollPosition(i?e:this.domManager.getVScrollPosition()+e),s=this.domManager.setHScrollPosition(i?t:this.domManager.getHScrollPosition()+t);this.stateManager.updateScroll(n,s)}bringBoundsIntoView(t){const e=this.domManager.getHScrollPosition(),i=this.domManager.getVScrollPosition(),n=this.domManager.getCanvasBoundingClientRect(),s=t.x-e,r=t.y-i,o=t.width,a=t.height;let l=e,h=i;return s<0?l+=s:s+o>n.width&&(l+=s+o-n.width),r<0?h+=r:r+a>n.height&&(h+=r+a-n.height),(l!==e||h!==i)&&this.moveScroll(l,h,!0),this.ignoreNextScrollTimeout=null,this.onScroll(!1),this.ignoreNextScrollTimeout=setTimeout(()=>{this.ignoreNextScrollTimeout=null},10),{scrollLeft:l,scrollTop:h}}onScroll(t=!0){if(this.ignoreNextScrollTimeout){clearTimeout(this.ignoreNextScrollTimeout),this.ignoreNextScrollTimeout=null;return}t&&(this.editingManager.deactivateEditor(!1),this.editingManager.hideDropdown()),this.dimensionCalculator.calculateVisibleRange(),this.renderer.draw()}handleRowNumberClick(t,e,i){p("log",this.options.verbose,`Row ${t} clicked. Shift: ${e}, Ctrl: ${i}`);const n=new Set(this.stateManager.getSelectedRows());let s=this.stateManager.getLastClickedRow();const r=JSON.stringify(Array.from(n).sort()),o=s;if(e&&s!==null){const d=Math.min(s,t),g=Math.max(s,t),c=new Set;for(let u=d;u<=g;u++)c.add(u);JSON.stringify(Array.from(c).sort())!==r&&this.stateManager.setSelectedRows(c,s),p("log",this.options.verbose,"Selected rows (Shift):",Array.from(c).sort((u,w)=>u-w))}else i?(n.has(t)?n.delete(t):n.add(t),s=t,this.stateManager.setSelectedRows(n,s),p("log",this.options.verbose,"Selected rows (Ctrl):",Array.from(n).sort((d,g)=>d-g))):(n.clear(),n.add(t),s=t,this.stateManager.setSelectedRows(n,s),p("log",this.options.verbose,"Selected rows (Single):",Array.from(n).sort((d,g)=>d-g)));const a=JSON.stringify(Array.from(this.stateManager.getSelectedRows()).sort())!==r,l=this.stateManager.getLastClickedRow()!==o,h=a||l;return h&&(this.stateManager.setActiveCell(null),this.stateManager.clearSelectionRange(),this.stateManager.setSelectedColumn(null)),h}handleHeaderClick(t){p("log",this.options.verbose,`Column ${t} clicked.`);const e=this.stateManager.getSelectedColumn();this.stateManager.setSelectedColumn(t);const i=e!==t;return i&&(this.stateManager.setActiveCell(null),this.stateManager.clearSelectionRange(),this.stateManager.setSelectedRows(new Set,null)),i}clearSelections(){let t=!1;return this.stateManager.getSelectedRows().size>0&&(t=this.stateManager.setSelectedRows(new Set,null)||t),this.stateManager.getSelectedColumn()!==null&&(t=this.stateManager.setSelectedColumn(null)||t),t}checkResizeHandles(t){const e=this.domManager.getCanvasBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top,s=i+this.stateManager.getScrollLeft(),r=n+this.stateManager.getScrollTop(),{headerHeight:o,rowNumberWidth:a,resizeHandleSize:l,defaultRowHeight:h}=this.options,d=this.stateManager.getColumns(),g=this.stateManager.dataLength,c=this.stateManager.getColumnWidths(),u=this.stateManager.getRowHeights();if(r<o&&s>a){let w=a;for(let m=0;m<d.length;m++){const f=c[m],C=w+f;if(Math.abs(s-C)<=l)return this._startColumnResize(m,t.clientX),"column";w=C}}if(s<a&&r>o){let w=o;for(let m=0;m<g;m++){const f=u.get(m)||h,C=w+f;if(Math.abs(r-C)<=l)return this._startRowResize(m,t.clientY),"row";w=C}}return null}_startColumnResize(t,e){p("log",this.options.verbose,`Starting column resize for index ${t}`),this.stateManager.setResizeColumnState({isResizing:!0,columnIndex:t,startX:e}),this.domManager.setCursor("col-resize")}_startRowResize(t,e){p("log",this.options.verbose,`Starting row resize for index ${t}`),this.stateManager.setResizeRowState({isResizing:!0,rowIndex:t,startY:e}),this.domManager.setCursor("row-resize")}handleResizeMouseMove(t){const e=this.stateManager.getResizeColumnState(),i=this.stateManager.getResizeRowState();if(e.isResizing&&e.columnIndex!==null&&e.startX!==null){const{minColumnWidth:n,maxColumnWidth:s}=this.options,r=t.clientX-e.startX,o=this.stateManager.getColumnWidths(),a=e.columnIndex,l=o[a];let h=l+r;if(h=Math.max(n,Math.min(h,s)),h!==l){const d=[...o];d[a]=h,this.stateManager.setColumnWidths(d),this.stateManager.setResizeColumnState({...e,startX:t.clientX}),this.dimensionCalculator.calculateTotalSize(),this.dimensionCalculator.calculateVisibleRange(),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.renderer.draw()}}else if(i.isResizing&&i.rowIndex!==null&&i.startY!==null){const{minRowHeight:n,maxRowHeight:s}=this.options,r=t.clientY-i.startY,o=i.rowIndex,a=this.stateManager.getRowHeight(o);let l=a+r;l=Math.max(n,Math.min(l,s)),l!==a&&(this.stateManager.setRowHeight(o,l),this.stateManager.setResizeRowState({...i,startY:t.clientY}),this.dimensionCalculator.calculateTotalSize(),this.dimensionCalculator.calculateVisibleRange(),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.renderer.draw())}}endResize(){const t=this.stateManager.getResizeColumnState(),e=this.stateManager.getResizeRowState();t.isResizing&&(p("log",this.options.verbose,`Finished column resize for index ${t.columnIndex}. New width: ${this.stateManager.getColumnWidths()[t.columnIndex]}`),this.stateManager.setResizeColumnState({isResizing:!1,columnIndex:null,startX:null})),e.isResizing&&(p("log",this.options.verbose,`Finished row resize for index ${e.rowIndex}. New height: ${this.stateManager.getRowHeight(e.rowIndex)}`),this.stateManager.setResizeRowState({isResizing:!1,rowIndex:null,startY:null}))}updateCursorStyle(t){if(this.stateManager.isResizing()||this.stateManager.isDraggingFillHandle())return;const e=this.stateManager.getScrollTop(),i=this.stateManager.getScrollLeft(),n=this.domManager.getCanvasBoundingClientRect(),s=t.clientX-n.left,r=t.clientY-n.top,o=s+i,a=r+e,{headerHeight:l,rowNumberWidth:h,resizeHandleSize:d,defaultRowHeight:g}=this.options,c=this.stateManager.getColumns(),u=this.stateManager.dataLength,w=this.stateManager.getColumnWidths(),m=this.stateManager.getRowHeights();let f="default";if(a<l&&o>h&&e<l){let S=h;for(let b=0;b<c.length;b++){const y=S+w[b];if(Math.abs(o-y)<=d){f="col-resize";break}if(S=y,S>o+d)break}}if(f==="default"&&o<h&&a>l&&i<h){let S=l;for(let b=0;b<u;b++){const y=S+(m.get(b)||g);if(Math.abs(a-y)<=d){f="row-resize";break}if(S=y,S>a+d)break}}const C=this.stateManager.getActiveCell();if(f==="default"&&C&&C.row!==null&&C.col!==null&&!this.stateManager.getActiveEditor()){const S=this.renderer.getFillHandleBounds(C.row,C.col);S&&o>=S.x&&o<=S.x+S.width&&a>=S.y&&a<=S.y+S.height&&(f="crosshair")}this.domManager.setCursor(f)}checkFillHandle(t){const e=this.stateManager.getActiveCell();if(!e||this.stateManager.getActiveEditor()||this.stateManager.isResizing()||e.row===null||e.col===null)return!1;const i=this.renderer.getFillHandleBounds(e.row,e.col);if(!i)return!1;const n=this.domManager.getCanvasBoundingClientRect(),s=t.clientX-n.left+this.stateManager.getScrollLeft(),r=t.clientY-n.top+this.stateManager.getScrollTop();return s>=i.x&&s<=i.x+i.width&&r>=i.y&&r<=i.y+i.height?(this._startFillHandleDrag(e),!0):!1}_startFillHandleDrag(t){t.row===null||t.col===null||(this.stateManager.setDragState({isDragging:!0,startCell:{...t},endRow:t.row}),this.domManager.setCursor("crosshair"),p("log",this.options.verbose,"Started dragging fill handle from",t))}handleFillHandleMouseMove(t){if(!this.stateManager.isDraggingFillHandle())return;const e=this.stateManager.getDragStartCell();if(!e||e.row===null)return;const i=this.domManager.getCanvasBoundingClientRect(),n=t.clientY-i.top+this.stateManager.getScrollTop(),{headerHeight:s,defaultRowHeight:r}=this.options,o=this.stateManager.getRowHeights(),a=this.stateManager.dataLength;let l=null,h=s;for(let g=0;g<a;g++){const c=o.get(g)||r;if(n>=h&&n<h+c){l=g;break}if(h+=c,h>n)break}let d=this.stateManager.getDragEndRow();l!==null?d=l:n<s?d=0:d=a-1,d!==this.stateManager.getDragEndRow()&&(this.stateManager.setDragState({isDragging:!0,startCell:e,endRow:d}),this.renderer.draw())}endFillHandleDrag(){if(!this.stateManager.isDraggingFillHandle())return;const t=this.stateManager.getDragEndRow();p("log",this.options.verbose,"Finished dragging fill handle to row",t),this._performFill(),this.stateManager.setDragState({isDragging:!1,startCell:null,endRow:null})}_performFill(){const t=this.stateManager.getDragState();if(!t.isDragging||!t.startCell||t.endRow===null||t.startCell.row===null)return;const e=t.startCell,i=t.endRow,n=e.row,s=e.col;if(s===null||n===null)return;const r=this.stateManager.getCellData(n,s),o=this.stateManager.getSchemaForColumn(s),a=this.stateManager.getColumnKey(s),l=o==null?void 0:o.type;let h=!1;const d=this.stateManager.dataLength,g=i>=n,c=g?n+1:i,u=g?i:n-1,w=[],m=[];for(let f=c;f<=u;f++){if(f<0||f>=d)continue;const C=this.stateManager.getSchemaForColumn(s);if(this.stateManager.isCellDisabled(f,s)){p("log",this.options.verbose,`Skipping fill for disabled cell ${f},${s}`);continue}if((C==null?void 0:C.type)!==l){p("log",this.options.verbose,`Skipping fill for row ${f}: Type mismatch (Source: ${l}, Target: ${C==null?void 0:C.type})`);continue}if(this.stateManager.getCellData(f,s)!==r){const y=this.stateManager.updateCellInternal(f,s,r);w.push(f),m.push({[a]:y}),h=!0}}h&&this.renderer.draw(),w.length>0&&this._batchUpdateCellsAndNotify(w,[a],m)}_batchUpdateCellsAndNotify(t,e,i){if(!t||t.length===0)return;const n=[];t.forEach((s,r)=>{this.stateManager.updateDisabledStatesForRow(s),n.push({rowIndex:s,columnKeys:e,data:this.stateManager.getRowData(s),oldData:i==null?void 0:i[r]})}),n.length>0&&this.stateManager.callOnCellsUpdate(n)}copy(){var n,s,r;const t=this.stateManager.getActiveCell(),e=this.stateManager.getNormalizedSelectionRange();let i=!1;if(e){const{start:o,end:a}=e,l=[];let h=!0,d;for(let g=o.row;g<=a.row;g++){const c=[];for(let u=o.col;u<=a.col;u++){const w=this.stateManager.getCellData(g,u);c.push(w);const m=(n=this.stateManager.getSchemaForColumn(u))==null?void 0:n.type;g===o.row&&u===o.col?d=m:m!==d&&(h=!1)}l.push(c)}h||p("warn",this.options.verbose,"Copied range contains mixed data types."),i=this.stateManager.setCopiedRange(l,e),p("log",this.options.verbose,`Copied range data [${l.length}x${(s=l[0])==null?void 0:s.length}] from source range [${o.row},${o.col}] -> [${a.row},${a.col}]`)}else if(t&&t.row!==null&&t.col!==null){const{row:o,col:a}=t,l=this.stateManager.getCellData(o,a),h=(r=this.stateManager.getSchemaForColumn(a))==null?void 0:r.type;i=this.stateManager.setCopiedValue(l,h,{...t}),i&&p("log",this.options.verbose,`Copied value: ${l} (Type: ${h}) from cell ${o},${a}`)}return i}paste(){if(this.lastPasteHandledAt&&Date.now()-this.lastPasteHandledAt.getTime()<1e3)return!1;this.lastPasteHandledAt=new Date,p("log",this.options.verbose,"Paste requested by keyboard shortcut");const t=this.stateManager.getActiveCell(),e=this.stateManager.getNormalizedSelectionRange(),i=this.stateManager.getCopiedValue(),n=this.stateManager.getCopiedValueType(),s=this.stateManager.getCopiedRangeData(),r=e,o=!r&&t?t:null;return!r&&!o?(p("log",this.options.verbose,"Paste ignored: No target cell or range selected."),!1):s?(p("log",this.options.verbose,"Pasting range data"),r?this._pasteRangeToRange(r,s):o&&o.row!==null&&o.col!==null?this._pasteRangeFromTopLeft(o,s):!1):i!==void 0?(p("log",this.options.verbose,"Pasting single value"),r?this._pasteSingleValueToRange(r,i,n):o&&o.row!==null&&o.col!==null?this._pasteSingleValue(o,i,n):!1):(p("log",this.options.verbose,"Nothing to paste."),!1)}_pasteSingleValue(t,e,i){if(t.row===null||t.col===null)return!1;const n=t.row,s=t.col,r=this.stateManager.getColumnKey(s),o=this.stateManager.getSchemaForColumn(s);if(this.stateManager.isCellDisabled(n,s))return p("log",this.options.verbose,`Paste cancelled: Target cell ${n},${s} is disabled.`),!1;if((o==null?void 0:o.type)!==i&&e!==null){p("log",this.options.verbose,`Type mismatch (Copied: ${i}, Target: ${o==null?void 0:o.type}) - attempting conversion.`);const h=this._convertValueForTargetType(e,r,o);if(h===null)return p("log",this.options.verbose,"Paste cancelled: Cannot convert value between types."),!1;e=h}const a=this.stateManager.getCellData(n,s),l=z(e,o,r,this.stateManager.cachedDropdownOptionsByColumn.get(r),this.options.verbose);if("error"in l)return p("log",this.options.verbose,l.error),l.errorType==="required"&&!a?this.stateManager.updateCell(n,`error:${r}`,l.error):this.renderer.setTemporaryErrors([{row:n,col:s,error:l.error}]),!0;if(this.stateManager.removeCellValue(n,`error:${r}`),a!==e){const h=this.stateManager.updateCellInternal(n,s,e);return this._batchUpdateCellsAndNotify([n],[r],[{[r]:h}]),p("log",this.options.verbose,`Pasted value ${e} to cell ${n},${s}`),!0}return!1}_pasteSingleValueToRange(t,e,i){let n=!1;const s=[],r=[],o=new Map;for(let a=t.start.row;a<=t.end.row;a++)for(let l=t.start.col;l<=t.end.col;l++){const h=this.stateManager.getColumnKey(l),d=this.stateManager.getSchemaForColumn(l);if(this.stateManager.isCellDisabled(a,l))continue;let g=e;if((d==null?void 0:d.type)!==i&&e!==null&&(g=this._convertValueForTargetType(e,h,d),g===null))continue;const c=this.stateManager.getCellData(a,l),u=z(g,d,h,this.stateManager.cachedDropdownOptionsByColumn.get(h),this.options.verbose);if("error"in u){p("warn",this.options.verbose,u.error),u.errorType==="required"&&!c?this.stateManager.updateCell(a,`error:${h}`,u.error):this.renderer.setTemporaryErrors([{row:a,col:l,error:u.error}]),n=!0;continue}else this.stateManager.removeCellValue(a,`error:${h}`);if(c!==g){const w=this.stateManager.updateCellInternal(a,l,g);s.push(a),r.push(h),o.set(a,{...o.get(a),[h]:w}),n=!0}}return s.length>0&&this._batchUpdateCellsAndNotify(s,r,s.map(a=>o.get(a))),n&&p("log",this.options.verbose,`Pasted single value to range [${t.start.row},${t.start.col}] -> [${t.end.row},${t.end.col}]`),n}_convertValueForTargetType(t,e,i){const n=i==null?void 0:i.type;if(t==null||n===void 0)return null;if(n==="text"||n==="email")return String(t);const s=String(t).trim();if(s==="")return null;switch(n){case"number":const r=parseFloat(s);return isNaN(r)?null:r;case"boolean":if(typeof t=="boolean")return t;const o=s.toLowerCase();return["true","yes","1","y"].includes(o)?!0:["false","no","0","n"].includes(o)?!1:null;case"date":if(t instanceof Date)return t.toISOString().split("T")[0];try{const h=new Date(t);if(!isNaN(h.getTime()))return h.toISOString().split("T")[0]}catch{}return null;case"select":const a=this.stateManager.cachedDropdownOptionsByColumn.get(e);if(!a)return null;if(a.has(t))return t;if(typeof t!="string"&&a.has(s))return s;const l=Array.from(a.entries()).find(([h,d])=>d.toLowerCase()===s.toLowerCase());return l?l[0]:null;default:return null}}_pasteRangeFromTopLeft(t,e){var c;if(t.row===null||t.col===null||!e||e.length===0)return!1;const i=t.row,n=t.col,s=e.length,r=((c=e[0])==null?void 0:c.length)||0;let o=!1;const a=this.stateManager.dataLength,l=this.stateManager.getColumns().length,h=[],d=new Set,g=new Map;for(let u=0;u<s;u++){const w=i+u;if(w>=a)break;const m=e[u];let f=!1;for(let C=0;C<r;C++){const S=n+C;if(S>=l)break;const b=m[C],y=this.stateManager.getColumnKey(S),R=this.stateManager.getSchemaForColumn(S);if(this.stateManager.isCellDisabled(w,S))continue;let v=b;if(v!==null&&(v=this._convertValueForTargetType(b,y,R),v===null))continue;const N=this.stateManager.getCellData(w,S),$=z(v,R,y,this.stateManager.cachedDropdownOptionsByColumn.get(y),this.options.verbose);if("error"in $){p("warn",this.options.verbose,$.error),$.errorType==="required"&&!N?this.stateManager.updateCell(w,`error:${y}`,$.error):this.renderer.setTemporaryErrors([{row:w,col:S,error:$.error}]),o=!0;continue}else this.stateManager.removeCellValue(w,`error:${y}`);if(N!==v){const E=this.stateManager.updateCellInternal(w,S,v);f=!0,d.add(y),g.set(w,{...g.get(w),[y]:E})}}f&&(h.push(w),o=!0)}return h.length>0&&(this._batchUpdateCellsAndNotify(h,Array.from(d),h.map(u=>g.get(u))),p("log",this.options.verbose,`Pasted range [${s}x${r}] starting at ${i},${n}`)),o}_pasteRangeToRange(t,e){var l;if(!e||e.length===0)return!1;const i=e.length,n=((l=e[0])==null?void 0:l.length)||0;if(n===0)return!1;let s=!1;const r=[],o=new Set,a=new Map;for(let h=t.start.row;h<=t.end.row;h++){let d=!1;for(let g=t.start.col;g<=t.end.col;g++){const c=(h-t.start.row)%i,u=(g-t.start.col)%n,w=e[c][u],m=this.stateManager.getColumnKey(g),f=this.stateManager.getSchemaForColumn(g);if(this.stateManager.isCellDisabled(h,g))continue;let C=w;if(C!==null&&(C=this._convertValueForTargetType(w,m,f),C===null))continue;const S=this.stateManager.getCellData(h,g),b=z(C,f,m,this.stateManager.cachedDropdownOptionsByColumn.get(m),this.options.verbose);if("error"in b){p("warn",this.options.verbose,b.error),b.errorType==="required"&&!S?this.stateManager.updateCell(h,`error:${m}`,b.error):this.renderer.setTemporaryErrors([{row:h,col:g,error:b.error}]),s=!0;continue}else this.stateManager.removeCellValue(h,`error:${m}`);if(S!==C){const y=this.stateManager.updateCellInternal(h,g,C);d=!0,o.add(m),a.set(h,{...a.get(h),[m]:y})}}d&&(r.push(h),s=!0)}return r.length>0&&(this._batchUpdateCellsAndNotify(r,Array.from(o),r.map(h=>a.get(h))),p("log",this.options.verbose,`Pasted range pattern into target range [${t.start.row},${t.start.col}] -> [${t.end.row},${t.end.col}]`)),s}clearCopiedCell(){return this.stateManager.clearCopyState()}deleteSelectedRows(){var s,r;const t=this.stateManager.getSelectedRows();if(t.size===0)return!1;const e=Array.from(t);p("log",this.options.verbose,"Deleting rows:",e);const i=e.map(o=>this.stateManager.getRowData(o)).filter(o=>o);let n=this.stateManager.deleteRows(e);try{(r=(s=this.options).onRowDeleted)==null||r.call(s,i)}catch(o){p("error",this.options.verbose,`Error calling onRowDeleted: ${o}`)}return n>0?(this.clearSelections(),this.stateManager.setActiveCell(null),this.clearCopiedCell(),this.triggerCustomEvent("resize"),!0):!1}startSelectionDrag(t){if(t.row===null||t.col===null)return!1;let e=!1;this.stateManager.setDraggingSelection(!0);const i=this.stateManager.setActiveCell(t),n=this.stateManager.setSelectionRange(t,t);e=i||n;let s=!1;return e&&(s=this.clearSelections()),e||s?(p("log",this.options.verbose,`Started selection drag at ${t.row},${t.col}`),!0):!1}updateSelectionDrag(t){if(!this.stateManager.getIsDraggingSelection()||!this.stateManager.getSelectionStartCell()||t.row===null||t.col===null)return!1;const e=this.stateManager.getSelectionEndCell();return(e==null?void 0:e.row)!==t.row||(e==null?void 0:e.col)!==t.col?(p("log",this.options.verbose,`Updating selection drag to ${t.row},${t.col}`),this.stateManager.setSelectionRange(this.stateManager.getSelectionStartCell(),t)):!1}endSelectionDrag(){this.stateManager.getIsDraggingSelection()&&(p("log",this.options.verbose,`Ended selection drag. Final range: ${JSON.stringify(this.stateManager.getNormalizedSelectionRange())}`),this.stateManager.setDraggingSelection(!1))}moveActiveCell(t,e,i=!0){const{verbose:n,autoAddNewRow:s}=this.options;if(!this.editingManager)return p("warn",n,"EditingManager not set, cannot move active cell."),!1;const r=s&&i,o=this.stateManager.getActiveCell();if(!o||o.row===null||o.col===null)return!1;let a=o.row,l=o.col,h=this.stateManager.dataLength;const d=this.stateManager.getColumns().length;let g=a+t,c=l+e;if(c>=d?(c=0,g++):c<0&&(c=d-1,g--),g<0||g>=h&&!r)return this.editingManager.deactivateEditor(!0),this.stateManager.setActiveCell(null),p("log",n,"Reached grid boundary, deactivating editor."),!0;g===h&&r&&(g=this.stateManager.addRow(),this.triggerCustomEvent("resize"),h++);let u=g*d+c;const w=h*d;for(;this.stateManager.isCellDisabled(g,c)&&u<w;)if(u++,g+=t,c+=e,c>=d?(c=0,g++):c<0&&(c=d-1,g--),g<0||g>=h)return this.editingManager.deactivateEditor(!0),this.stateManager.setActiveCell(null),p("warn",n,"Could not find next editable cell in direction."),!0;if(u>=w)return p("warn",n,"Max search limit reached while finding next editable cell."),this.editingManager.deactivateEditor(!0),this.stateManager.setActiveCell(null),!0;if(this.stateManager.setActiveCell({row:g,col:c}),i)this.editingManager.activateEditor(g,c);else{const m=this.renderer.getCellBounds(g,c);m&&this.bringBoundsIntoView(m)}return!0}pasteSingleValueExternal(t,e){if(t.row===null||t.col===null)return!1;const i=this.stateManager.getSchemaForColumn(t.col);return(i==null?void 0:i.type)!=="text"?(p("log",this.options.verbose,`Clipboard paste cancelled: Target cell ${t.row},${t.col} is not type 'text'.`),!1):this._pasteSingleValue(t,e,"text")}pasteRangeFromTopLeftExternal(t,e){var g;if(t.row===null||t.col===null||!e||e.length===0)return!1;const i=t.row,n=t.col,s=e.length,r=((g=e[0])==null?void 0:g.length)||0;let o=!1;const a=this.stateManager.dataLength,l=this.stateManager.getColumns().length,h=[],d=new Set;for(let c=0;c<s;c++){const u=i+c;if(u>=a)break;const w=e[c];let m=!1;for(let f=0;f<r;f++){const C=n+f;if(C>=l)break;const S=w[f],b=this.stateManager.getColumnKey(C),y=this.stateManager.getSchemaForColumn(C);if(this.stateManager.isCellDisabled(u,C))continue;if((y==null?void 0:y.type)!=="text"){p("log",this.options.verbose,`Clipboard paste range: Target cell ${u},${C} is not type 'text'. Skipping.`);continue}const R=this.stateManager.getCellData(u,C),v=z(S,y,b,this.stateManager.cachedDropdownOptionsByColumn.get(b),this.options.verbose);if("error"in v){p("warn",this.options.verbose,v.error),v.errorType==="required"&&!R?this.stateManager.updateCell(u,`error:${b}`,v.error):this.renderer.setTemporaryErrors([{row:u,col:C,error:v.error}]),o=!0;continue}else this.stateManager.removeCellValue(u,`error:${b}`);R!==S&&(this.stateManager.updateCellInternal(u,C,S),m=!0,d.add(b))}m&&(h.push(u),o=!0)}return h.length>0&&(this._batchUpdateCellsAndNotify(h,Array.from(d)),p("log",this.options.verbose,`Pasted external range [${s}x${r}] starting at ${i},${n}`)),o}pasteRangeToRangeExternal(t,e){var a;if(!e||e.length===0)return!1;const i=e.length,n=((a=e[0])==null?void 0:a.length)||0;if(n===0)return!1;let s=!1;const r=[],o=new Set;for(let l=t.start.row;l<=t.end.row;l++){let h=!1;for(let d=t.start.col;d<=t.end.col;d++){const g=(l-t.start.row)%i,c=(d-t.start.col)%n,u=e[g][c],w=this.stateManager.getColumnKey(d),m=this.stateManager.getSchemaForColumn(d);if(this.stateManager.isCellDisabled(l,d))continue;const f=this._convertValueForTargetType(u,w,m);if(f===null)continue;const C=this.stateManager.getCellData(l,d),S=z(f,m,w,this.stateManager.cachedDropdownOptionsByColumn.get(w),this.options.verbose);if("error"in S){p("warn",this.options.verbose,S.error),S.errorType==="required"&&!C?this.stateManager.updateCell(l,`error:${w}`,S.error):this.renderer.setTemporaryErrors([{row:l,col:d,error:S.error}]),s=!0;continue}else this.stateManager.removeCellValue(l,`error:${w}`);C!==f&&(this.stateManager.updateCellInternal(l,d,f),h=!0,o.add(w))}h&&(r.push(l),s=!0)}return r.length>0&&(this._batchUpdateCellsAndNotify(r,Array.from(o)),p("log",this.options.verbose,`Pasted external range pattern into target range [${t.start.row},${t.start.col}] -> [${t.end.row},${t.end.col}]`)),s}pasteToColumnExternal(t,e){p("log",this.options.verbose,`External paste to entire column ${t}`);const i=this.stateManager.getSchemaForColumn(t),n=this.stateManager.dataLength;let s=!1;if(e==null)return p("log",this.options.verbose,"No value to paste to column"),!1;const r=this.stateManager.getColumnKey(t),o=this._convertValueForTargetType(e,r,i),a=[];for(let l=0;l<n;l++){if(this.stateManager.isCellDisabled(l,t))continue;this.stateManager.getCellData(l,t)!==o&&(this.stateManager.updateCellInternal(l,t,o),s=!0,a.push(l))}return s&&(this._batchUpdateCellsAndNotify(a,[r]),this.renderer.draw()),s}}class Dt{constructor(t,e,i){this.columnWidths=[],this.rowHeights=new Map,this.scrollTop=0,this.scrollLeft=0,this.viewportWidth=0,this.viewportHeight=0,this.totalContentWidth=0,this.totalContentHeight=0,this.visibleRowStartIndex=0,this.visibleRowEndIndex=0,this.visibleColStartIndex=0,this.visibleColEndIndex=0,this.activeCell=null,this.selectionStartCell=null,this.selectionEndCell=null,this.isDraggingSelection=!1,this.activeEditor=null,this.selectedRows=new Set,this.lastClickedRow=null,this.selectedColumn=null,this.copiedValue=void 0,this.copiedValueType=void 0,this.copiedCell=null,this.copiedRangeData=null,this.copiedSourceRange=null,this.dragState={isDragging:!1,startCell:null,endRow:null},this.resizeColumnState={isResizing:!1,columnIndex:null,startX:null},this.resizeRowState={isResizing:!1,rowIndex:null,startY:null},this.cachedDropdownOptionsByColumn=new Map,this.schema=t,this.columns=Object.keys(t),this.data=[],this.options=i,this._addCachedDropdownOptions()}addCachedDropdownOptionForColumn(t,e){const i=this.schema[t],n=e||i.values;if(i.type!=="select"||!n)return;const s=new Map(n.map(o=>[o.id,o.name]));let r=this.cachedDropdownOptionsByColumn.get(t);r!=null&&r.size?r=new Map([...r,...s]):r=s,this.cachedDropdownOptionsByColumn.set(t,r)}_addCachedDropdownOptions(){const t=Object.keys(this.schema).filter(e=>this.schema[e].type==="select");if(t.length)for(const e of t)this.addCachedDropdownOptionForColumn(e)}setInitialData(t){this.data=JSON.parse(JSON.stringify(t||[])),this._updateAllDisabledStates()}get dataLength(){return this.data.length}getData(){return JSON.parse(JSON.stringify(this.data,(t,e)=>{if(!(typeof t=="string"&&t.startsWith(Q)))return e}))}setData(t){this.data=JSON.parse(JSON.stringify(t||[])),this._updateAllDisabledStates(),this.resetInteractionState()}updateColumnSchema(t,e){this.schema[t]={...this.schema[t],...e},e.values&&this.addCachedDropdownOptionForColumn(t,e.values),this._updateAllDisabledStates(),this.resetInteractionState()}clearAllSelections(){this.activeCell=null,this.selectionStartCell=null,this.selectionEndCell=null,this.isDraggingSelection=!1,this.selectedRows=new Set,this.selectedColumn=null,this.lastClickedRow=null,this.copiedValue=void 0,this.copiedValueType=void 0,this.copiedCell=null}updateCellInternal(t,e,i){if(t<0||t>=this.data.length||e<0||e>=this.columns.length){p("warn",this.options.verbose,`updateCellInternal: Invalid coordinates (${t}, ${e})`);return}const n=this.columns[e];this.data[t]||(this.data[t]={});const s=this.data[t][n];return this.data[t][n]=i,s}updateCell(t,e,i,n=!1){if(t<0||t>=this.data.length)return p("warn",this.options.verbose,`updateCell: Invalid row index (${t}).`),!1;if(e.includes(":"))return this.data[t][e]=i,!0;if(this.columns.indexOf(e)<0)return p("warn",this.options.verbose,`updateCell: Invalid column key (${e}).`),!1;const r=this.schema[e],o=z(i,r,e,this.cachedDropdownOptionsByColumn.get(e),this.options.verbose);if("error"in o){if(p("warn",this.options.verbose,`updateCell: Validation failed for ${e}. Value not set.`),n)throw new tt({errorMessage:o.error,rowIndex:t,colKey:e,value:i,schema:r,errorType:o.errorType})}else if(this.data[t]||(this.data[t]={}),e.includes(":")||this.removeCellValue(t,`error:${e}`),this.data[t][e]!==i)return this.data[t][e]=i,this.updateDisabledStatesForRow(t),!0;return!1}removeCellValue(t,e){var n;if(t<0||t>=this.data.length)return p("warn",this.options.verbose,`removeCellValue: Invalid coordinates (${t}, ${e}).`),!1;const i=(n=this.data[t])==null?void 0:n[e];return delete this.data[t][e],!!i}getCellData(t,e){var n;if(t<0||t>=this.data.length||e<0||e>=this.columns.length)return;const i=this.columns[e];return(n=this.data[t])==null?void 0:n[i]}getRowData(t){return this.data[t]}deleteRows(t){let e=0;return t.sort((n,s)=>s-n).forEach(n=>{n>=0&&n<this.data.length&&(this.data.splice(n,1),this.rowHeights.delete(n),e++)}),e>0&&this._updateAllDisabledStates(),e}getSchema(){return this.schema}getColumns(){return this.columns}getColumnKey(t){return this.columns[t]}getSchemaForColumn(t){const e=this.columns[t];return e?this.schema[e]:void 0}getColumnWidths(){return this.columnWidths}setColumnWidths(t){this.columnWidths=t}getRowHeights(){return this.rowHeights}getTotalRowHeight(){let t=this.data.length*this.options.defaultRowHeight;return this.rowHeights.forEach(e=>{t+=e-this.options.defaultRowHeight}),t}getRowHeight(t){return this.rowHeights.get(t)||this.options.defaultRowHeight}setRowHeight(t,e){e===this.options.defaultRowHeight?this.rowHeights.delete(t):this.rowHeights.set(t,e)}getTotalContentWidth(){return this.totalContentWidth}getTotalContentHeight(){return this.totalContentHeight}updateViewportSize(t,e){this.viewportWidth=t,this.viewportHeight=e}getViewportWidth(){return this.viewportWidth}getViewportHeight(){return this.viewportHeight}updateTotalContentSize(t,e){this.totalContentWidth=t,this.totalContentHeight=e}updateScroll(t,e){this.scrollTop=t,this.scrollLeft=e}getScrollTop(){return this.scrollTop}getScrollLeft(){return this.scrollLeft}updateVisibleRange(t,e,i,n){this.visibleRowStartIndex=t,this.visibleRowEndIndex=e,this.visibleColStartIndex=i,this.visibleColEndIndex=n}getVisibleRowStartIndex(){return this.visibleRowStartIndex}getVisibleRowEndIndex(){return this.visibleRowEndIndex}getVisibleColStartIndex(){return this.visibleColStartIndex}getVisibleColEndIndex(){return this.visibleColEndIndex}getActiveCell(){return this.activeCell}setActiveCell(t){const e=JSON.stringify(this.activeCell)!==JSON.stringify(t);return e&&(this.activeCell=t),this.options.onCellSelected&&(t!=null&&t.col)&&(t!=null&&t.row)&&setTimeout(()=>{try{this.options.onCellSelected({rowIndex:t==null?void 0:t.row,colKey:this.getColumnKey(t==null?void 0:t.col),rowData:this.data[t==null?void 0:t.row]})}catch{}},0),e}getActiveEditor(){return this.activeEditor}setActiveEditor(t){this.activeEditor=t}getSelectedRows(){return this.selectedRows}setSelectedRows(t,e){const i=JSON.stringify(Array.from(this.selectedRows).sort((a,l)=>a-l)),n=JSON.stringify(Array.from(t).sort((a,l)=>a-l)),s=i!==n,r=this.lastClickedRow!==e,o=s||r;return o&&(this.selectedRows=new Set(t),this.lastClickedRow=e),o}getLastClickedRow(){return this.lastClickedRow}getSelectedColumn(){return this.selectedColumn}setSelectedColumn(t){const e=this.selectedColumn!==t;return e&&(this.selectedColumn=t),e}getCopiedValue(){return this.copiedValue}getCopiedValueType(){return this.copiedValueType}getCopiedCell(){return this.copiedCell}setCopiedValue(t,e,i){const n=JSON.stringify(this.copiedCell)!==JSON.stringify(i),s=this.copiedRangeData!==null,r=this.copiedSourceRange!==null;return this.copiedValue=t,this.copiedValueType=e,this.copiedCell=i,this.copiedRangeData=null,this.copiedSourceRange=null,n||s||r}setCopiedRange(t,e){const i=JSON.stringify(this.copiedRangeData)!==JSON.stringify(t),n=JSON.stringify(this.copiedSourceRange)!==JSON.stringify(e),s=this.copiedCell!==null;return this.copiedRangeData=t,this.copiedSourceRange=e,this.copiedValue=void 0,this.copiedValueType=void 0,this.copiedCell=null,i||n||s}getCopiedRangeData(){return this.copiedRangeData}getCopiedSourceRange(){return this.copiedSourceRange}isCopyActive(){return this.copiedCell!==null||this.copiedRangeData!==null}clearCopyState(){return this.setCopiedValue(void 0,void 0,null)}getDragState(){return this.dragState}setDragState(t){this.dragState=t}isDraggingFillHandle(){return this.dragState.isDragging}getDragStartCell(){return this.dragState.startCell}getDragEndRow(){return this.dragState.endRow}getResizeColumnState(){return this.resizeColumnState}setResizeColumnState(t){this.resizeColumnState=t}getResizeRowState(){return this.resizeRowState}setResizeRowState(t){this.resizeRowState=t}isResizing(){return this.resizeColumnState.isResizing||this.resizeRowState.isResizing}resetInteractionState(){this.activeCell=null,this.selectionStartCell=null,this.selectionEndCell=null,this.isDraggingSelection=!1,this.activeEditor=null,this.selectedRows=new Set,this.selectedColumn=null,this.lastClickedRow=null,this.copiedValue=void 0,this.copiedValueType=void 0,this.copiedCell=null,this.copiedRangeData=null,this.copiedSourceRange=null,this.dragState={isDragging:!1,startCell:null,endRow:null},this.resizeColumnState={isResizing:!1,columnIndex:null,startX:null},this.resizeRowState={isResizing:!1,rowIndex:null,startY:null}}isCellDisabled(t,e){if(t<0||t>=this.data.length||e<0||e>=this.columns.length)return!0;const i=this.columns[e],n=this.data[t];return!!(n!=null&&n[`${Q}${i}`])}updateDisabledStatesForRow(t){if(t<0||t>=this.data.length)return!1;const e=this.data[t];if(!e)return!1;let i=!1;return this.columns.forEach(n=>{const s=`${Q}${n}`,r=!!e[s],o=this.schema[n],a=o!=null&&o.disabled?o.disabled(e,t):!1;r!==a&&(e[s]=a,i=!0)}),i}callOnCellsUpdate(t){var e,i;(i=(e=this.options).onCellsUpdate)==null||i.call(e,t)}_updateAllDisabledStates(){p("log",this.options.verbose,"Updating all disabled states...");for(let t=0;t<this.data.length;t++)this.updateDisabledStatesForRow(t);p("log",this.options.verbose,"Finished updating all disabled states.")}getSelectionStartCell(){return this.selectionStartCell}getSelectionEndCell(){return this.selectionEndCell}setSelectionRange(t,e){const i=JSON.stringify(this.selectionStartCell)!==JSON.stringify(t),n=JSON.stringify(this.selectionEndCell)!==JSON.stringify(e),s=i||n;return s&&(this.selectionStartCell=t,this.selectionEndCell=e),s}clearSelectionRange(){return this.setSelectionRange(null,null)}getNormalizedSelectionRange(){if(!this.selectionStartCell||!this.selectionEndCell||this.selectionStartCell.row===null||this.selectionStartCell.col===null||this.selectionEndCell.row===null||this.selectionEndCell.col===null)return null;const t=Math.min(this.selectionStartCell.row,this.selectionEndCell.row),e=Math.min(this.selectionStartCell.col,this.selectionEndCell.col),i=Math.max(this.selectionStartCell.row,this.selectionEndCell.row),n=Math.max(this.selectionStartCell.col,this.selectionEndCell.col);return{start:{row:t,col:e},end:{row:i,col:n}}}isMultiCellSelectionActive(){return!!this.selectionStartCell&&!!this.selectionEndCell}setDraggingSelection(t){this.isDraggingSelection=t}getIsDraggingSelection(){return this.isDraggingSelection}addRow(){const t={};this.columns.forEach(i=>{if(i.includes(Q))return;const n=this.schema[i];let s=null;if(n)switch(n.type){case"text":case"email":s="";break;case"number":s=0;break;case"boolean":s=!1;break;default:s=null}t[i]=s}),this.data.push(t);const e=this.data.length-1;return this.updateDisabledStatesForRow(e),e}addColumn(t,e){if(this.schema[t])throw new Error(`Column ${t} already exists`);const i=this.columns.length;return this.columns.push(t),this.columnWidths.push(this.options.defaultColumnWidth),this.schema[t]=e,this.addCachedDropdownOptionForColumn(t),i}removeColumn(t){const e=this.columns[t];this.clearAllSelections(),delete this.schema[e],this.columns.splice(t,1),this.columnWidths.splice(t,1),this.data.forEach(i=>{delete i[e]}),this.cachedDropdownOptionsByColumn.delete(e)}}class Tt{constructor(t,e,i=[],n={}){const s=document.getElementById(t);if(!s)throw new Error(`Container element with ID "${t}" not found.`);this.container=s,this.options={...pt,...n},this.stateManager=new Dt(e,i,this.options),this.domManager=new wt(this.container),this.dimensionCalculator=new bt(this.options,this.stateManager,this.domManager),this.renderer=new yt(this.domManager.getContext(),this.options,this.stateManager,this.dimensionCalculator),this.interactionManager=new xt(this.options,this.stateManager,this.renderer,this.dimensionCalculator,this.domManager),this.interactionManager.bindCustomEvents(r=>{r.type==="resize"&&this.onDataUpdate()}),this.editingManager=new Rt(this.container,this.options,this.stateManager,this.domManager,this.renderer,this.interactionManager),this.eventManager=new vt(this.container,this.editingManager,this.interactionManager,this.stateManager,this.dimensionCalculator,this.renderer,this.options,this.domManager),this.stateManager.setInitialData(i),this.dimensionCalculator.initializeSizes(i.length),this.domManager.setup(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.dimensionCalculator.calculateDimensions(this.container.clientWidth,this.container.clientHeight),this.eventManager.bindEvents(),this.draw(),p("log",this.options.verbose,"Spreadsheet initialized")}draw(){this.stateManager.updateScroll(this.domManager.getVScrollPosition(),this.domManager.getHScrollPosition()),this.dimensionCalculator.calculateVisibleRange(),this.renderer.draw()}onDataUpdate(t=0,e=0){this.dimensionCalculator.initializeSizes(this.stateManager.dataLength),this.domManager.updateCanvasSize(this.stateManager.getTotalContentWidth(),this.stateManager.getTotalContentHeight()),this.dimensionCalculator.calculateDimensions(this.container.clientWidth,this.container.clientHeight),this.interactionManager.moveScroll(e,t,!0),this.draw()}async getData(t){let e=[];{const o=this.stateManager.getData();if(t!=null&&t.raw)return Promise.resolve(o);e=St(o,1e3)}let i=[];const n=this.stateManager.getSchema(),s=new Set(this.stateManager.getColumns()),r=o=>new Promise(a=>{var l;if(o>=e.length)return a(!1);for(const h of e[o]){let d=!1;for(const g of Object.keys(h)){if(g.startsWith("error:")||(l=n[g])!=null&&l.required&&(h[g]??"")===""){d=!0;break}if(!s.has(g)){if(t!=null&&t.visibleColumnsOnly&&!s.has(g)){delete h[g];continue}g.includes(":")&&delete h[g]}}d||i.push(h)}if(o===e.length-1)return a(!0);setTimeout(()=>{a(r(o+1))},0)});return await r(0),i}get rowCount(){return this.stateManager.dataLength}setData(t){this.stateManager.setData(t),this.onDataUpdate()}updateColumnSchema(t,e){this.stateManager.updateColumnSchema(t,e),this.onDataUpdate()}addRow(){const t=this.stateManager.addRow();return this.onDataUpdate(this.container.scrollHeight,0),t}addColumn(t,e){const i=this.stateManager.addColumn(t,e);return this.onDataUpdate(0,this.container.scrollWidth),i}removeColumnByIndex(t){const e=this.stateManager.getColumns();if(t<0||t>=e.length)throw new Error(`Column index ${t} is out of bounds`);this.stateManager.removeColumn(t),this.onDataUpdate(0,this.container.scrollWidth)}removeColumnByKey(t){const e=this.stateManager.getColumns().indexOf(t);if(e<0)throw new Error(`Column key ${t} not found`);this.removeColumnByIndex(e)}updateCell({rowIndex:t,colKey:e,value:i,flashError:n}){let s=!1;try{if(!this.stateManager.updateCell(t,e,i,!0))return;s=!0}catch(o){o instanceof tt?(this.stateManager.updateCell(t,`error:${e}`,o.message),s=!0):p("warn",this.options.verbose,o)}const r=this.stateManager.getColumns().indexOf(e);n&&r>=0&&this.renderer.setTemporaryErrors([{row:t,col:r,error:n}]),s&&this.draw()}updateCells(t){let e=!1;const i=new Set,n=[],s=this.stateManager.getColumns();for(const{rowIndex:r,colKey:o,value:a,flashError:l}of t){const h=s.indexOf(o);try{if(!this.stateManager.updateCell(r,o,a,!0))continue;i.add(r),e=!0,l&&h>=0&&n.push({row:r,col:h,error:l})}catch(d){d instanceof tt?(this.stateManager.updateCell(r,`error:${o}`,d.message),e=!0):p("warn",this.options.verbose,d)}}return n.length&&this.renderer.setTemporaryErrors(n),e&&this.draw(),Array.from(i)}getSelectedCell(){const t=this.stateManager.getActiveCell();return!t||!t.row||!t.col?null:{row:t.row,colKey:this.stateManager.getColumnKey(t.col)}}getRow(t){const e=this.stateManager.getRowData(t);return e?JSON.parse(JSON.stringify(e)):null}focus(){this.domManager.focusContainer()}setValueFromCustomEditor({rowIndex:t,colKey:e,value:i}){this.focus(),this.editingManager.isEditorActive()&&this.editingManager.deactivateEditor(!1,!0),this.updateCell({rowIndex:t,colKey:e,value:i})}redraw(){this.draw()}}export{Tt as S};
